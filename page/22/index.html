<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Ropon运维</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Ropon运维,Ropon,Go,DevOps,k8s,CI&#x2F;CD,Prometheus,Shell,Python">
<meta property="og:type" content="website">
<meta property="og:title" content="Ropon运维">
<meta property="og:url" content="https://blog.ropon.top/page/22/index.html">
<meta property="og:site_name" content="Ropon运维">
<meta property="og:description" content="Ropon运维,Ropon,Go,DevOps,k8s,CI&#x2F;CD,Prometheus,Shell,Python">
<meta property="og:locale">
<meta property="article:author" content="Ropon">
<meta property="article:tag" content="Ropon运维,Ropon,Go,DevOps,CI&#x2F;CD,运维平台,k8s,Prometheus,Shell,Python,Kvm,OpenStack">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Ropon运维" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Ropon运维</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.ropon.top"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-详解nginx" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/11/22/%E8%AF%A6%E8%A7%A3nginx/" class="article-date">
  <time class="dt-published" datetime="2017-11-22T14:51:31.000Z" itemprop="datePublished">2017-11-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web-jiqun/">web-jiqun</a>►<a class="article-category-link" href="/categories/web-jiqun/%E7%BD%91%E7%AB%99%E9%9B%86%E7%BE%A4/">网站集群</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/11/22/%E8%AF%A6%E8%A7%A3nginx/">详解nginx</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line">1、检查nginx基本依赖包是否安装pcre-devel openssl-devel</span><br><span class="line">rpm -qa pcre-devel pcre</span><br><span class="line">rpm -qa openssl-devel openssl</span><br><span class="line">若没有执行以下命令安装</span><br><span class="line">yum -y install pcre-devel pcre</span><br><span class="line">yum -y install openssl-devel openssl</span><br><span class="line">yum -y install gcc-c++</span><br><span class="line">2、安装nginx</span><br><span class="line">[ ! -d /home/ropon/tools ] &amp;&amp; <span class="built_in">mkdir</span> -p /home/ropon/tools</span><br><span class="line"><span class="built_in">cd</span> /home/ropon/tools</span><br><span class="line"><span class="built_in">id</span> -u www &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">[ $? -ne 0 ] &amp;&amp; useradd www -s /sbin/nologin -M -g www <span class="comment">#创建普通用户www及www组不指定家目录</span></span><br><span class="line">wget -c http://nginx.org/download/nginx-1.10.3.tar.gz</span><br><span class="line">tar xvf nginx-1.10.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.10.3</span><br><span class="line">./configure --user=www --group=www --prefix=/usr/local/nginx-1.10.3/ \</span><br><span class="line">--with-http_stub_status_module --with-http_ssl_module</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/nginx-1.10.3 /usr/local/nginx 便于后期升级nginx版本，及快速获取nginx版本号</span><br><span class="line">--prefix=设置安装路径</span><br><span class="line">--user=进程用户权限</span><br><span class="line">--group=进程用户组权限</span><br><span class="line">--with-http_stub_status_module 激活状态信息</span><br><span class="line">--with-http_ssl_module 激活ssl功能</span><br><span class="line">3、nginx.conf配置文件说明</span><br><span class="line">worker_processes 4; <span class="comment">#worker进程数量</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 10240; <span class="comment">#每个worker进程支持的最大连接数</span></span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include mime.types; <span class="comment">#nginx支持的媒体类型库文件</span></span><br><span class="line">    default_type application/octet-stream; <span class="comment">#默认的媒体类型</span></span><br><span class="line">    sendfile on; <span class="comment">#开启高效传输模式</span></span><br><span class="line">    keepalive_timeout 65; <span class="comment">#链接超时时间</span></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root html;</span><br><span class="line">            index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root html;</span><br><span class="line">        &#125;</span><br><span class="line">        location /ropon_ngx_status &#123;</span><br><span class="line">            stub_status on; <span class="comment">#开启nginx status</span></span><br><span class="line">            access_log off;</span><br><span class="line">            allow 1.1.1.1; <span class="comment">#仅允许某个IP查看</span></span><br><span class="line">            deny all;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Active connections: 4 <span class="comment">#正在处理的活动连接数</span></span><br><span class="line">server accepts handled requests</span><br><span class="line">209 209 34 启动共处理多少连接；启动共创建多少次握手（请求丢失数（握手数-连接数））； 共处理多少次请求</span><br><span class="line">Reading: 0读取客户端header信息数 Writing: 1返回客户端header信息数 Waiting: 3等待下次请求驻留连接</span><br><span class="line">error_log logs/error.log warnerrorcrit; <span class="comment">#错误日志配置</span></span><br><span class="line">可放置标签段：main,http,server,location</span><br><span class="line">log_format main <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line"><span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line"><span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"><span class="variable">$remote_addr</span> <span class="comment">#记录访问网站的客户端IP</span></span><br><span class="line"><span class="variable">$http_x_forwarded_for</span> <span class="comment">#使用CDN记录真实客户端IP</span></span><br><span class="line"><span class="variable">$remote_user</span> <span class="comment">#</span></span><br><span class="line"><span class="variable">$time_local</span> <span class="comment">#访问时间</span></span><br><span class="line"><span class="variable">$request</span> <span class="comment">#请求页面</span></span><br><span class="line"><span class="variable">$status</span> <span class="comment">#访问状态码</span></span><br><span class="line"><span class="variable">$body_bytes_sent</span> <span class="comment">#响应body的大小，单位字节</span></span><br><span class="line"><span class="variable">$http_referer</span> <span class="comment">#</span></span><br><span class="line"><span class="variable">$http_user_agent</span> <span class="comment">#客户端UA信息</span></span><br><span class="line">access_log logs/access.log main(默认日志记录格式); <span class="comment">#配置访问日志</span></span><br><span class="line">可放置标签段：http,server,location,<span class="keyword">if</span> <span class="keyword">in</span> location,limit_except</span><br><span class="line">1.1.1.1 - - [23/Nov/2017:10:37:45 +0800] <span class="string">&quot;GET /ropon.html HTTP/1.1&quot;</span> 404 571 <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">remote_addr 1.1.1.1</span><br><span class="line">remote_user -</span><br><span class="line">time_local 23/Nov/2017:10:37:45 +0800</span><br><span class="line">request GET /ropon.html HTTP/1.1</span><br><span class="line">status 404</span><br><span class="line">body_bytes_sent 57字节</span><br><span class="line">http_referer 直接访问故记录-</span><br><span class="line">http_user_agent Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36</span><br><span class="line">http_x_forwarded_for 没有使用CDN故记录-</span><br><span class="line">深入了解日志参数[高并发避免日志频繁写入影响IO性能]</span><br><span class="line">access_log path format gzip [=level] [buffer=size] [flush=time] [<span class="keyword">if</span>=condition];</span><br><span class="line">access_log logs/access.gz main gzip buffer=32k flush=5s;</span><br><span class="line">4、nginx日志切割</span><br><span class="line"><span class="built_in">mkdir</span> -p /usr/local/script</span><br><span class="line">vi cut_del_logs.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">LOGS_PATH=/home/wwwlogs/default.gz</span><br><span class="line">YESTERDAY=$(<span class="built_in">date</span> -d <span class="string">&quot;yesterday&quot;</span> +%Y-%m-%d)</span><br><span class="line"><span class="built_in">mv</span> <span class="variable">$&#123;LOGS_PATH&#125;</span>/access.gz <span class="variable">$&#123;LOGS_PATH&#125;</span>/access_<span class="variable">$&#123;YESTERDAY&#125;</span>.gz</span><br><span class="line"><span class="built_in">kill</span> -USR1 `ps axu  grep <span class="string">&quot;nginx: master process&quot;</span>  grep -v grep  awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="comment">#kill USR1 指告诉应用程序重载配置文件相当于reload</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;LOGS_PATH&#125;</span></span><br><span class="line">find . -mtime +7 -name <span class="string">&quot;*20[1-9][3-9]*&quot;</span>  xargs <span class="built_in">rm</span> -f</span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line">crontab -e</span><br><span class="line">1 0 * * * /usr/local/script/cut_del_logs.sh</span><br><span class="line">5、配置nginx虚拟主机</span><br><span class="line"><span class="built_in">mkdir</span> /usr/local/nginx/conf/vhost</span><br><span class="line"><span class="built_in">mkdir</span> -p /home/wwwroot/default</span><br><span class="line">include vhost/*.conf;</span><br><span class="line"><span class="built_in">cd</span> /usr/local/nginx/conf/vhost &amp;&amp; vi 000default.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 1.1.1.1</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /home/wwwroot/default;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">6、location的使用</span><br><span class="line">location [ =  ~  ~*  ^~ ] uri &#123;</span><br><span class="line">&#125;</span><br><span class="line">~ 区分大小写</span><br><span class="line">~* 不区分大小写</span><br><span class="line">!~ !~* 取反</span><br><span class="line">^~ 做常规字符串检查，不做正则匹配。</span><br><span class="line">location = / &#123;</span><br><span class="line">    [ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">    [ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line">location /files/ &#123;</span><br><span class="line">    [ configuration C ]</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">    [ configuration D ]</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(gifjpg)$ &#123;</span><br><span class="line">    [ configuration E ]</span><br><span class="line">&#125;</span><br><span class="line">eg:</span><br><span class="line">location = / &#123;</span><br><span class="line">    <span class="built_in">return</span> 401;</span><br><span class="line">&#125;</span><br><span class="line">location /files/ &#123;</span><br><span class="line">    <span class="built_in">return</span> 402;</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">    <span class="built_in">return</span> 403;</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(jpg)$ &#123;</span><br><span class="line">    <span class="built_in">return</span> 405;</span><br><span class="line">&#125;</span><br><span class="line">访问http://1.1.1.1 或http://1.1.1.1/ 出现401状态码</span><br><span class="line">访问http://1.1.1.1/files/ 出现402状态码</span><br><span class="line">访问http://1.1.1.1/images/ssfasdfsda或http://1.1.1.1/images/ 都会出现403状态码</span><br><span class="line">访问http://1.1.1.1/dfasfsdfsd/sfdasdfsd.jpg或http://1.1.1.1/324123423.jpg 都会出现405状态码</span><br><span class="line">=/是精确匹配优先级最高与放置顺序无关</span><br><span class="line">/是默认匹配，指没有匹配上其他location，最后匹配默认</span><br><span class="line">/files/是路径匹配</span><br><span class="line">^~ /images/也是路径匹配，加了特殊字符^~，/files/11.jpg 优先匹配路径</span><br><span class="line">~* \.(jpg)$是扩展名匹配</span><br><span class="line">7、Nginx rewrite</span><br><span class="line">语法：rewrite regex(正则表达式) replacement [flag];</span><br><span class="line">可放置标签段：server,location,<span class="keyword">if</span></span><br><span class="line">rewrite ^/(.*) http://1.1.1.1/<span class="variable">$1</span> permanent;</span><br><span class="line">^/(.*)匹配所有 匹配成功后跳转到http://1.1.1.1/<span class="variable">$1</span> <span class="variable">$1</span>代表前面^/(.*)具体内容 permanent是永久重定向标记</span><br><span class="line">\ 转义字符 \\ \$</span><br><span class="line">^匹配字符串起始位置</span><br><span class="line">$匹配字符串结束位置</span><br><span class="line">*匹配前面字符零次或多次，比如ro* 可匹配r、roo，*相当于&#123;0,&#125;</span><br><span class="line">+匹配前面字符一次或多次，比如ro+可匹配ro、roo，但不能匹配r，+相当于&#123;1,&#125;</span><br><span class="line">?匹配前面字符零次或一次，比如lp(ro)?可匹配lp、lpro中lp，?相当于&#123;0,1&#125;</span><br><span class="line">.匹配除“\n”之外的任何单字符，若要匹配\n，可使用[.\n]</span><br><span class="line">(pattern)匹配括号内的pattern，并且后面可获取对应匹配，用<span class="variable">$0</span>,<span class="variable">$1</span>..<span class="variable">$9</span>，</span><br><span class="line">若要匹配括号字符，使用\( \)</span><br><span class="line">last 本条规则匹配完，继续匹配下条location uri规则</span><br><span class="line"><span class="built_in">break</span> 本条规则匹配完，就终止不再继续匹配</span><br><span class="line">redirect 返回302临时重定向</span><br><span class="line">permanent 返回301永久重定向</span><br><span class="line">例子</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$http_host</span> ~* <span class="string">&quot;^(.*)\.idiyrom\.com$&quot;</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$temp</span> <span class="variable">$1</span>;</span><br><span class="line">    rewrite ^(.*) http://www.idiyrom.com/<span class="variable">$temp</span>/ropon.html;</span><br><span class="line">    <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">实现的是xxx.idiyrom.com 跳转到 www.idiyrom.com/xxx/ropon.html</span><br><span class="line">8、try_files最核心的功能是可以替代rewrite</span><br><span class="line">语法: try_files file ... uri 或 try_files file ... = code</span><br><span class="line">try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /?<span class="variable">$args</span>;</span><br><span class="line">按顺序检查文件或文件夹是否存在，返回第一个找到的文件或文件夹。</span><br><span class="line">结尾的斜线表示为文件夹 比如<span class="variable">$uri</span>/</span><br><span class="line">如果所有的文件或文件夹都找不到，会进行一个内部重定向到最后一个参数/?<span class="variable">$args</span>。</span><br><span class="line">eg:</span><br><span class="line">location / &#123;</span><br><span class="line">    try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /?<span class="variable">$args</span>;</span><br><span class="line">&#125;</span><br><span class="line">比如访问http://west.idiyrom.com/imgaes/</span><br><span class="line"><span class="variable">$uri</span> 指的是文件，比如images文件，<span class="variable">$uri</span>=/imgaes/</span><br><span class="line"><span class="variable">$uri</span>/ 指的是文件夹，比如images文件夹</span><br><span class="line">如果文件或文件夹都不存在，就会内部重定向到/?<span class="variable">$args</span>，其中<span class="variable">$args</span>是get方法获取的参数，比如images/test?testcanshu</span><br><span class="line">日志格式：<span class="string">&#x27;[$cookie_customerID_cookie_flag] [$args]&#x27;</span> <span class="string">&#x27;($uri)&#x27;</span></span><br><span class="line">[-] [testcanshu](/index.html)</span><br><span class="line"><span class="variable">$args</span>=testcanshu</span><br><span class="line">9、Nginx访问认证</span><br><span class="line">auth_basic</span><br><span class="line">语法：auth_basic stringoff;</span><br><span class="line">可放置标签段：http,server,location,limit_except</span><br><span class="line">auth_basic_user_file file;</span><br><span class="line">可放置标签段：http,server,location,limit_except</span><br><span class="line">htpasswd -bc /usr/local/nginx/conf/htpasswd ropon 123456</span><br><span class="line"><span class="built_in">chmod</span> 400 /usr/local/nginx/conf/htpasswd</span><br><span class="line"><span class="built_in">chown</span> www /usr/local/nginx/conf/htpasswd</span><br><span class="line">location = /ropon/ &#123;</span><br><span class="line">    auth_basic ropon_test;</span><br><span class="line">    auth_basic_user_file /usr/local/nginx/conf/htpasswd;</span><br><span class="line">&#125;</span><br><span class="line">10、添加启动项</span><br><span class="line"><span class="built_in">cat</span> /etc/init.d/nginx</span><br><span class="line">……</span><br><span class="line">nginx_install_dir=/usr/local/nginx</span><br><span class="line">[ -z <span class="string">&quot;`grep ^&#x27;export PATH=&#x27; /etc/profile`&quot;</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;export PATH=<span class="variable">$nginx_install_dir</span>/sbin:\$PATH&quot;</span> &gt;&gt; /etc/profile</span><br><span class="line">[ -n <span class="string">&quot;`grep ^&#x27;export PATH=&#x27; /etc/profile`&quot;</span> -a -z <span class="string">&quot;`grep <span class="variable">$nginx_install_dir</span> /etc/profile`&quot;</span> ] &amp;&amp; sed -i <span class="string">&quot;s@^export PATH=\(.*\)@export PATH=<span class="variable">$nginx_install_dir</span>/sbin:\1@&quot;</span> /etc/profile</span><br><span class="line">. /etc/profile</span><br><span class="line">wget -O /etc/init.d/nginx http://mirrors.ropon.top/shell/lnmp/init.d/Nginx-init-CentOS.txt</span><br><span class="line"><span class="built_in">chmod</span> +x /etc/init.d/nginx</span><br><span class="line">chkconfig --add nginx</span><br><span class="line">chkconfig nginx on</span><br><span class="line">自动安装shell脚本：http://mirrors.ropon.top/shell/lnmp/nginx.sh</span><br><span class="line">附Rewriterule参数详解</span><br><span class="line">1) R 强制外部重定向，后面可以代301或302跳转。</span><br><span class="line">2) F 禁用URL,返回403HTTP状态码。</span><br><span class="line">3) G 强制URL为GONE，返回410HTTP状态码。</span><br><span class="line">4) P 强制使用代理转发。</span><br><span class="line">5) L 表明当前规则是最后一条规则，停止分析以后规则的重写。</span><br><span class="line">6) N 重新从第一条规则开始运行重写过程。</span><br><span class="line">7) C 与下一条规则关联。</span><br><span class="line">8) T=MIME-<span class="built_in">type</span>(force MIME <span class="built_in">type</span>) 强制MIME类型。</span><br><span class="line">9) NS 只用于不是内部子请求。</span><br><span class="line">10) NC 不区分大小写。</span><br><span class="line">11) QSA 追加请求字符串。</span><br><span class="line">12) NE 不在输出转义特殊字符。</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="更新nginx1-22-0-并安装支持lua"><a href="#更新nginx1-22-0-并安装支持lua" class="headerlink" title="更新nginx1.22.0 并安装支持lua"></a>更新nginx1.22.0 并安装支持lua</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#安装所需</span><br><span class="line">yum -y install pcre-devel pcre</span><br><span class="line">yum -y install openssl-devel openssl</span><br><span class="line">yum -y install gcc-c++</span><br><span class="line"></span><br><span class="line">#创建普通用户及组</span><br><span class="line">groupadd www &amp;&amp; useradd www -s /sbin/nologin -M -g www</span><br><span class="line"></span><br><span class="line">#下载所需文件</span><br><span class="line">echo-nginx-module-0.62.tar.gz</span><br><span class="line">luajit2-2.1-20220915.tar.gz</span><br><span class="line">lua-nginx-module-0.10.22.tar.gz</span><br><span class="line">lua-resty-core-0.1.24.tar.gz</span><br><span class="line">lua-resty-lrucache-0.13.tar.gz</span><br><span class="line">nginx-1.22.0.tar.gz</span><br><span class="line">ngx_devel_kit-0.3.1.tar.gz</span><br><span class="line"></span><br><span class="line">wget https://nginx.org/download/nginx-1.22.0.tar.gz</span><br><span class="line">wget https://github.com/openresty/luajit2/archive/refs/tags/v2.1-20220915.tar.gz</span><br><span class="line">wget https://github.com/openresty/lua-nginx-module/archive/refs/tags/v0.10.22.tar.gz</span><br><span class="line"></span><br><span class="line">#批量解压</span><br><span class="line">ls *.tar.gzxargs -n 1 tar -xzvf</span><br><span class="line"></span><br><span class="line">#编译所需库</span><br><span class="line">cd luajit2-2.1-20220915</span><br><span class="line">make install PREFIX=/usr/local/luajit2-2.1-20220915</span><br><span class="line">设置环境变量到/etc/profile</span><br><span class="line">export LUAJIT_LIB=/usr/local/luajit2-2.1-20220915/lib/</span><br><span class="line">export LUAJIT_INC=/usr/local/luajit2-2.1-20220915/include/luajit-2.1</span><br><span class="line">source /etc/profile</span><br><span class="line">ln -sf /usr/local/luajit2-2.1-20220915/lib/libluajit-5.1.so.2 /lib64/libluajit-5.1.so.2</span><br><span class="line"></span><br><span class="line">cd ../lua-resty-core-0.1.24</span><br><span class="line">make install PREFIX=/usr/local/lua_core</span><br><span class="line">cd ../lua-resty-lrucache-0.13</span><br><span class="line">make install PREFIX=/usr/local/lua_core</span><br><span class="line"></span><br><span class="line">#安装nginx</span><br><span class="line">cd ../nginx-1.22.0</span><br><span class="line">./configure --prefix=/usr/local/nginx --user=www --group=www --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_ssl_module --with-stream --with-stream_ssl_preread_module --with-stream_ssl_module --with-http_gzip_static_module --with-http_realip_module --with-http_flv_module --with-http_mp4_module --add-module=../ngx_devel_kit-0.3.1 --add-module=../lua-nginx-module-0.10.22 --add-module=../echo-nginx-module-0.62</span><br><span class="line">make -j 4</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">nginx.conf http节加</span><br><span class="line">lua_package_path &quot;/usr/local/lua_core/lib/lua/?.lua;;&quot;;</span><br><span class="line">nginx -t</span><br></pre></td></tr></table></figure>

<h3 id="nginx-安装https正向代理"><a href="#nginx-安装https正向代理" class="headerlink" title="nginx 安装https正向代理"></a>nginx 安装https正向代理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#下载所需库</span><br><span class="line">https://github.com/chobits/ngx_http_proxy_connect_module</span><br><span class="line"></span><br><span class="line">#打补丁 看介绍不同版本补丁不一样</span><br><span class="line">#这里是nginx-1.22.0</span><br><span class="line">patch -p1 &lt; ../ngx_http_proxy_connect_module-0.0.3/patch/proxy_connect_rewrite_102101.patch</span><br><span class="line">#如果之前已安装nginx，查看之前编译参数nginx -V</span><br><span class="line">--add-module=../ngx_http_proxy_connect_module-0.0.3</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">#新建proxy.conf配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen 1443;</span><br><span class="line">    charset utf-8;</span><br><span class="line">    #DNS解析(核心配置)</span><br><span class="line">    resolver 10.2.1.10;</span><br><span class="line">    client_max_body_size     50m;</span><br><span class="line">    access_log logs/access_proxy.log;</span><br><span class="line"></span><br><span class="line">    #need ngx_proxy module</span><br><span class="line">    proxy_connect;</span><br><span class="line">    proxy_connect_allow            443 80;</span><br><span class="line">    proxy_connect_connect_timeout  10s;</span><br><span class="line">    proxy_connect_read_timeout     10s;</span><br><span class="line">    proxy_connect_send_timeout     10s;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass $scheme://$http_host$request_uri;</span><br><span class="line">        proxy_connect_timeout 10;</span><br><span class="line">         proxy_send_timeout 10;</span><br><span class="line">         proxy_read_timeout 10;</span><br><span class="line">         proxy_redirect     off;</span><br><span class="line">         proxy_set_header Host $http_host;</span><br><span class="line">         proxy_buffers 256 4k;</span><br><span class="line">         proxy_next_upstream error timeout invalid_header http_502;</span><br><span class="line">         proxy_max_temp_file_size 0k;</span><br><span class="line">        proxy_ssl_server_name on;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="之前是通过yum安装升级"><a href="#之前是通过yum安装升级" class="headerlink" title="之前是通过yum安装升级"></a>之前是通过yum安装升级</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc-c++ pcre-devel pcre openssl-devel openssl</span><br><span class="line">yum -y install libxslt-devel libxml2 libxml2-dev gd-devel perl-devel perl-ExtUtils-Embed gperftools</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt=&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4&#x27; --add-module=/usr/local/ngx_devel_kit-0.3.1 --add-module=/usr/local/lua-nginx-module-0.10.22 --add-module=/usr/local/echo-nginx-module-0.62</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/11/22/%E8%AF%A6%E8%A7%A3nginx/" data-id="clc4klg8200brojobbtzq4jjt" data-title="详解nginx" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-wdcpv2升v3的全自动脚本" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/06/06/wdcpv2%E5%8D%87v3%E7%9A%84%E5%85%A8%E8%87%AA%E5%8A%A8%E8%84%9A%E6%9C%AC/" class="article-date">
  <time class="dt-published" datetime="2017-06-06T05:41:49.000Z" itemprop="datePublished">2017-06-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/yunwei-tools/">yunwei-tools</a>►<a class="article-category-link" href="/categories/yunwei-tools/Shell/">Shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/06/06/wdcpv2%E5%8D%87v3%E7%9A%84%E5%85%A8%E8%87%AA%E5%8A%A8%E8%84%9A%E6%9C%AC/">wdcpv2升v3的全自动脚本</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>#!&#x2F;bin&#x2F;bash<br>#功能描述:<br>#1、一键升级wdcp为v3.2.2<br>#2、自动导入原v2.5的站点信息<br>#3、备份原v2.5配置文件到&#x2F;home&#x2F;wddata2，若需还原v2.5</p>
<h1 id="恢复备份，然后将现在wddata改名，将-x2F-home-x2F-wddata2改名为-x2F-home-x2F-wddata"><a href="#恢复备份，然后将现在wddata改名，将-x2F-home-x2F-wddata2改名为-x2F-home-x2F-wddata" class="headerlink" title="恢复备份，然后将现在wddata改名，将&#x2F;home&#x2F;wddata2改名为&#x2F;home&#x2F;wddata"></a>恢复备份，然后将现在wddata改名，将&#x2F;home&#x2F;wddata2改名为&#x2F;home&#x2F;wddata</h1><h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>#注意事项：<br>#1、升级时，请暂停网站，以免数据不同步<br>#2、升级后，所有FTP用户都需要重新设置密码，也可在使用时再重设。<br>#3、之前部署ssl，若证书文件存放根分区，请注意备份证书文件。</p>
<h1 id="-1"><a href="#-1" class="headerlink" title=""></a></h1><p>PATH&#x3D;”&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin”<br>serviceall(){<br>service nginxd $1<br>service httpd $1<br>service mysqld $1<br>service memcached $1<br>service pureftpd $1<br>}</p>
<p>install_ftp(){<br>service pureftpd stop<br>wget -c <a target="_blank" rel="noopener" href="http://dl.wdlinux.cn/files/ftp/pure-ftpd-1.0.42.tar.gz">http://dl.wdlinux.cn/files/ftp/pure-ftpd-1.0.42.tar.gz</a><br>tar zxvf pure-ftpd-1.0.42.tar.gz<br>cd pure-ftpd-1.0.42<br>.&#x2F;configure –prefix&#x3D;&#x2F;www&#x2F;wdlinux&#x2F;pureftpd-1.0.42 \<br>        –with-puredb \<br>        –with-quotas \<br>        –with-cookie \<br>        –with-virtualhosts \<br>        –with-virtualchroot \<br>        –with-diraliases \<br>        –with-sysquotas \<br>        –with-ratios \<br>        –with-altlog \<br>        –with-paranoidmsg \<br>        –with-shadow \<br>        –with-welcomemsg  \<br>        –with-throttling \<br>        –with-uploadscript \<br>        –with-rfc2640 \<br>        –with-ftpwho \<br>        –with-language&#x3D;simplified-chinese<br>make<br>make install<br>rm -f &#x2F;www&#x2F;wdlinux&#x2F;pureftpd<br>ln -sf &#x2F;www&#x2F;wdlinux&#x2F;pureftpd-1.0.42 &#x2F;www&#x2F;wdlinux&#x2F;pureftpd<br>cp configuration-file&#x2F;pure-config.pl &#x2F;www&#x2F;wdlinux&#x2F;pureftpd&#x2F;sbin&#x2F;<br>chmod 755 &#x2F;www&#x2F;wdlinux&#x2F;pureftpd&#x2F;sbin&#x2F;pure-config.pl<br>mkdir &#x2F;www&#x2F;wdlinux&#x2F;pureftpd&#x2F;etc -p<br>touch &#x2F;www&#x2F;wdlinux&#x2F;pureftpd&#x2F;etc&#x2F;{pureftpd.passwd,pureftpd.pdb}<br>rm -f &#x2F;www&#x2F;wdlinux&#x2F;etc&#x2F;pure-ftpd.conf<br>wget -c <a target="_blank" rel="noopener" href="http://www.wdlinux.cn/conf/ftp/pure-ftpd.conf">http://www.wdlinux.cn/conf/ftp/pure-ftpd.conf</a> -O &#x2F;www&#x2F;wdlinux&#x2F;etc&#x2F;pure-ftpd.conf<br>}</p>
<p>update_wdcp(){<br>ind&#x3D;”&#x2F;www&#x2F;wdlinux&#x2F;wdcp”<br>if [ -f $ind&#x2F;data&#x2F;db.inc.php ];then<br>if [ -d &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;phpmyadmin ];then<br>cp -pR &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;phpmyadmin &#x2F;www&#x2F;web&#x2F;default&#x2F;pma_*****<br>fi<br>sed -i ‘s#&#x2F;wdcp#&#x2F;wdcp2#’ &#x2F;www&#x2F;wdlinux&#x2F;wdapache&#x2F;conf&#x2F;httpd.conf<br>service wdapache stop<br>mv $ind &#x2F;www&#x2F;wdlinux&#x2F;wdcp2<br>wport&#x3D;`grep  “Listen “ &#x2F;www&#x2F;wdlinux&#x2F;wdapache&#x2F;conf&#x2F;httpd.confawk ‘NR&#x3D;&#x3D;4{print}’awk ‘{print $2}’`<br>grep “$wport” &#x2F;www&#x2F;wdlinux&#x2F;wdapache&#x2F;conf&#x2F;httpd.conf<br>if [ $? &#x3D;&#x3D; 0 ];then<br>sed -i “s&#x2F;$wport&#x2F;8090&#x2F;g” &#x2F;www&#x2F;wdlinux&#x2F;wdapache&#x2F;conf&#x2F;httpd.conf<br>iptables -I INPUT -p tcp –dport 8090 -j ACCEPT<br>else<br>iptables -I INPUT -p tcp –dport $wport -j ACCEPT<br>fi<br>iptables-save &gt; &#x2F;etc&#x2F;sysconfig&#x2F;iptables<br>fi<br>if [ ! -d $ind ];then<br>mkdir -p $ind<br>fi<br>pushd $ind<br>filename&#x3D;”wdcp_v3.2.2_64.tar.gz”<br>wget -c <a target="_blank" rel="noopener" href="http://dl.wdlinux.cn/files//wdcp/$filename">http://dl.wdlinux.cn/files//wdcp/$filename</a><br>if [ $? &#x3D;&#x3D; 0 ];then<br>tar zxvf $filename<br>mkdir {logs,tmp,rewrite}<br>ln -sf bin&#x2F;wdcp_v3.2.2_64 wdcp<br>if [ ! -f &#x2F;bin&#x2F;mysql ];then<br>ln -s &#x2F;www&#x2F;wdlinux&#x2F;mysql&#x2F;bin&#x2F;mysql &#x2F;bin&#x2F;mysql<br>fi<br>chown root.root bin favicon.ico html static shell conf -R<br>chmod 700 data conf shell bin html<br>ln -sf &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;wdcp.sh &#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;wdcp<br>chkconfig –add wdcp<br>chkconfig –level 35 wdcp on<br>pushd $ind<br>rm -f $filename<br>fi<br>}</p>
<p>wdcp_modified(){<br>serviceall “stop”<br>mv &#x2F;home&#x2F;wddata&#x2F; &#x2F;home&#x2F;wddata2<br>mkdir -p &#x2F;home&#x2F;wddata<br>mkdir -p &#x2F;home&#x2F;wddata&#x2F;vhost<br>mkdir -p &#x2F;home&#x2F;wddata&#x2F;wdcp<br>pushd &#x2F;home&#x2F;wddata&#x2F;<br>mv &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;etc.tar.gz .&#x2F;<br>tar xvzf etc.tar.gz<br>mv &#x2F;www&#x2F;wdlinux&#x2F;pureftpd&#x2F;etc &#x2F;home&#x2F;wddata&#x2F;etc&#x2F;pureftpd_etc<br>ln -sf &#x2F;home&#x2F;wddata&#x2F;etc&#x2F;pureftpd_etc &#x2F;www&#x2F;wdlinux&#x2F;pureftpd&#x2F;etc<br>cp -pR &#x2F;home&#x2F;wddata2&#x2F;vhost &#x2F;home&#x2F;wddata&#x2F;vhost&#x2F;apache_vhost<br>rm -f &#x2F;www&#x2F;wdlinux&#x2F;apache&#x2F;conf&#x2F;vhost<br>ln -sf &#x2F;home&#x2F;wddata&#x2F;vhost&#x2F;apache_vhost &#x2F;www&#x2F;wdlinux&#x2F;apache&#x2F;conf&#x2F;vhost<br>cp -pR &#x2F;www&#x2F;wdlinux&#x2F;nginx&#x2F;conf&#x2F;vhost &#x2F;home&#x2F;wddata&#x2F;vhost&#x2F;nginx_vhost<br>mv &#x2F;www&#x2F;wdlinux&#x2F;nginx&#x2F;conf&#x2F;vhost&#x2F; &#x2F;home&#x2F;wddata2&#x2F;nginx_vhost<br>ln -sf &#x2F;home&#x2F;wddata&#x2F;vhost&#x2F;nginx_vhost &#x2F;www&#x2F;wdlinux&#x2F;nginx&#x2F;conf&#x2F;vhost<br>rm -f &#x2F;www&#x2F;wdlinux&#x2F;mysql&#x2F;var<br>ln -sf &#x2F;home&#x2F;wddata2&#x2F;var &#x2F;www&#x2F;wdlinux&#x2F;mysql&#x2F;var<br>rm -f &#x2F;www&#x2F;wdlinux&#x2F;wdcp2&#x2F;data<br>ln -sf &#x2F;home&#x2F;wddata2&#x2F;data &#x2F;www&#x2F;wdlinux&#x2F;wdcp2&#x2F;data<br>mv &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;conf &#x2F;home&#x2F;wddata&#x2F;wdcp&#x2F;conf<br>ln -sf &#x2F;home&#x2F;wddata&#x2F;wdcp&#x2F;conf &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;conf<br>mv &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;data &#x2F;home&#x2F;wddata&#x2F;wdcp&#x2F;data<br>ln -sf &#x2F;home&#x2F;wddata&#x2F;wdcp&#x2F;data &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;data<br>serviceall “start”<br>service wdcp start<br>ip&#x3D;`ifconfig eth0  grep “inet addr”  awk ‘{ print $2}’  awk -F: ‘{print $2}’`<br>sh &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;shell&#x2F;mysqlrootchp.sh<br>cp -pR &#x2F;home&#x2F;wddata2&#x2F;var &#x2F;home&#x2F;wddata&#x2F;mysql_data<br>echo -e “\033[40;32mimport v2.5 data …\033[40;37m”<br>echo<br>sleep 2<br>curl -c .&#x2F;cookie_c.txt -F “username&#x3D;admin” -F “passwd&#x3D;wdlinux.cn” “http:&#x2F;&#x2F;${ip}:8080&#x2F;login”<br>sleep 2<br>curl -b .&#x2F;cookie_c.txt “http:&#x2F;&#x2F;${ip}:8080&#x2F;index?act&#x3D;import”<br>echo<br>sh &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;shell&#x2F;wdcploginchp.sh<br>}</p>
<p>main(){<br>bit&#x3D;`getconf LONG_BIT`<br>if [ $bit &#x3D;&#x3D; ‘32’ ] ;then<br>echo -e “\033[1;40;31m32bit is not support!\033[0m”<br>exit<br>fi<br>if [ ! -d &#x2F;www&#x2F;wdlinux&#x2F;pureftpd-1.0.42 ];then<br>install_ftp<br>fi<br>if [ ! -d &#x2F;www&#x2F;wdlinux&#x2F;wdcp2 ];then<br>update_wdcp<br>fi<br>if [ ! -d &#x2F;home&#x2F;wddata2 ];then<br>wdcp_modified<br>fi<br>}<br>main<br>echo -e “\033[1;40;31mPlease retain the data reinstall system\033[0m”<br>echo<br>echo -e “\033[1;40;31mchown mysql.mysql -R &#x2F;home&#x2F;wddata&#x2F;mysql_data\033[0m”<br>echo -e “\033[1;40;31mupdate success!\033[0m”<br>echo</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/06/06/wdcpv2%E5%8D%87v3%E7%9A%84%E5%85%A8%E8%87%AA%E5%8A%A8%E8%84%9A%E6%9C%AC/" data-id="clc4klg79009hojobeqxt5jvp" data-title="wdcpv2升v3的全自动脚本" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-windows2008、2012及以上一键安装php5-6、7-0" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/14/windows2008%E3%80%812012%E5%8F%8A%E4%BB%A5%E4%B8%8A%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85php5-6%E3%80%817-0/" class="article-date">
  <time class="dt-published" datetime="2017-04-14T06:51:26.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/yunwei-tools/">yunwei-tools</a>►<a class="article-category-link" href="/categories/yunwei-tools/Cmd/">Cmd</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/14/windows2008%E3%80%812012%E5%8F%8A%E4%BB%A5%E4%B8%8A%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85php5-6%E3%80%817-0/">windows2008、2012及以上一键安装php5.6、7.0</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>:: $Name:         php56-70.bat<br>:: $Version:      v1.1<br>:: $Function:     一键安装php5.6、7.0<br>:: $Author:       Ropon<br>:: $organization: west.cn<br>:: $Create Date:  2017-4-18<br>:: $Description:  1、一键安装php5.6、7.0<br>::                2、支持预装环境及纯净版<br>::#v1.1<br>::优化php5.6 zend、op加速组件<br>::优化php7.0缓存目录，安装时做了智能判断目录是否存在，权限是否正确<br>::<br>@echo off&amp;setlocal enabledelayedexpansion<br>set baseurl&#x3D;<a target="_blank" rel="noopener" href="http://download.myhostadmin.net/">http://download.myhostadmin.net</a><br>if not exist %cd%\wget.exe (<br>echo.<br>echo 缺少wget.exe程序<br>explorer.exe %baseurl%&#x2F;wget.exe<br>echo 正在下载wget.exe必要程序，请保存到当前目录下<br>echo 下载完成后按任意键继续<br>pause<br>)<br>if not exist %cd%\wget.exe (<br>echo.<br>echo 自动头下载失败请访问 %baseurl%&#x2F;wget.exe 手动下载<br>echo 并保存到当前目录<br>echo.<br>pause<br>exit<br>)<br>echo.<br>:menu<br>echo.<br>echo 一键安装php5.6、7.0<br>echo.<br>echo 请选择php版本: </p>
<p>echo   1 php5.6<br>echo   2 php7.0<br>echo   0 退出</p>
<p>set &#x2F;p first&#x3D;</p>
<p>if %first% &#x3D;&#x3D;1 call:phpinstall 5.6<br>if %first% &#x3D;&#x3D;2 call:phpinstall 7.0<br>if %first% &#x3D;&#x3D;0 goto exit</p>
<p>:download<br>echo.<br>echo 正在下载所需组件<br>echo.<br>%cd%\wget.exe %<del>1 -O %</del>2<br>goto:eof</p>
<p>:phpinstall<br>echo.<br>if not exist D:\SOFT_PHP_PACKAGE (<br>echo 请输入安装路径<br>echo 比如：d:\php<br>set &#x2F;p “a&#x3D;：”<br>) else set a&#x3D;D:\SOFT_PHP_PACKAGE<br>echo 检查 php%<del>1 缓存目录是否存在 ……<br>echo.<br>if not exist D:\SOFT_PHP_PACKAGE\phptmp (<br>md D:\SOFT_PHP_PACKAGE\phptmp<br>echo YC:\Windows\system32\cacls D:\SOFT_PHP_PACKAGE\phptmp &#x2F;T &#x2F;C &#x2F;P administrators:F everyone:F<br>)<br>set b&#x3D;%a%\php%</del>1<br>echo 开始安装php%<del>1 ……<br>if not exist %cd%\php%</del>1.rar (<br>call:download %baseurl%&#x2F;php&#x2F;php%<del>1.rar %cd%\php%</del>1.rar<br>)<br>“C:\Program Files\WinRAR\rar.exe” x -inul -o+  %cd%\php%<del>1.rar   %a%  -y<br>cls<br>echo YC:\Windows\system32\cacls %b% &#x2F;T &#x2F;C &#x2F;P administrators:F everyone:R<br>if not exist %cd%\vcx86php%</del>1.exe (<br>call:download %baseurl%&#x2F;php&#x2F;vcx86php%<del>1.exe %cd%\vcx86php%</del>1.exe<br>)<br>echo 正在安装VC组件 ……<br>%cd%\vcx86php%~1.exe &#x2F;install &#x2F;quiet &#x2F;norestart</p>
<p>C:\Windows\System32\inetsrv\appcmd.exe set config  -section:system.webServer&#x2F;fastCgi &#x2F;+”[fullPath&#x3D;’%b%\php-cgi.exe’,monitorChangesTo&#x3D;’%b%\php.ini’,maxInstances&#x3D;’100’,instanceMaxRequests&#x3D;’3000’]“ &#x2F;commit:apphost<br>C:\Windows\System32\inetsrv\appcmd.exe set config  -section:system.webServer&#x2F;fastCgi &#x2F;+”[fullPath&#x3D;’%b%\php-cgi.exe’,monitorChangesTo&#x3D;’%b%\php.ini’,maxInstances&#x3D;’100’,instanceMaxRequests&#x3D;’3000’].environmentVariables.[name&#x3D;’PHP_FCGI_MAX_REQUESTS’,value&#x3D;’1000’]“ &#x2F;commit:apphost<br>C:\Windows\System32\inetsrv\appcmd.exe set config  -section:system.webServer&#x2F;fastCgi &#x2F;+”[fullPath&#x3D;’%b%\php-cgi.exe’,monitorChangesTo&#x3D;’%b%\php.ini’,maxInstances&#x3D;’100’,instanceMaxRequests&#x3D;’3000’].environmentVariables.[name&#x3D;’PHPRC’,value&#x3D;’%b%’]“ &#x2F;commit:apphost</p>
<p>goto end</p>
<p>:end<br>echo.<br>echo 需要重启iis才能生效，正在重启中……<br>C:\Windows\system32\iisreset<br>echo.<br>echo 已成功安装php%~1<br>echo.<br>echo 请使用建站助手创建站点，创建时请选择php5.3或5.4或5.5<br>echo.<br>echo 创建完成后请到iis管理器-找到对应站点-处理程序映射-找到php-可执行文件-5.6或7.0所在路径<br>echo.<br>echo.<br>echo   1 继续安装其他版本<br>echo   2 清理下载文件并退出<br>echo   0 退出<br>echo.<br>set &#x2F;p choice&#x3D;<br>if %choice% &#x3D;&#x3D;1 goto menu<br>if %choice% &#x3D;&#x3D;2 goto del<br>if %choice% &#x3D;&#x3D;0 goto exit</p>
<p>:del<br>echo.<br>echo 正在清理之前下载文件及文件夹……<br>echo.<br>for &#x2F;f “delims&#x3D;” %%i in (‘dir &#x2F;b &#x2F;a-d “php*“.rar’) do del %%i<br>for &#x2F;f “delims&#x3D;” %%i in (‘dir &#x2F;b &#x2F;a-d “vcx86php*“.exe’) do del %%i<br>pause<br>exit</p>
<p>:exit<br>exit</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/04/14/windows2008%E3%80%812012%E5%8F%8A%E4%BB%A5%E4%B8%8A%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85php5-6%E3%80%817-0/" data-id="clc4klg7f009pojob7z1ehfps" data-title="windows2008、2012及以上一键安装php5.6、7.0" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-windows一键开启php-ioncube加密扩展" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/14/windows%E4%B8%80%E9%94%AE%E5%BC%80%E5%90%AFphp-ioncube%E5%8A%A0%E5%AF%86%E6%89%A9%E5%B1%95/" class="article-date">
  <time class="dt-published" datetime="2017-04-14T06:51:09.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/yunwei-tools/">yunwei-tools</a>►<a class="article-category-link" href="/categories/yunwei-tools/Cmd/">Cmd</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/14/windows%E4%B8%80%E9%94%AE%E5%BC%80%E5%90%AFphp-ioncube%E5%8A%A0%E5%AF%86%E6%89%A9%E5%B1%95/">windows一键开启php_ioncube加密扩展</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>:: $Name:         iocube.bat<br>:: $Version:      v1.0<br>:: $Function:     一键安装ionCube加密扩展<br>:: $Author:       Ropon<br>:: $organization: west.cn<br>:: $Create Date:  2017-3-10<br>:: $Description:  1、一键安装ionCube加密扩展<br>::                2、支持预装环境及纯净版<br>::                3、支持php5.2-php7.0<br>::<br>::<br>@echo off&amp;setlocal enabledelayedexpansion<br>set base&#x3D;<a target="_blank" rel="noopener" href="http://download.myhostadmin.net/php/ioncube">http://download.myhostadmin.net/php/ioncube</a><br>if not exist %cd%\wget.exe (<br>echo.<br>echo 缺少wget.exe程序<br>explorer.exe <a target="_blank" rel="noopener" href="http://download.myhostadmin.net/wget.exe">http://download.myhostadmin.net/wget.exe</a><br>echo 正在下载wget.exe必要程序，请保存到当前目录下<br>echo 下载完成后按任意键继续<br>pause<br>)<br>if not exist %cd%\wget.exe (<br>echo.<br>echo 自动头下载失败请访问 <a target="_blank" rel="noopener" href="http://download.myhostadmin.net/wget.exe">http://download.myhostadmin.net/wget.exe</a> 手动下载<br>echo 并保存到当前目录<br>echo.<br>pause<br>exit<br>)<br>echo.<br>if not exist %cd%\sed.rar (<br>call:download <a target="_blank" rel="noopener" href="http://download.myhostadmin.net/memcache/sed.rar">http://download.myhostadmin.net/memcache/sed.rar</a> %cd%\sed.rar<br>“C:\Program Files\WinRAR\rar.exe” x -inul -o+  %cd%\sed.rar   %cd%  -y<br>cls<br>)</p>
<p>:menu<br>echo.<br>echo 请选择php版本: </p>
<p>echo   1 php5.2<br>echo   2 php5.3<br>echo   3 php5.4<br>echo   4 php5.5<br>echo   5 php5.6<br>echo   6 php7.0<br>echo   0 退出</p>
<p>set &#x2F;p first&#x3D;</p>
<p>if %first% &#x3D;&#x3D;1 goto php52<br>if %first% &#x3D;&#x3D;2 call:phpbase 5.3<br>if %first% &#x3D;&#x3D;3 call:phpbase 5.4<br>if %first% &#x3D;&#x3D;4 call:phpbase 5.5<br>if %first% &#x3D;&#x3D;5 call:phpbase 5.6<br>if %first% &#x3D;&#x3D;6 call:phpbase 7.0<br>if %first% &#x3D;&#x3D;0 goto exit</p>
<p>:download<br>echo.<br>echo 正在下载所需组件<br>echo.<br>%cd%\wget.exe %<del>1 -O %</del>2<br>goto:eof</p>
<p>:existfloder<br>echo.<br>echo 检查是否安装对应版本php环境<br>if not exist %<del>1 (<br>echo.<br>echo 核实当前服务器没有安装php%</del>2<br>pause<br>goto exit<br>)<br>goto:eof</p>
<p>:php52<br>echo 请输入PHP安装路径:<br>echo 比如：d:\php<br>set path&#x3D;<br>set &#x2F;p “path&#x3D;若使用建站助手，请直接回车：”<br>if defined path (<br>    set a&#x3D;%path%<br>) else set a&#x3D;D:\SOFT_PHP_PACKAGE\php\<br>call:existfloder %a% 5.2<br>set url&#x3D;%base%&#x2F;ioncube_loader_win_5.2_ts.dll<br>echo 一键安装ionCube加密扩展v6.0.9<br>if not exist %a%ext\ioncube_loader_win_5.2_ts.dll (<br>call:download %url% %a%ext\ioncube_loader_win_5.2_ts.dll<br>cls<br>)<br>C:\Windows\system32\cacls.exe “%a%ext\ioncube_loader_win_5.2_ts.dll” &#x2F;e &#x2F;g everyone:r<br>set b&#x3D;D:&#x2F;\SOFT_PHP_PACKAGE&#x2F;\php&#x2F;\ext&#x2F;\ioncube_loader_win_5.2_ts.dll<br>copy “%a%php.ini” “%a%php_bak.ini” &gt;nul 2&gt;nul<br>%cd%\sed\sed.exe -i “&#x2F;^\[Zend&#x2F;a\zend_extension_ts&#x3D;%b%” %a%php.ini<br>goto end</p>
<p>:phpbase<br>echo 请输入PHP安装路径:<br>echo 比如：d:\php<br>set path&#x3D;<br>set &#x2F;p “path&#x3D;若使用建站助手，请直接回车：”<br>if defined path (<br>    set a&#x3D;%path%<br>) else set a&#x3D;D:\SOFT_PHP_PACKAGE\php%<del>1\<br>call:existfloder %a% %</del>1<br>set url&#x3D;%base%&#x2F;ioncube_loader_win_%<del>1.dll<br>set b&#x3D;D:&#x2F;\SOFT_PHP_PACKAGE&#x2F;\php%</del>1&#x2F;\ext&#x2F;\ioncube_loader_win_%<del>1.dll<br>echo 一键安装ionCube加密扩展v6.0.9<br>if not exist %a%ext\ioncube_loader_win_%</del>1.dll (<br>call:download %url% %a%ext\ioncube_loader_win_%<del>1.dll<br>cls<br>)<br>C:\Windows\system32\cacls.exe “%a%ext\ioncube_loader_win_%</del>1.dll” &#x2F;e &#x2F;g everyone:r<br>copy “%a%php.ini” “%a%php_bak.ini” &gt;nul 2&gt;nul<br>%cd%\sed\sed.exe -i “&#x2F;^\[Zend.loader&#x2F;a\zend_extension&#x3D;%b%” %a%php.ini<br>goto end</p>
<p>:end<br>echo.<br>echo 需要重启iis才能生效，正在重启中……<br>C:\Windows\system32\iisreset<br>echo.<br>echo 安装完成，请关闭窗口<br>echo.<br>echo.<br>echo   1 继续安装其他版本<br>echo   2 清理下载文件并退出<br>echo   0 退出<br>echo.<br>set &#x2F;p choice&#x3D;<br>if %choice% &#x3D;&#x3D;1 goto menu<br>if %choice% &#x3D;&#x3D;2 goto del<br>if %choice% &#x3D;&#x3D;0 goto exit</p>
<p>:del<br>echo.<br>echo 正在清理之前下载文件及文件夹……<br>echo.<br>for &#x2F;f “delims&#x3D;” %%i in (‘dir &#x2F;b &#x2F;a-d &#x2F;s “sed*“‘) do del %%i<br>rd &#x2F;s&#x2F;q %cd%\sed<br>pause<br>exit</p>
<p>:exit<br>exit</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/04/14/windows%E4%B8%80%E9%94%AE%E5%BC%80%E5%90%AFphp-ioncube%E5%8A%A0%E5%AF%86%E6%89%A9%E5%B1%95/" data-id="clc4klg7g009rojobfgm3hjsh" data-title="windows一键开启php_ioncube加密扩展" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-nginx反向代理iis一键部署https" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/14/nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86iis%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2https/" class="article-date">
  <time class="dt-published" datetime="2017-04-14T06:50:52.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/yunwei-tools/">yunwei-tools</a>►<a class="article-category-link" href="/categories/yunwei-tools/Shell/">Shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/14/nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86iis%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2https/">Nginx反向代理IIS一键部署https</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="Nginx反向代理IIS-一键部署多个https站点"><a href="#Nginx反向代理IIS-一键部署多个https站点" class="headerlink" title="Nginx反向代理IIS 一键部署多个https站点"></a>Nginx反向代理IIS 一键部署多个https站点</h4><ul>
<li>nginx反向代理IIS一键部署https</li>
<li>支持预装环境及纯净版使用iis web环境</li>
<li>部署后nginx配置文件推荐放到d:&#x2F;nginx&#x2F;conf&#x2F;vhost&#x2F;目录下</li>
<li>证书路径d:&#x2F;nginx&#x2F;ssl 以域名命名ropon.top.crt ropon.top.key</li>
<li>部署后nginx站点配置文件名为ropon.top.conf</li>
</ul>
<h4 id="具体代码"><a href="#具体代码" class="headerlink" title="具体代码"></a>具体代码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></td><td class="code"><pre><span class="line">@echo off&amp;setlocal enabledelayedexpansion</span><br><span class="line">color 2f</span><br><span class="line">set ver=1.9</span><br><span class="line">set port=443</span><br><span class="line">set suser=nginx</span><br><span class="line">set sname=Nginxd</span><br><span class="line">set sslpath=d:\ssl</span><br><span class="line">set nginxpath=d:\nginx</span><br><span class="line">title IIS+NGINX反向代理环境部署程序v%ver%</span><br><span class="line">set vhostpath=d:\nginx\conf\vhost</span><br><span class="line">set nginxconf=d:\nginx\conf\nginx.conf</span><br><span class="line">set vhosttemppath=d:\nginx\conf\temp.conf</span><br><span class="line">set winrarfile=&quot;C:\Program Files\WinRAR\winrar.exe&quot;</span><br><span class="line">set appcmdfile=c:\Windows\System32\inetsrv\appcmd.exe</span><br><span class="line">set updateurl=http://downinfo.myhostadmin.net/vps</span><br><span class="line">set baseurl=http://download.myhostadmin.net/win-ssl</span><br><span class="line">set downdir=C:\Users\Administrator\Downloads</span><br><span class="line">set wgetfile=C:\Users\Administrator\Downloads\wget.exe</span><br><span class="line">set sedfile=C:\Users\Administrator\Downloads\sed.rar</span><br><span class="line">set sedexe=C:\Users\Administrator\Downloads\sed\sed.exe</span><br><span class="line"></span><br><span class="line">if not exist %wgetfile% (</span><br><span class="line">    echo.</span><br><span class="line">    echo 缺少wget.exe程序</span><br><span class="line">    ::pause</span><br><span class="line">    echo 正在下载wget.exe必要程序</span><br><span class="line">    bitsadmin.exe /transfer wget /Download /Priority FOREGROUND %baseurl%/wget.exe %downdir%\wget.exe &gt;nul 2&gt;nul</span><br><span class="line">)</span><br><span class="line">if not exist %wgetfile% (</span><br><span class="line">    echo.</span><br><span class="line">    echo 自动下载失败请访问 %baseurl%/wget.exe 手动下载</span><br><span class="line">    echo 并保存到默认下载目录[%downdir%]</span><br><span class="line">    echo.</span><br><span class="line">    pause</span><br><span class="line">    exit</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">if not exist %winrarfile% (</span><br><span class="line">    echo.</span><br><span class="line">    echo 缺少WinRAR解压程序</span><br><span class="line">    echo 请检查安装解压程序后重新运行脚本</span><br><span class="line">    echo.</span><br><span class="line">    pause</span><br><span class="line">    exit</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">:update</span><br><span class="line">cls</span><br><span class="line">%wgetfile% %baseurl%/version.txt -O version.txt &gt;nul 2&gt;nul</span><br><span class="line">title IIS+NGINX反向代理环境部署程序v%ver%</span><br><span class="line">set /p newver=&lt;version.txt</span><br><span class="line">if %newver% gtr %ver% (</span><br><span class="line">    %wgetfile% %baseurl%/updatelog.txt -O updatelog.txt &gt;nul 2&gt;nul</span><br><span class="line">    title IIS+NGINX反向代理环境部署程序v%ver%</span><br><span class="line">    echo.</span><br><span class="line">    echo 当前版本v%ver%，最新版本v%newver%</span><br><span class="line">    echo.</span><br><span class="line">    echo -- 更新日志 --</span><br><span class="line">    for /f &quot;delims=&quot; %%i in (updatelog.txt) do set &quot;updatelog=%%i&quot;&amp;call :logecho !updatelog!</span><br><span class="line">    echo.</span><br><span class="line">    echo 请按任意键更新...</span><br><span class="line">    pause &gt;nul</span><br><span class="line">    %wgetfile% %updateurl%/win-ssl.bat -O win-ssl_v%newver%.bat</span><br><span class="line">    title IIS+NGINX反向代理环境部署程序v%ver%</span><br><span class="line">    cls</span><br><span class="line">    del /f /q &quot;version.txt&quot;</span><br><span class="line">    attrib -h -s -r -a &quot;v%newver%log.txt&quot;</span><br><span class="line">    del /f /q &quot;updatelog.txt&quot;</span><br><span class="line">    attrib -h -s -r -a &quot;%0&quot;</span><br><span class="line">    start win-ssl_v%newver%.bat</span><br><span class="line">    del /f /q &quot;%0&quot;</span><br><span class="line">) </span><br><span class="line">if %newver% equ %ver% (</span><br><span class="line">    cls</span><br><span class="line">    del /f /q &quot;version.txt&quot;</span><br><span class="line">    echo 已是最新版本v%newver%</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">set tmp=0123456789abcdefghijklmnopqrstuvwxyz</span><br><span class="line">for /l %%a in (1,1,8) do (</span><br><span class="line">    set /a &quot;n=!random!%%36&quot;</span><br><span class="line">    for %%z in (!n!) do set webpasswd=!passwd!!tmp:~%%z,1!</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">echo.</span><br><span class="line">echo -- 温馨提示 --</span><br><span class="line">echo.</span><br><span class="line">echo 1、部署前请退出服务器内安装的杀毒软件</span><br><span class="line">echo    安全狗、云锁、360、金山、等安全软件有可能导致SSL证书部署出错</span><br><span class="line">echo 2、主要针对我司申请的SSL证书，如还没有SSL证书，请先申请</span><br><span class="line">echo    其它公司申请的证书可能有所出入，</span><br><span class="line">echo    若部署失败需要自行排查，或提交正确工单我司收费排查。</span><br><span class="line">echo 3、部署之前请做好相关备份，若自行部署失败不承担相关风险和责任。</span><br><span class="line">echo 4、部署前请检查IIS上是否有泛域名绑定，若有请临时取消。</span><br><span class="line">echo 5、推荐将证书文件解压后上传到对应站点目录下，运行脚本自动搜索部署。</span><br><span class="line">echo.</span><br><span class="line">echo 请阅读以上温馨提示，5秒后按任意键继续。</span><br><span class="line">choice /t 5 /d y /n &gt;nul</span><br><span class="line">pause</span><br><span class="line"></span><br><span class="line">call :menu</span><br><span class="line"></span><br><span class="line">:menu</span><br><span class="line">findstr &quot;listen \[::\]:443 ssl http2;&quot; %vhosttemppath% &gt;nul 2&gt;nul &amp;&amp; set ipv6title=关闭IPV6  set ipv6title=开启IPV6</span><br><span class="line">echo   __________________________________________________________</span><br><span class="line">echo  ^                                                          ^</span><br><span class="line">echo  ^        IIS+NGINX反向代理环境部署程序 v%ver%                ^</span><br><span class="line">echo  ^                                                          ^</span><br><span class="line">echo  ^     1 - 安装                   2 - 卸载                  ^</span><br><span class="line">echo  ^     3 - 部署ssl                4 - 更新ssl               ^</span><br><span class="line">echo  ^     5 - %ipv6title%              6 - 退出                  ^</span><br><span class="line">echo  ^                                                          ^</span><br><span class="line">echo  ^__________________________________________________________^</span><br><span class="line">set /p choice=-^&gt; 请选择:</span><br><span class="line">if %choice% ==1 call :install</span><br><span class="line">if %choice% ==2 call :uninstall</span><br><span class="line">if %choice% ==3 call :newsetssl</span><br><span class="line">if %choice% ==4 call :updatessl</span><br><span class="line">if %choice% ==5 call :enableipv6</span><br><span class="line">if %choice% ==6 call :exit</span><br><span class="line">echo.</span><br><span class="line">echo 不能输入除了1、2、3、4、5、6之外的其他字符！&amp; choice /t 1 /d y /n &gt;nul &amp; cls &amp; goto menu</span><br><span class="line"></span><br><span class="line">:install</span><br><span class="line">cls</span><br><span class="line">if exist %nginxpath%\%sname%.exe (</span><br><span class="line">    echo.</span><br><span class="line">    echo 核实已安装Nginx环境，请检查服务是否启动，2s后返回主菜单。</span><br><span class="line">    choice /t 2 /d y /n &gt;nul &amp; cls &amp; goto menu</span><br><span class="line">)</span><br><span class="line">if not exist %nginxpath% (</span><br><span class="line">    mkdir %nginxpath%</span><br><span class="line">    echo 创建目录:%nginxpath%成功</span><br><span class="line">)</span><br><span class="line">if not exist %sslpath% (</span><br><span class="line">    mkdir %sslpath%</span><br><span class="line">    echo 创建目录:%sslpath%成功</span><br><span class="line">)</span><br><span class="line">if not exist %vhostpath% (</span><br><span class="line">    mkdir %vhostpath%</span><br><span class="line">    echo 创建目录:%vhostpath%成功</span><br><span class="line">)</span><br><span class="line">if not exist %nginxpath%\%suser%.rar (</span><br><span class="line">    %wgetfile% %baseurl%/%suser%.rar -O %nginxpath%\%suser%.rar &gt;nul 2&gt;nul</span><br><span class="line">    title IIS+NGINX反向代理环境部署程序v%ver%</span><br><span class="line">    echo 下载文件:%nginxpath%\%suser%.rar成功</span><br><span class="line">)</span><br><span class="line">%winrarfile% x -inul -o+  %nginxpath%\%suser%.rar  %nginxpath%  -y &gt;nul 2&gt;nul</span><br><span class="line">net user %suser% %webpasswd% /add /active:yes &gt;nul 2&gt;nul</span><br><span class="line">sc create %sname% binPath= %nginxpath%\%sname%.exe &gt;nul 2&gt;nul</span><br><span class="line">sc config %sname% start= auto type= share obj= .\%suser% password= %webpasswd% &gt;nul 2&gt;nul</span><br><span class="line">%nginxpath%\ntrights.exe -u %suser% +r SeServiceLogonRight &gt;nul 2&gt;nul</span><br><span class="line"></span><br><span class="line">cacls d:\ /G %suser%:R /E &gt;nul 2&gt;nul</span><br><span class="line">cacls C:\Windows\System32\cmd.exe /G %suser%:R /E &gt;nul 2&gt;nul</span><br><span class="line">echo ycacls %sslpath% /P administrators:F %suser%:F /T &gt;nul 2&gt;nul</span><br><span class="line">echo ycacls %nginxpath% /P administrators:F %suser%:F /T &gt;nul 2&gt;nul</span><br><span class="line">echo 创建用户:%suser%,创建服务:成功</span><br><span class="line">iisreset /stop &gt;nul 2&gt;nul</span><br><span class="line">netsh http add iplisten ipaddress=127.0.0.1 &gt;nul 2&gt;nul</span><br><span class="line"></span><br><span class="line">netsh advfirewall firewall show rule name=&quot;allow443&quot; verbose&gt;tempfw.txt</span><br><span class="line">for /f &quot;delims=&quot; %%a in (tempfw.txt) do ( </span><br><span class="line">    for /f &quot;tokens=1* delims=:&quot; %%i in (&#x27;call echo %%a^find /i &quot;本地端口:&quot;&#x27;) do (</span><br><span class="line">    echo %%a&gt;&quot;tempfwch.txt&quot;</span><br><span class="line">    )  </span><br><span class="line">) </span><br><span class="line">del /s /q tempfw.txt &gt;nul 2&gt;nul</span><br><span class="line">if exist tempfwch.txt ( del /s /q tempfwch.txt &gt;nul 2&gt;nul ) else ( </span><br><span class="line">netsh advfirewall firewall add rule name=&quot;allow%port%&quot; protocol=TCP dir=in localport=%port% action=allow &gt;nul 2&gt;nul</span><br><span class="line">)</span><br><span class="line">regedit /s %nginxpath%\good.reg &gt;nul 2&gt;nul</span><br><span class="line">echo 调整IIS监听,放行443端口,导入优化方案成功</span><br><span class="line">net start %sname%</span><br><span class="line">iisreset /start &gt;nul 2&gt;nul</span><br><span class="line">echo 服务:%sname%启动成功,IIS服务启动成功</span><br><span class="line">echo 安装完成</span><br><span class="line">goto menu</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">:uninstall</span><br><span class="line">if not exist %nginxpath%\%sname%.exe (</span><br><span class="line">    echo.</span><br><span class="line">    echo 没有安装Nginx环境，不需要卸载，2s后返回主菜单。</span><br><span class="line">    choice /t 2 /d y /n &gt;nul &amp; cls &amp; goto menu</span><br><span class="line">)</span><br><span class="line">cls</span><br><span class="line">net stop %sname%</span><br><span class="line">sc delete %sname%</span><br><span class="line">echo 停止删除:%sname%服务成功</span><br><span class="line">cacls d:\ /e /c /r %suser% &gt;nul 2&gt;nul</span><br><span class="line">cacls %nginxpath% /t /e /c /r %suser% &gt;nul 2&gt;nul</span><br><span class="line">cacls %sslpath% /t /e /c /r %suser% &gt;nul 2&gt;nul</span><br><span class="line">net user %suser% /delete</span><br><span class="line">::sc config IISADMIN start= auto</span><br><span class="line">echo 还原:%nginxpath%,%sslpath%权限成功</span><br><span class="line">iisreset /stop</span><br><span class="line">netsh http delete iplisten ipaddress=127.0.0.1</span><br><span class="line">iisreset /start</span><br><span class="line">echo 还原IIS监听成功</span><br><span class="line">rd /s /q %nginxpath% &gt;nul 2&gt;nul</span><br><span class="line">rd /s /q %sslpath% &gt;nul 2&gt;nul</span><br><span class="line">echo 清理:%nginxpath%,%sslpath%目录成功</span><br><span class="line">echo 卸载完成</span><br><span class="line">goto menu</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">:newsetssl</span><br><span class="line">set domain=</span><br><span class="line">set crt1path=</span><br><span class="line">set crt2path=</span><br><span class="line">set keypath=</span><br><span class="line">set /p domain=-^&gt; 请输入域名:</span><br><span class="line">::检查输入是否为空</span><br><span class="line">call :isnul domain, newsetssl</span><br><span class="line">if exist %vhostpath%\%domain%.conf (</span><br><span class="line">    echo 核实已存在对应配置文件，请检查%domain%是否已部署SSL。</span><br><span class="line">    pause &gt;nul</span><br><span class="line">    exit</span><br><span class="line">)</span><br><span class="line">echo 正在部署SSL证书的域名是%domain%...</span><br><span class="line">call :forbiddenip %domain%</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">::检查是否禁止phpmyadmin被反向代理函数</span><br><span class="line">:forbiddenip</span><br><span class="line">if not exist %nginxpath%\%sname%.exe (</span><br><span class="line">    echo.</span><br><span class="line">    echo 没有安装Nginx环境，2s后返回主菜单，请选1安装。</span><br><span class="line">    choice /t 2 /d y /n &gt;nul &amp; cls &amp; goto menu</span><br><span class="line">)</span><br><span class="line">if not exist %sedexe% (</span><br><span class="line">    %wgetfile% %baseurl%/sed.rar -O %sedfile% &gt;nul 2&gt;nul</span><br><span class="line">    %winrarfile% x -inul -o+  %sedfile%  %downdir%  -y &gt;nul 2&gt;nul</span><br><span class="line">    title IIS+NGINX反向代理环境部署程序v%ver%</span><br><span class="line">    echo 下载解压文件:%sedfile%成功</span><br><span class="line">)</span><br><span class="line">::%1就是表示批处理的第一个参数</span><br><span class="line">::%~1表示删除参数外面的引号</span><br><span class="line">for /f &quot;delims=&quot; %%a in (%nginxconf%) do set &quot;a=%%a&quot;&amp;if not &quot;!a!&quot;==&quot;!a:if=!&quot; if not &quot;!a!&quot;==&quot;!a:($host ~* &quot;\d+\.\d+\.\d+\.\d+&quot;)=!&quot; call :setssl %~1</span><br><span class="line">echo.</span><br><span class="line">echo 程序检测未禁止IP访问，为加固安全将自动添加以下规则禁止。</span><br><span class="line">echo.</span><br><span class="line">echo if ($host ~* &quot;\d+\.\d+\.\d+\.\d+&quot;) &#123;</span><br><span class="line">echo    return 403;</span><br><span class="line">echo &#125;</span><br><span class="line">echo.</span><br><span class="line">%sedexe% -i &quot;/listen/a\        if ($host ~* \&quot;\\d+\\.\\d+\\.\\d+\\.\\d+\&quot;) &#123;&quot; %nginxconf%</span><br><span class="line">%sedexe% -i &quot;/if/a\            return 403;&quot; %nginxconf%</span><br><span class="line">%sedexe% -i &quot;/return 403;/a\       &#125;&quot; %nginxconf%</span><br><span class="line">::C:\Windows\system32\net stop %sname%</span><br><span class="line">::C:\Windows\system32\net start %sname%</span><br><span class="line">::安装后一起重载nginx服务</span><br><span class="line">for /f &quot;delims=&quot; %%j in (&#x27;dir /b /a-d &quot;sed*&quot;&#x27;) do del %%j</span><br><span class="line">call :setssl %~1</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">::一键更新SSL证书函数</span><br><span class="line">:updatessl</span><br><span class="line">set domain=</span><br><span class="line">set crt1path=</span><br><span class="line">set crt2path=</span><br><span class="line">set keypath=</span><br><span class="line">set /p domain=-^&gt; 请输入域名:</span><br><span class="line">call :isnul domain, updatessl</span><br><span class="line">if not exist %vhostpath%\%domain%.conf (</span><br><span class="line">    echo 核实不存在%domain%配置文件，请检查是否已部署SSL。</span><br><span class="line">    pause &gt;nul</span><br><span class="line">    exit</span><br><span class="line">)</span><br><span class="line">echo 正在更新SSL证书的域名是%domain%...</span><br><span class="line">call :setssl %domain%</span><br><span class="line"></span><br><span class="line">::新安装ssl证书函数</span><br><span class="line">:setssl</span><br><span class="line">set domain=%~1</span><br><span class="line">echo %domain%</span><br><span class="line">for /f &quot;tokens=2 delims= &quot; %%a in (&#x27;%appcmdfile% list site http://%domain%&#x27;) do (set &quot;ftpnametemp=%%a&quot;) </span><br><span class="line">set ftpname=%ftpnametemp:~1,-1%</span><br><span class="line">for /f %%i in (&#x27;%appcmdfile% list vdirs /app.name:%ftpname%/ /text:physicalPath&#x27;) do @set webpath=%%i</span><br><span class="line"></span><br><span class="line">:crtflg</span><br><span class="line">if not exist %webpath%\%domain%.crt (</span><br><span class="line">    echo 请输入证书文件[%domain%.crt]的绝对路径</span><br><span class="line">    set /p crtpath=-^&gt;</span><br><span class="line">    call :isnul crtpath,crtflg</span><br><span class="line">    call :crtpath </span><br><span class="line">) else ( </span><br><span class="line">    echo.</span><br><span class="line">    echo 在%domain%网站根目录找到证书文件</span><br><span class="line">    echo [%webpath%\%domain%.crt]</span><br><span class="line">    set crtpath=%webpath%\%domain%.crt</span><br><span class="line">)</span><br><span class="line">set crtpathtemp=%crtpath:~0,-4%</span><br><span class="line">set keypathtemp=%crtpathtemp%.key</span><br><span class="line"></span><br><span class="line">:keyflg</span><br><span class="line">if not exist %keypathtemp% (</span><br><span class="line">    echo 请输入秘钥文件[%domain%.key]的绝对路径</span><br><span class="line">    set /p keypath=-^&gt;</span><br><span class="line">    call :isnul keypath,keyflg</span><br><span class="line">    call :keypath </span><br><span class="line">) else ( </span><br><span class="line">    echo.</span><br><span class="line">    echo 在证书文件1的目录找到秘钥文件</span><br><span class="line">    echo [%keypathtemp%]</span><br><span class="line">    set keypath=%keypathtemp%</span><br><span class="line">    echo.</span><br><span class="line">)</span><br><span class="line">C:\Windows\system32\more &quot;%crtpath%&quot; &gt; &quot;%sslpath%\%domain%.crt&quot;</span><br><span class="line">copy &quot;%keypath%&quot; &quot;%sslpath%\%domain%.key&quot; &gt;nul 2&gt;nul</span><br><span class="line">if not exist %vhosttemppath% (</span><br><span class="line">    echo 找不到nginx模板配置文件%vhosttemppath%，程序将自动退出。</span><br><span class="line">    pause &gt;nul</span><br><span class="line">    exit</span><br><span class="line">)</span><br><span class="line">copy &quot;%vhosttemppath%&quot; &quot;%vhostpath%\%domain%.conf&quot; &gt;nul 2&gt;nul</span><br><span class="line">set sslvhostpath=%vhostpath%\%domain%.conf</span><br><span class="line">set sslpathtemp=d:/ssl</span><br><span class="line">set crt=%sslpathtemp%/%domain%.crt</span><br><span class="line">set key=%sslpathtemp%/%domain%.key</span><br><span class="line"></span><br><span class="line">%sedexe% -i &quot;/listen/a\    server_name %domain%;&quot; %sslvhostpath%</span><br><span class="line">%sedexe% -i &quot;/server_name/a\   ssl_certificate %crt%;&quot; %sslvhostpath%</span><br><span class="line">%sedexe% -i &quot;/ssl_certificate/a\   ssl_certificate_key %key%;&quot; %sslvhostpath%</span><br><span class="line">C:\Windows\system32\net stop %sname%</span><br><span class="line">C:\Windows\system32\net start %sname%</span><br><span class="line">for /f &quot;delims=&quot; %%j in (&#x27;dir /b /a-d &quot;sed*&quot;&#x27;) do del %%j  </span><br><span class="line">echo 安装完成，请关闭窗口</span><br><span class="line">echo 站点配置文件：%sslvhostpath%</span><br><span class="line">echo 证书文件路径：%sslpath%\%domain%.crt</span><br><span class="line">echo               %sslpath%\%domain%.key</span><br><span class="line">goto menu</span><br><span class="line">::goto:eof cmd返回并将等待下一命令</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">:crtpath</span><br><span class="line">if not exist %crtpath% ( </span><br><span class="line">    echo %crtpath% 不是有效证书文件</span><br><span class="line">    set /p crtpath=-^&gt;</span><br><span class="line">    call :crtpath</span><br><span class="line">)</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">:keypath</span><br><span class="line">if not exist %keypath% ( </span><br><span class="line">    echo %keypath% 不是有效秘钥文件</span><br><span class="line">    set /p keypath=-^&gt;</span><br><span class="line">    call :keypath</span><br><span class="line">)</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">:logecho</span><br><span class="line">echo %1</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">:isnul</span><br><span class="line">if not defined %~1 ( </span><br><span class="line">    echo 输入为空，请重新输入。</span><br><span class="line">    goto %~2</span><br><span class="line">)</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">:enableipv6</span><br><span class="line">%sedexe% -i &quot;/listen/a\        listen [::]:80;&quot; %nginxconf%</span><br><span class="line">%sedexe% -i &quot;/listen/a\    listen [::]:443 ssl http2;&quot; %vhosttemppath%</span><br><span class="line">echo 开启IPV6成功</span><br><span class="line">goto menu</span><br><span class="line">goto:eof</span><br><span class="line"></span><br><span class="line">:exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/04/14/nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86iis%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2https/" data-id="clc4klg69006fojob8o1shx8u" data-title="Nginx反向代理IIS一键部署https" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-1分钟教会你标准的shell脚本" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/14/1%E5%88%86%E9%92%9F%E6%95%99%E4%BC%9A%E4%BD%A0%E6%A0%87%E5%87%86%E7%9A%84shell%E8%84%9A%E6%9C%AC/" class="article-date">
  <time class="dt-published" datetime="2017-04-14T06:50:09.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/yunwei-tools/">yunwei-tools</a>►<a class="article-category-link" href="/categories/yunwei-tools/Shell/">Shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/14/1%E5%88%86%E9%92%9F%E6%95%99%E4%BC%9A%E4%BD%A0%E6%A0%87%E5%87%86%E7%9A%84shell%E8%84%9A%E6%9C%AC/">1分钟教会你标准的shell脚本</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>#!&#x2F;bin&#x2F;bash<br>#######################################################</p>
<h1 id="Name-shell-template-sh"><a href="#Name-shell-template-sh" class="headerlink" title="$Name:         shell_template.sh"></a>$Name:         shell_template.sh</h1><h1 id="Version-v1-0"><a href="#Version-v1-0" class="headerlink" title="$Version:      v1.0"></a>$Version:      v1.0</h1><h1 id="Function-Introduce-Function-Template-Script"><a href="#Function-Introduce-Function-Template-Script" class="headerlink" title="$Function:     Introduce Function Template Script"></a>$Function:     Introduce Function Template Script</h1><h1 id="Author-Ropon"><a href="#Author-Ropon" class="headerlink" title="$Author:       Ropon"></a>$Author:       Ropon</h1><h1 id="organization-https-www-west-cn"><a href="#organization-https-www-west-cn" class="headerlink" title="$organization: https://www.west.cn"></a>$organization: <a target="_blank" rel="noopener" href="https://www.west.cn/">https://www.west.cn</a></h1><h1 id="Create-Date-2016-1-20"><a href="#Create-Date-2016-1-20" class="headerlink" title="$Create Date:  2016-1-20"></a>$Create Date:  2016-1-20</h1><h1 id="Description-You-know-what-i-mean-hehe"><a href="#Description-You-know-what-i-mean-hehe" class="headerlink" title="$Description:  You know what i mean,hehe"></a>$Description:  You know what i mean,hehe</h1><p>#######################################################</p>
<h1 id="Shell-Env"><a href="#Shell-Env" class="headerlink" title="Shell Env"></a>Shell Env</h1><p>SHELL_NAME&#x3D;”shell_template.sh”<br>SHELL_DIR&#x3D;”&#x2F;root”<br>SHELL_LOG&#x3D;”${SHELL_DIR}&#x2F;${SHELL_NAME}.log”<br>LOCK_FILE&#x3D;”&#x2F;tmp&#x2F;${SHELL_NAME}.lock”<br>#Write Log<br>shell_log(){<br>    LOG_INFO&#x3D;$1<br>    echo “$(date “+%Y-%m-%d”) $(date “+%H-%M-%S”) : ${SHELL_NAME} : ${LOG_INFO}” &gt;&gt; ${SHELL_LOG}<br>}</p>
<h1 id="Shell-Usage"><a href="#Shell-Usage" class="headerlink" title="Shell Usage"></a>Shell Usage</h1><p>shell_usage(){<br>    echo $”Usage: $0 {backup}”<br>}<br>shell_lock(){<br>    touch ${LOCK_FILE}<br>}<br>shell_unlock(){<br>    rm -f ${LOCK_FILE}<br>}</p>
<h1 id="Backup-MySQL-All-Database-with-mysqldump-or-innobackupex"><a href="#Backup-MySQL-All-Database-with-mysqldump-or-innobackupex" class="headerlink" title="Backup MySQL All Database with mysqldump or innobackupex"></a>Backup MySQL All Database with mysqldump or innobackupex</h1><p>funcname(){<br>    if [ -f “$LOCK_FILE” ];then<br>        shell_log “${SHELL_NAME} is running”<br>        echo “${SHELL_NAME}” is running &amp;&amp; exit<br>    fi<br>    shell_log “mysql backup start”<br>    shell_lock<br>    sleep 10<br>    shell_log “mysql backup stop”<br>    shell_unlock<br>}</p>
<h1 id="Main-Function"><a href="#Main-Function" class="headerlink" title="Main Function"></a>Main Function</h1><p>main(){<br>    case $1 in<br>        backup)<br>            funcname<br>            ;;<br>        *)<br>            shell_usage;<br>    esac<br>}<br>#Exec<br>main $1</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/04/14/1%E5%88%86%E9%92%9F%E6%95%99%E4%BC%9A%E4%BD%A0%E6%A0%87%E5%87%86%E7%9A%84shell%E8%84%9A%E6%9C%AC/" data-id="clc4klg42000jojob12ymancb" data-title="1分钟教会你标准的shell脚本" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-wdcp一键开启php-ioncube加密扩展" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/13/wdcp%E4%B8%80%E9%94%AE%E5%BC%80%E5%90%AFphp-ioncube%E5%8A%A0%E5%AF%86%E6%89%A9%E5%B1%95/" class="article-date">
  <time class="dt-published" datetime="2017-04-13T15:29:20.000Z" itemprop="datePublished">2017-04-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/yunwei-tools/">yunwei-tools</a>►<a class="article-category-link" href="/categories/yunwei-tools/Shell/">Shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/13/wdcp%E4%B8%80%E9%94%AE%E5%BC%80%E5%90%AFphp-ioncube%E5%8A%A0%E5%AF%86%E6%89%A9%E5%B1%95/">wdcp一键开启php_ioncube加密扩展</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p># 1、一键开启 # 2、自适应php5.2-php7.0 # 3、自适应apache、nginx及系统版本</p>
<p>#!&#x2F;bin&#x2F;bash<br>#######################################################</p>
<h1 id="Name-ioncube-sh"><a href="#Name-ioncube-sh" class="headerlink" title="$Name:         ioncube.sh"></a>$Name:         ioncube.sh</h1><h1 id="Version-v1-0"><a href="#Version-v1-0" class="headerlink" title="$Version:      v1.0"></a>$Version:      v1.0</h1><h1 id="Function-wdcp一键开启php-ioncube加密扩展"><a href="#Function-wdcp一键开启php-ioncube加密扩展" class="headerlink" title="$Function:     wdcp一键开启php_ioncube加密扩展"></a>$Function:     wdcp一键开启php_ioncube加密扩展</h1><h1 id="Author-Ropon"><a href="#Author-Ropon" class="headerlink" title="$Author:       Ropon"></a>$Author:       Ropon</h1><h1 id="organization-west-cn"><a href="#organization-west-cn" class="headerlink" title="$organization: west.cn"></a>$organization: west.cn</h1><h1 id="Create-Date-2017-3-10"><a href="#Create-Date-2017-3-10" class="headerlink" title="$Create Date:  2017-3-10"></a>$Create Date:  2017-3-10</h1><h1 id="Description-1、一键开启"><a href="#Description-1、一键开启" class="headerlink" title="$Description:  1、一键开启"></a>$Description:  1、一键开启</h1><h1 id="2、自适应php5-2-php7-0"><a href="#2、自适应php5-2-php7-0" class="headerlink" title="2、自适应php5.2-php7.0"></a>2、自适应php5.2-php7.0</h1><h1 id="3、自适应apache、nginx及系统版本"><a href="#3、自适应apache、nginx及系统版本" class="headerlink" title="3、自适应apache、nginx及系统版本"></a>3、自适应apache、nginx及系统版本</h1><p>#######################################################</p>
<p>php_install_dir&#x3D;&#x2F;www&#x2F;wdlinux&#x2F;php<br>PHP_version&#x3D;`$php_install_dir&#x2F;bin&#x2F;php -r ‘echo PHP_VERSION;’`<br>Ver&#x3D;${PHP_version%.*}</p>
<p>if [ “$(getconf WORD_BIT)” &#x3D;&#x3D; “32” ] &amp;&amp; [ “$(getconf LONG_BIT)” &#x3D;&#x3D; “64” ]; then<br>  OS_BIT&#x3D;64<br>else<br>  OS_BIT&#x3D;32<br>fi<br>inifile&#x3D;`$php_install_dir&#x2F;bin&#x2F;php -inigrep ‘php.ini’awk ‘{print $6}’`&#x2F;php.ini<br>temp&#x3D;`grep -E ‘\[ionCube Loader\]‘ $inifile`</p>
<p>if  [ ! -n “$temp” ] ;then<br>if [ ! -f ioncube_loader_lin.so ];then<br>case “${OS_BIT}” in<br>64)<br>wget -O ioncube_loader_lin.so -c <a target="_blank" rel="noopener" href="http://download.myhostadmin.net/php/ioncube/ioncube/_loader/_lin/_$%7BVer%7D.so">http://download.myhostadmin.net/php/ioncube/ioncube\_loader\_lin\_${Ver}.so</a><br>;;<br>32)<br>wget -O ioncube_loader_lin.so -c <a target="_blank" rel="noopener" href="http://download.myhostadmin.net/php/ioncube/ioncube/_loader/_lin/_x86/_$%7BVer%7D.so">http://download.myhostadmin.net/php/ioncube/ioncube\_loader\_lin\_x86\_${Ver}.so</a><br>;;<br>*)<br>echo “Error!”<br>exit 1<br>;;<br>esac<br>fi<br>[ ! -d “`$php_install_dir&#x2F;bin&#x2F;php-config –extension-dir`“ ] &amp;&amp; mkdir -p `$php_install_dir&#x2F;bin&#x2F;php-config –extension-dir`<br>&#x2F;bin&#x2F;cp ioncube_loader_lin.so `$php_install_dir&#x2F;bin&#x2F;php-config –extension-dir`<br>zend_extension&#x3D;”`$php_install_dir&#x2F;bin&#x2F;php-config –extension-dir`&#x2F;ioncube_loader_lin.so”<br>rm -rf ioncube_loader_lin.so<br>sed -i “&#x2F;^\[PHP&#x2F;i\[ionCube Loader]“ $inifile<br>sed -i “&#x2F;^\[ionCube&#x2F;a\zend_extension&#x3D;$zend_extension” $inifile<br>num&#x3D;`ps -efgrep -w “nginx”grep -v grepwc -l`<br>if [ ${num} -eq 0 ] ;then<br>service httpd restart<br>else<br>service httpd restart<br>service php-fpm restart<br>fi<br>echo<br>echo “ioncube install is OK”<br>echo<br>else<br>echo<br>echo “Error! ioncube install is OK?”<br>echo<br>exit 1<br>fi</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/04/13/wdcp%E4%B8%80%E9%94%AE%E5%BC%80%E5%90%AFphp-ioncube%E5%8A%A0%E5%AF%86%E6%89%A9%E5%B1%95/" data-id="clc4klg7b009lojobf0tyapsc" data-title="wdcp一键开启php_ioncube加密扩展" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-基于nginx一键部署https" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/13/%E5%9F%BA%E4%BA%8Enginx%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2https/" class="article-date">
  <time class="dt-published" datetime="2017-04-13T15:28:14.000Z" itemprop="datePublished">2017-04-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/yunwei-tools/">yunwei-tools</a>►<a class="article-category-link" href="/categories/yunwei-tools/Shell/">Shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/13/%E5%9F%BA%E4%BA%8Enginx%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2https/">基于Nginx一键部署https</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="基于Nginx一键部署https"><a href="#基于Nginx一键部署https" class="headerlink" title="基于Nginx一键部署https"></a>基于Nginx一键部署https</h4><ul>
<li>1、基于nginx自动部署https，自动设置301</li>
<li>2、自动判断是否升级nginx和openssl</li>
<li>3、支持wdcph环境或其他已安装好nginx环境</li>
<li>4、部署后nginx配置文件推荐放到&#x2F;home&#x2F;nginx-vhost&#x2F;目录下(可选)</li>
<li>5、证书路径&#x2F;home&#x2F;ssl 以域名命名<a target="_blank" rel="noopener" href="http://www.test.com.crt/">www.test.com.crt</a> <a target="_blank" rel="noopener" href="http://www.test.com.key/">www.test.com.key</a></li>
<li>6、部署后nginx站点配置文件名为test.com_ssl.conf</li>
</ul>
<h4 id="具体代码"><a href="#具体代码" class="headerlink" title="具体代码"></a>具体代码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></td><td class="code"><pre><span class="line">SHELL_NAME=&quot;nginx-ssl.sh&quot;</span><br><span class="line">SHELL_DIR=&quot;/root&quot;</span><br><span class="line">SHELL_LOG=&quot;$&#123;SHELL_DIR&#125;/$&#123;SHELL_NAME&#125;.log&quot;</span><br><span class="line">LOCK_FILE=&quot;/tmp/$&#123;SHELL_NAME&#125;.lock&quot;</span><br><span class="line">function myi18n()&#123;</span><br><span class="line">    if [[ &quot;$#&quot; -ne 1 ]]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;demo&quot;</span><br><span class="line">    fi</span><br><span class="line">    if [[ $LANG =~ [Uu][Tt][Ff] ]]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;$1&quot; </span><br><span class="line">    else</span><br><span class="line">        echo &quot;$1&quot;  iconv -f utf-8 -t gbk</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">#Write Log </span><br><span class="line">shell_log()&#123;</span><br><span class="line">    LOG_INFO=$1</span><br><span class="line">    myi18n &quot;$(date &quot;+%Y-%m-%d&quot;) $(date &quot;+%H-%M-%S&quot;) : $&#123;SHELL_NAME&#125; : $&#123;LOG_INFO&#125;&quot; &gt;&gt; $&#123;SHELL_LOG&#125;</span><br><span class="line">&#125;</span><br><span class="line">shell_lock()&#123;</span><br><span class="line">    touch $&#123;LOCK_FILE&#125;</span><br><span class="line">&#125;</span><br><span class="line">shell_unlock()&#123;</span><br><span class="line">    rm -f $&#123;LOCK_FILE&#125;</span><br><span class="line">&#125;</span><br><span class="line">end()&#123;</span><br><span class="line">    shell_unlock</span><br><span class="line">    exit</span><br><span class="line">&#125;</span><br><span class="line">shell_log &quot;信息：脚本开始运行&quot;</span><br><span class="line">if [ -f &quot;$LOCK_FILE&quot; ];then</span><br><span class="line">    shell_log &quot;$&#123;SHELL_NAME&#125; 脚本正在运行中，若不是请使用 rm -rf /tmp/nginx-ssl.sh.lock 命令清理锁文件&quot;</span><br><span class="line">    myi18n &quot;$&#123;SHELL_NAME&#125; 脚本正在运行中，若不是请使用 rm -rf /tmp/nginx-ssl.sh.lock 命令清理锁文件&quot; &amp;&amp; exit</span><br><span class="line">fi</span><br><span class="line">shell_lock</span><br><span class="line">homeconfpath=/home/nginx-ssl/conf</span><br><span class="line">if [ ! -d &quot;$homeconfpath&quot; ];then</span><br><span class="line">    myi18n &quot;请输入nginx安装路径，比如：/usr/local/nginx&quot;</span><br><span class="line">    myi18n &quot;如果使用wdcp环境，请直接回车&quot;</span><br><span class="line">    read -p &quot;: &quot; confpath</span><br><span class="line">    if [ -z &quot;$confpath&quot; ] ;then</span><br><span class="line">        confpath=/www/wdlinux/nginx</span><br><span class="line">    fi</span><br><span class="line">    confpath1=$&#123;confpath&#125;/conf</span><br><span class="line">    while [ ! -d &quot;$confpath1&quot; ] </span><br><span class="line">    do</span><br><span class="line">        myi18n &quot;您输入路径$&#123;confpath1&#125;不存在，请重新输入&quot;</span><br><span class="line">        shell_log &quot;错误：您输入路径$&#123;confpath1&#125;不存在，请重新输入&quot;</span><br><span class="line">        read -p &quot;: &quot; confpath</span><br><span class="line">        if [ -z &quot;$confpath&quot; ] ;then</span><br><span class="line">            confpath=/www/wdlinux/nginx</span><br><span class="line">        fi</span><br><span class="line">        confpath1=$&#123;confpath&#125;/conf</span><br><span class="line">    done</span><br><span class="line">    temp=`find $confpath1 -maxdepth 1 -name &#x27;nginx.conf&#x27;`</span><br><span class="line">    while ([ -z $temp ]  [ ! -f &quot;$temp&quot; ]) </span><br><span class="line">    do</span><br><span class="line">        myi18n &quot;nginx安装路径不对，请重新输入&quot;</span><br><span class="line">        shell_log &quot;错误：$&#123;confpath1&#125; 路径下没有找到nginx.conf，请检查&quot;</span><br><span class="line">        echo</span><br><span class="line">        read -p &quot;: &quot; confpath</span><br><span class="line">        if [ -z $confpath ] ;then</span><br><span class="line">            confpath=/www/wdlinux/nginx</span><br><span class="line">            wdcp=y</span><br><span class="line">        fi</span><br><span class="line">        confpath1=$&#123;confpath&#125;/conf</span><br><span class="line">        temp=`find $confpath1 -maxdepth 1 -name &#x27;nginx.conf&#x27;`</span><br><span class="line">    done</span><br><span class="line">    shell_log &quot;信息：nginx配置文件路径 $&#123;confpath1&#125;&quot;</span><br><span class="line">    myi18n &quot;是否一键移动nginx配置文件到/home/nginx目录下并创建好软连接&quot;</span><br><span class="line">    read -p &quot;[y/n]: &quot; conf_move</span><br><span class="line">    while [[ ! $conf_move =~ ^[y,n]$ ]] </span><br><span class="line">    do</span><br><span class="line">        echo &quot;input error! Please only input &#x27;y&#x27; or &#x27;n&#x27;&quot;</span><br><span class="line">        echo</span><br><span class="line">        read -p &quot;[y/n]: &quot; conf_move</span><br><span class="line">    done</span><br><span class="line">    if [ &quot;$conf_move&quot; == &#x27;y&#x27; ] ;then</span><br><span class="line">        if [ ! -d &quot;$homeconfpath&quot; ];then</span><br><span class="line">            mkdir -p $homeconfpath</span><br><span class="line">            cp -rf $&#123;confpath&#125;/conf/* $homeconfpath</span><br><span class="line">            cd $confpath</span><br><span class="line">            mv conf/ conf-bak/</span><br><span class="line">            ln -sf $homeconfpath conf</span><br><span class="line">            if [ &quot;$wdcp&quot; == &#x27;y&#x27; ] ;then</span><br><span class="line">                chown wdcpu.wdcpg $homeconfpath -R</span><br><span class="line">            fi</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        homeconfpath=$&#123;confpath&#125;/conf</span><br><span class="line">    fi</span><br><span class="line">else    </span><br><span class="line">    echo</span><br><span class="line">    myi18n &quot;自动搜索到：nginx配置文件路径为 $&#123;homeconfpath&#125;&quot;</span><br><span class="line">    shell_log &quot;信息：自动搜索到：nginx配置文件路径为 $&#123;homeconfpath&#125;&quot;</span><br><span class="line">    echo    </span><br><span class="line">fi</span><br><span class="line">if [ -d &quot;/www/wdlinux/nginx&quot; ] ;then</span><br><span class="line">    wdcp=y</span><br><span class="line">    myi18n &quot;使用wdcp环境，nginx版本为&quot;</span><br><span class="line">    /www/wdlinux/nginx/sbin/nginx -v 2&gt;&amp;1awk -F &#x27;/&#x27; &#x27;&#123;print $2&#125;&#x27;</span><br><span class="line">    shell_log &quot;信息：当前使用wdcp环境&quot;</span><br><span class="line">fi</span><br><span class="line">shell_log &quot;信息：nginx的vhost文件路径 $&#123;homeconfpath&#125;&quot;</span><br><span class="line">homesslpath=/home/ssl</span><br><span class="line">[ ! -d &quot;$homesslpath&quot; ] &amp;&amp; mkdir -p $homesslpath</span><br><span class="line">shell_log &quot;信息：ssl证书存放路径 $&#123;homesslpath&#125;&quot;</span><br><span class="line">pushd $&#123;homeconfpath&#125;/vhost/</span><br><span class="line"></span><br><span class="line">myi18n &quot;请输入需要安装证书站点绑定的域名，比如：www.test.com&quot;</span><br><span class="line">myi18n &quot;如果二级域名有绑定到其他站点，请使用www.test.com，不要输入顶级域名&quot;</span><br><span class="line">read -p &quot;: &quot; domain</span><br><span class="line">while [ -z $domain ] </span><br><span class="line">do</span><br><span class="line">    myi18n &quot;域名不能为空，请重新输入。&quot;</span><br><span class="line">    echo</span><br><span class="line">    read -p &quot;: &quot; domain</span><br><span class="line">done</span><br><span class="line">files=`grep -l &quot; $&#123;domain&#125;&quot; *.confawk &#x27;NR==1&#123;print&#125;&#x27;sed &#x27;s/\.conf//&#x27;`</span><br><span class="line">if  [ ! -n &quot;$files&quot; ] ;then</span><br><span class="line">    echo</span><br><span class="line">    echo $&#123;domain&#125;</span><br><span class="line">    myi18n &quot;关联站点，没有找到！&quot;</span><br><span class="line">    shell_log &quot;警告：没有找到域名 $&#123;domain&#125; 对应配置文件&quot;</span><br><span class="line">    echo</span><br><span class="line">    end 1</span><br><span class="line">fi</span><br><span class="line">files1=$&#123;homeconfpath&#125;/vhost/$&#123;files&#125;.conf</span><br><span class="line">shell_log &quot;信息：要部署域名 $&#123;domain&#125; 的配置文件是  $&#123;files1&#125;&quot;</span><br><span class="line">sslfile=$&#123;homeconfpath&#125;/vhost/$&#123;files&#125;_ssl.conf</span><br><span class="line">if [ -f &quot;$sslfile&quot; ];then</span><br><span class="line">    crt=`grep -E &#x27;ssl_certificate&#x27; $&#123;sslfile&#125;awk -F &#x27;ssl_certificate &#x27; &#x27;&#123;print $2&#125;&#x27;awk &#x27;NR==1&#123;print&#125;&#x27;sed &#x27;s/\;//&#x27;`</span><br><span class="line">    key=`grep -E &#x27;ssl_certificate_key&#x27; $&#123;sslfile&#125;awk -F &#x27;ssl_certificate_key &#x27; &#x27;&#123;print $2&#125;&#x27;sed &#x27;s/\;//&#x27;`</span><br><span class="line">    if [ -f &quot;$crt&quot; ] &amp;&amp; [ -f &quot;$key&quot; ];then</span><br><span class="line">        echo</span><br><span class="line">        echo $&#123;domain&#125;</span><br><span class="line">        myi18n &quot;关联站点证书已安装！&quot;</span><br><span class="line">        shell_log &quot;警告：域名 $&#123;domain&#125; 已成功部署&quot;</span><br><span class="line">        echo</span><br><span class="line">        end 1</span><br><span class="line">    fi</span><br><span class="line">    echo</span><br><span class="line">    echo $&#123;domain&#125;</span><br><span class="line">    myi18n &quot;关联站点ssl配置文件已存在，是否需要删除？&quot;</span><br><span class="line">    read -p &quot;[y/n]: &quot; ssl_check</span><br><span class="line">    while [[ ! $ssl_check =~ ^[y,n]$ ]] </span><br><span class="line">    do</span><br><span class="line">        echo &quot;input error! Please only input &#x27;y&#x27; or &#x27;n&#x27;&quot;</span><br><span class="line">        echo</span><br><span class="line">        read -p &quot;[y/n]: &quot; ssl_check</span><br><span class="line">    done</span><br><span class="line">    if [ &quot;$ssl_check&quot; == &#x27;y&#x27; ];then</span><br><span class="line">        rm -rf $sslfile</span><br><span class="line">    else</span><br><span class="line">        echo</span><br><span class="line">        echo $&#123;domain&#125;</span><br><span class="line">        myi18n &quot;已存在ssl配置文件，请核实后重新运行程序。&quot;</span><br><span class="line">        shell_log &quot;警告：要部署域名 $&#123;domain&#125; 已存在部署后配置文件 $&#123;sslfile&#125;&quot;</span><br><span class="line">        end 1</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line">temp12=`grep -E &#x27;https://&#x27; $&#123;files1&#125;`</span><br><span class="line">if  [ -n &quot;$temp12&quot; ] ;then</span><br><span class="line">    echo</span><br><span class="line">    echo $&#123;domain&#125;</span><br><span class="line">    myi18n &quot;对应配置文件存在301转向(return 301)，是否需要删除？&quot;</span><br><span class="line">    read -p &quot;[y/n]: &quot; s_check</span><br><span class="line">    while [[ ! $s_check =~ ^[y,n]$ ]] </span><br><span class="line">    do</span><br><span class="line">        echo &quot;input error! Please only input &#x27;y&#x27; or &#x27;n&#x27;&quot;</span><br><span class="line">        echo</span><br><span class="line">        read -p &quot;[y/n]: &quot; s_check</span><br><span class="line">    done</span><br><span class="line">    if [ &quot;$s_check&quot; == &#x27;y&#x27; ];then</span><br><span class="line">        sed -i &#x27;/^.*return.*301 https/d&#x27; $files1</span><br><span class="line">    else</span><br><span class="line">        echo</span><br><span class="line">        echo $&#123;domain&#125;</span><br><span class="line">        myi18n &quot;域名 $&#123;domain&#125; 对应配置文件$&#123;files&#125;存在301转向，请先删除对应行&quot;</span><br><span class="line">        shell_log &quot;警告：域名 $&#123;domain&#125; 对应配置文件$&#123;files&#125;存在301转向，请先删除对应行&quot;</span><br><span class="line">        end 1</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line">crt1=$&#123;homesslpath&#125;/$&#123;domain&#125;.crt</span><br><span class="line">key1=$&#123;homesslpath&#125;/$&#123;domain&#125;.key</span><br><span class="line">if [ ! -f &quot;$crt1&quot; ];then</span><br><span class="line">    myi18n &quot;我司申请在nginx上部署需要先合并，请输入y或者n？&quot;</span><br><span class="line">    read -p &quot;[y/n]: &quot; crt_yn</span><br><span class="line">    while [[ ! $crt_yn =~ ^[y,n]$ ]] </span><br><span class="line">    do</span><br><span class="line">        echo &quot;input error! Please only input &#x27;y&#x27; or &#x27;n&#x27;&quot;</span><br><span class="line">        echo</span><br><span class="line">        read -p &quot;[y/n]: &quot; crt_yn</span><br><span class="line">    done</span><br><span class="line">    if [ &quot;$crt_yn&quot; == &#x27;y&#x27; ] ;then</span><br><span class="line">        myi18n &quot;请输入cer证书路径，比如 /root/test.com.cer&quot;</span><br><span class="line">        myi18n &quot;/root/test.com.cer&quot;</span><br><span class="line">        read -p &quot;Please reinput crtpath1 : &quot; crtpath1</span><br><span class="line">        while ([ -z &quot;$crtpath1&quot; ]  [ ! -f &quot;$crtpath1&quot; ]) </span><br><span class="line">        do</span><br><span class="line">            myi18n &quot;需要合并证书1不能为空或路径错误，请重新输入。&quot;</span><br><span class="line">            shell_log &quot;警告：需要合并证书1 $&#123;crtpath1&#125; 为空或路径错误&quot;</span><br><span class="line">            echo</span><br><span class="line">            read -p &quot;: &quot; crtpath1</span><br><span class="line">        done</span><br><span class="line">        pathtemp=`echo $crtpath1awk -F &#x27;.cer&#x27; &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">        crtpath2temp=$&#123;pathtemp&#125;_ca.crt</span><br><span class="line">        keypathtemp=$&#123;pathtemp&#125;.key</span><br><span class="line">        echo $crtpath2temp</span><br><span class="line">        echo $keypathtemp</span><br><span class="line">        if [ ! -f &quot;$crtpath2temp&quot; ];then</span><br><span class="line">            myi18n &quot;/root/test.com_ca.crt&quot;</span><br><span class="line">            read -p &quot;Please reinput crtpath2 : &quot; crtpath2</span><br><span class="line">            while ([ -z &quot;$crtpath2&quot; ]  [ ! -f &quot;$crtpath2&quot; ]) </span><br><span class="line">            do</span><br><span class="line">                myi18n &quot;需要合并证书2不能为空或路径错误，请重新输入。&quot;</span><br><span class="line">                shell_log &quot;警告：需要合并证书2 $&#123;crtpath2&#125; 为空或路径错误&quot;</span><br><span class="line">                echo</span><br><span class="line">                read -p &quot;: &quot; crtpath2</span><br><span class="line">            done</span><br><span class="line">        else</span><br><span class="line">            crtpath2=$crtpath2temp</span><br><span class="line">            echo</span><br><span class="line">            myi18n &quot;自动搜索到：域名 $&#123;domain&#125; 证书cacrt文件路径为 $&#123;crtpath2temp&#125;&quot;</span><br><span class="line">            myi18n &quot;系统会自动补全合并为~/$&#123;domain&#125;.crt&quot;</span><br><span class="line">            shell_log &quot;自动搜索到：域名 $&#123;domain&#125; 证书cacrt文件路径为 $&#123;crtpath2temp&#125;&quot;</span><br><span class="line">            echo</span><br><span class="line">        fi</span><br><span class="line">        shell_log &quot;信息：域名 $&#123;domain&#125; 需要合并证书1 $&#123;crtpath1&#125;&quot;</span><br><span class="line">        shell_log &quot;信息：域名 $&#123;domain&#125; 需要合并证书2 $&#123;crtpath2&#125;&quot;</span><br><span class="line">        cat $crtpath1 $crtpath2 &gt;&gt; ~/$domain.crt</span><br><span class="line">        crtpath=~/$&#123;domain&#125;.crt</span><br><span class="line">    else</span><br><span class="line">        myi18n &quot;请输入需要安装证书路径:eg /root/test.com.crt&quot;</span><br><span class="line">        read -p &quot;Please reinput crtpath : &quot; crtpath</span><br><span class="line">        while ([ -z &quot;$crtpath&quot; ]  [ ! -f &quot;$crtpath&quot; ])</span><br><span class="line">        do</span><br><span class="line">            myi18n &quot;crt证书路径不能为空或路径错误，请重新输入。&quot;</span><br><span class="line">            shell_log &quot;警告：crt证书路径 $&#123;crtpath&#125; 为空或路径错误&quot;</span><br><span class="line">            echo</span><br><span class="line">            read -p &quot;: &quot; crtpath</span><br><span class="line">        done</span><br><span class="line">    fi</span><br><span class="line">    cp $&#123;crtpath&#125; $&#123;homesslpath&#125;/$&#123;domain&#125;.crt</span><br><span class="line">else</span><br><span class="line">    echo</span><br><span class="line">    myi18n &quot;自动搜索到：域名 $&#123;domain&#125; 证书crt文件路径为 $&#123;homesslpath&#125;/$&#123;domain&#125;.crt&quot;</span><br><span class="line">    shell_log &quot;信息：自动搜索到：域名 $&#123;domain&#125; 证书crt文件路径为 $&#123;homesslpath&#125;/$&#123;domain&#125;.crt&quot;</span><br><span class="line">    echo</span><br><span class="line">fi</span><br><span class="line">if [ ! -f &quot;$key1&quot; ] ;then</span><br><span class="line">    if [ ! -f &quot;$keypathtemp&quot; ] ;then</span><br><span class="line">        myi18n &quot;请输入需要安装证书路径:eg /root/test.com.key&quot;</span><br><span class="line">        read -p &quot;Please reinput keypath : &quot; keypath</span><br><span class="line">        while ([ -z &quot;$keypath&quot; ]  [ ! -f &quot;$keypath&quot; ])</span><br><span class="line">        do</span><br><span class="line">            myi18n &quot;key证书路径不能为空或路径错误，请重新输入。&quot;</span><br><span class="line">            shell_log &quot;警告：key证书路径 $&#123;keypath&#125; 为空或路径错误&quot;</span><br><span class="line">            echo</span><br><span class="line">            read -p &quot;: &quot; keypath</span><br><span class="line">        done</span><br><span class="line">    else</span><br><span class="line">        keypath=$keypathtemp</span><br><span class="line">        echo</span><br><span class="line">        myi18n &quot;自动搜索到：域名 $&#123;domain&#125; 证书key文件路径为 $&#123;keypathtemp&#125;&quot;</span><br><span class="line">        shell_log &quot;自动搜索到：域名 $&#123;domain&#125; 证书key文件路径为 $&#123;keypathtemp&#125;&quot;</span><br><span class="line">        echo</span><br><span class="line">    fi</span><br><span class="line">    cp $&#123;keypath&#125; $&#123;homesslpath&#125;/$&#123;domain&#125;.key</span><br><span class="line">else</span><br><span class="line">    echo</span><br><span class="line">    myi18n &quot;自动搜索到：域名 $&#123;domain&#125; 证书key文件路径为 $&#123;homesslpath&#125;/$&#123;domain&#125;.key&quot;</span><br><span class="line">    shell_log &quot;信息：自动搜索到：域名 $&#123;domain&#125; 证书key文件路径为 $&#123;homesslpath&#125;/$&#123;domain&#125;.key&quot;</span><br><span class="line">    echo</span><br><span class="line">fi</span><br><span class="line">shell_log &quot;信息：域名 $&#123;domain&#125; 证书crt文件路径为 $&#123;homesslpath&#125;/$&#123;domain&#125;.crt&quot;</span><br><span class="line">shell_log &quot;信息：域名 $&#123;domain&#125; 证书key文件路径为 $&#123;homesslpath&#125;/$&#123;domain&#125;.key&quot;</span><br><span class="line">cp $&#123;files&#125;&quot;.conf&quot; $&#123;homeconfpath&#125;/vhost/$&#123;files&#125;&quot;_ssl.conf&quot;</span><br><span class="line">shell_log &quot;信息：域名 $&#123;domain&#125; 部署后 ssl配置文件为 $&#123;homeconfpath&#125;/$&#123;files&#125;_ssl.conf&quot;</span><br><span class="line">if [ &quot;$wdcp&quot; == &#x27;y&#x27; ] ;then</span><br><span class="line">    chown wdcpu.wdcpg * -R</span><br><span class="line">    shell_log &quot;信息：核实为wdcp环境，设置$&#123;homeconfpath&#125; 所有者及所属组为wdcpu.wdcpg&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">sed -i &quot;s/80/443 ssl/g&quot; $&#123;sslfile&#125;</span><br><span class="line">sed -i &quot;/root/a\   ssl_certificate $crt1;&quot; $&#123;sslfile&#125;</span><br><span class="line">sed -i &quot;/ssl_certificate/a\    ssl_certificate_key $key1;&quot; $&#123;sslfile&#125;</span><br><span class="line">sed -i &quot;/ssl_certificate_key/a\    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;&quot; $&#123;sslfile&#125;</span><br><span class="line">sed -i &quot;/ssl_protocols/a\  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;&quot; $&#123;sslfile&#125;          </span><br><span class="line">myi18n &quot;是否需要一键设置301转向，请输入y或者n？&quot;</span><br><span class="line">read -p &quot;[y/n]: &quot; zx_yn</span><br><span class="line">while [[ ! $zx_yn =~ ^[y,n]$ ]] </span><br><span class="line">do</span><br><span class="line">    echo &quot;input error! Please only input &#x27;y&#x27; or &#x27;n&#x27;&quot;</span><br><span class="line">    echo</span><br><span class="line">    read -p &quot;[y/n]: &quot; zx_yn</span><br><span class="line">done</span><br><span class="line">if [ &quot;$zx_yn&quot; == &#x27;y&#x27; ] ;then</span><br><span class="line">    myi18n &quot;请输入跳转后地址比如：&quot;</span><br><span class="line">    read -p &quot;$&#123;domain&#125;: &quot; server_name1</span><br><span class="line">    if [ -z $server_name1 ] ;then</span><br><span class="line">        server_name1=&#x27;$server_name&#x27;</span><br><span class="line">    fi</span><br><span class="line">    request_uri1=&#x27;$request_uri&#x27;</span><br><span class="line">    sed -i &quot;/server_name/a\    return  301 https://$server_name1$request_uri1;&quot; $&#123;files1&#125;</span><br><span class="line">    shell_log &quot;信息：域名 $&#123;domain&#125; 已设置301跳转到https://$&#123;server_name1&#125;$&#123;request_uri1&#125;  $&#123;files1&#125;&quot;</span><br><span class="line">fi</span><br><span class="line">service nginxd restart</span><br><span class="line">iptables -L -n grep -w dpt:80 &gt;/dev/null</span><br><span class="line">if  [ $? -eq 0 ] ;then</span><br><span class="line">    iptables -L -n grep -w dpt:443 &gt;/dev/null</span><br><span class="line">    if  [ $? -ne 0 ] ;then</span><br><span class="line">        echo</span><br><span class="line">        myi18n &quot;正在放行443端口&quot;</span><br><span class="line">        echo</span><br><span class="line">        sed -i &quot;/dport 80 -j ACCEPT/a\-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT&quot; /etc/sysconfig/iptables</span><br><span class="line">        service iptables restart</span><br><span class="line">    else</span><br><span class="line">        myi18n &quot;核实已放行443端口&quot;</span><br><span class="line">    fi</span><br><span class="line">else</span><br><span class="line">    myi18n &quot;iptables服务似乎没有运行&quot;</span><br><span class="line">fi</span><br><span class="line">curl -I https://$&#123;domain&#125;</span><br><span class="line">echo</span><br><span class="line">echo $&#123;domain&#125; </span><br><span class="line">myi18n &quot;关联站点证书已安装完成！&quot;</span><br><span class="line">myi18n &quot;证书文件存放/home/ssl，以域名方式命名。&quot;</span><br><span class="line">echo</span><br><span class="line">myi18n &quot;域名 $&#123;domain&#125; 证书crt文件路径为 $&#123;homesslpath&#125;/$&#123;domain&#125;.crt&quot;</span><br><span class="line">myi18n &quot;域名 $&#123;domain&#125; 证书key文件路径为 $&#123;homesslpath&#125;/$&#123;domain&#125;.key&quot;</span><br><span class="line">echo </span><br><span class="line">cp -rf $&#123;homeconfpath&#125;/vhost /home/nginx-vhost-bak</span><br><span class="line">myi18n &quot;同时已备份当前nginx配置文件到/home/nginx-vhost-bak&quot;</span><br><span class="line">if [ &quot;$wdcp&quot; == &#x27;y&#x27; ] ;then</span><br><span class="line">    myi18n &quot;如果使用wdcp环境，请不要登录wdcp切换web引擎，否则配置文件将被覆盖！&quot;</span><br><span class="line">fi</span><br><span class="line">shell_log &quot;信息：$&#123;domain&#125; 关联站点证书已安装完成&quot;</span><br><span class="line">pushd /root/</span><br><span class="line">if [ &quot;$wdcp&quot; == &#x27;y&#x27; ] &amp;&amp; [ ! -d /www/wdlinux/nginx-1.10.2 ] ;then</span><br><span class="line">    myi18n &quot;核实nginx和openssl版本较低，若要通过苹果ats认证，请升级&quot;</span><br><span class="line">    function homemove()&#123;</span><br><span class="line">        confpath=/www/wdlinux/nginx</span><br><span class="line">        if [ &quot;$&#123;homeconfpath&#125;&quot; == &quot;/www/wdlinux/nginx/conf&quot; ] ;then</span><br><span class="line">            echo $homeconfpath;</span><br><span class="line">            myi18n &quot;不需要移动配置文件&quot;</span><br><span class="line">        else</span><br><span class="line">            cp -rf $&#123;confpath&#125;/conf/* $homeconfpath</span><br><span class="line">            cd $confpath</span><br><span class="line">            mv conf/ conf-bak/</span><br><span class="line">            ln -sf $homeconfpath conf</span><br><span class="line">            chown wdcpu.wdcpg $homeconfpath -R</span><br><span class="line">        fi</span><br><span class="line">    &#125;</span><br><span class="line">    read -p &quot;[y/n]: &quot; update</span><br><span class="line">    while [[ ! $update =~ ^[y,n]$ ]] </span><br><span class="line">    do</span><br><span class="line">        echo &quot;input error! Please only input &#x27;y&#x27; or &#x27;n&#x27;&quot;</span><br><span class="line">        echo</span><br><span class="line">        read -p &quot;[y/n]: &quot; update</span><br><span class="line">    done</span><br><span class="line">    if [ &quot;$update&quot; == &#x27;y&#x27; ];then</span><br><span class="line">        wget http://downinfo.myhostadmin.net/wdcp/nginx_up.sh</span><br><span class="line">        sh nginx_up.sh</span><br><span class="line">        homemove</span><br><span class="line">        shell_log &quot;信息：核实为wdcp环境，已选择升级nginx和OpenSSL&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line">shell_log &quot;信息：脚本正常退出&quot;</span><br><span class="line">shell_unlock</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/04/13/%E5%9F%BA%E4%BA%8Enginx%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2https/" data-id="clc4klg7r00apojob9gzi1hl6" data-title="基于Nginx一键部署https" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/https/" rel="tag">https</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssl/" rel="tag">ssl</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wdcp/" rel="tag">wdcp</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-centos7环境下全自动创建kvm虚拟机" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/13/centos7%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%85%A8%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BAkvm%E8%99%9A%E6%8B%9F%E6%9C%BA/" class="article-date">
  <time class="dt-published" datetime="2017-04-13T15:25:37.000Z" itemprop="datePublished">2017-04-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cloud/">cloud</a>►<a class="article-category-link" href="/categories/cloud/Kvm/">Kvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/13/centos7%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%85%A8%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BAkvm%E8%99%9A%E6%8B%9F%E6%9C%BA/">Centos7环境下全自动创建kvm虚拟机</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h4><ul>
<li>自动配置外网、内网ip</li>
<li>自动设置主机名</li>
<li>自动扩容数据盘</li>
<li>可预设定vnc、root密码</li>
</ul>
<h4 id="具体代码"><a href="#具体代码" class="headerlink" title="具体代码"></a>具体代码</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">centos6,7 模板数据盘都是10G</span></span><br><span class="line"></span><br><span class="line">export PATH=&quot;/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin&quot;</span><br><span class="line"></span><br><span class="line">dateTime=$(date +%Y%m%d%H%M%S)</span><br><span class="line">tmpDiskFile6_os=&quot;/vmdata/template/centos64_os&quot;</span><br><span class="line">tmpDiskFile6_data=&quot;/vmdata/template/centos64_data&quot;</span><br><span class="line">tmpDiskFile7_os=&quot;/vmdata/template/template_os.qcow2&quot;</span><br><span class="line">tmpDiskFile7_data=&quot;/vmdata/template/template_data.qcow2&quot;</span><br><span class="line">vmDir=&quot;/vmdata&quot;</span><br><span class="line">test -d $vmDir  mkdir -p $vmDir</span><br><span class="line">vncpasswd=&quot;ropon.top&quot;</span><br><span class="line">newpasswd=&quot;ropon.top&quot;</span><br><span class="line"></span><br><span class="line">help() &#123;</span><br><span class="line">    cat &gt;&gt; /dev/stdout &lt;&lt;EOF</span><br><span class="line">Usage: $(basename $0) vmname vcpu memory ip [TempleteDiskFile]  -h</span><br><span class="line">Example: ./$(basename $0) vmname=ebs-11 vcpu=1 memory=1024M datasize=20 ip=192.168.7.221 ostype=centos7</span><br><span class="line">Example: ./$(basename $0) vmname=ebs-2 vcpu=1 memory=1024M datasize=20 ip=192.168.123.12 ostype=centos6</span><br><span class="line">Example: ./$(basename $0) -h     //print help infomations</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error() &#123;</span><br><span class="line">    echo -e &quot;input parameter error: $1 \n please try again!&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [[ &quot;$#&quot; -eq 0  &quot;$1&quot; == &quot;-h&quot; ]]; then</span><br><span class="line">    help</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">for line in $@</span><br><span class="line">    do</span><br><span class="line">    case $line in</span><br><span class="line">    vmname*)</span><br><span class="line">        vmName=$(echo $line  awk -F &quot;=&quot; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">        ;;</span><br><span class="line">    vcpu*)</span><br><span class="line">        vCpu=$(echo $line  awk -F &quot;=&quot; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">        if ! echo $vCpu  grep &#x27;^[0-9]$&#x27; &gt; /dev/null; then</span><br><span class="line">            error $line</span><br><span class="line">            help</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    memory*)</span><br><span class="line">        memTmp=$(echo $line  awk -F &quot;=&quot; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">        memNum=$(echo $&#123;memTmp:0:$&#123;#memTmp&#125;-1&#125;)</span><br><span class="line">        memUnit=$(echo $&#123;memTmp:0-1&#125;  tr &#x27;[a-z]&#x27; &#x27;[A-Z]&#x27;)</span><br><span class="line">        if ! echo $memNum  grep &#x27;[0-9]&#x27; &gt; /dev/null; then</span><br><span class="line">            error $line</span><br><span class="line">            help</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">        if [[ &quot;$memUnit&quot; != &quot;G&quot; &amp;&amp; &quot;$memUnit&quot; != &quot;M&quot; &amp;&amp; &quot;$memUnit&quot; != &quot;K&quot; ]]; then</span><br><span class="line">            error $line</span><br><span class="line">            help</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    datasize*)</span><br><span class="line">        datasize=$(echo $line  awk -F &quot;=&quot; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">        if ! echo $datasize  grep &#x27;^[0-9]&#x27; &gt; /dev/null; then</span><br><span class="line">            error $line</span><br><span class="line">            help</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    ip*)</span><br><span class="line">        vmIp=$(echo $line  awk -F &quot;=&quot; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">        if ! echo $vmIp  grep &#x27;[0-9]\&#123;1,3\&#125;\(\.[0-9]\&#123;1,3\&#125;\)\&#123;3\&#125;&#x27; &gt; /dev/null; then</span><br><span class="line">            error $line</span><br><span class="line">            help</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    ostype*)</span><br><span class="line">        ostype=$(echo $line  awk -F &quot;=&quot; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">        [ $ostype == &quot;centos6&quot; ] &amp;&amp; echo &quot;you chose centos6&quot; &amp;&amp; diskFile=$tmpDiskFile6_os &amp;&amp; diskFile1=$tmpDiskFile6_data</span><br><span class="line">        [ $ostype == &quot;centos7&quot; ] &amp;&amp; echo &quot;you chose centos7&quot; &amp;&amp; diskFile=$tmpDiskFile7_os &amp;&amp; diskFile1=$tmpDiskFile7_data</span><br><span class="line">        if [ ! -f &quot;$diskFile&quot; ]  [ ! -f &quot;$diskFile1&quot; ] ; then</span><br><span class="line">            error $line</span><br><span class="line">            help</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        error $line</span><br><span class="line">        help</span><br><span class="line">        exit 1</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [ -z &quot;$vmName&quot; ]  [ -z &quot;$vCpu&quot; ]  [ -z &quot;$memNum&quot; ]  [ -z &quot;$vmIp&quot; ];</span><br><span class="line">    then</span><br><span class="line">    echo -e &quot;input parameter incomplete: $@&quot;</span><br><span class="line">    help</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">read</span> -p <span class="string">&quot;please input vnc passwd:&quot;</span> vncpasswd</span></span><br><span class="line">if [ -z $vncpasswd ] ;then</span><br><span class="line">    vncpasswd=`echo $RANDOMmd5sumcut -c 1-6`</span><br><span class="line">fi</span><br><span class="line">create_config() &#123;</span><br><span class="line">memUnit=&quot;$memUnit&quot;iB</span><br><span class="line">cat &gt; $vmDir/$vmName/$vmName.xml &lt;&lt;EOF</span><br><span class="line">&lt;domain type=&#x27;kvm&#x27;&gt;</span><br><span class="line">  &lt;name&gt;$vmName&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;$vmUuid&lt;/uuid&gt;</span><br><span class="line">  &lt;memory unit=&#x27;$memUnit&#x27;&gt;$memNum&lt;/memory&gt;</span><br><span class="line">  &lt;currentMemory unit=&#x27;$memUnit&#x27;&gt;$memNum&lt;/currentMemory&gt;</span><br><span class="line">  &lt;vcpu placement=&#x27;static&#x27;&gt;$vCpu&lt;/vcpu&gt;</span><br><span class="line">  &lt;cpu mode=&#x27;host-passthrough&#x27;/&gt;</span><br><span class="line">  &lt;os&gt;</span><br><span class="line">    &lt;type arch=&#x27;x86_64&#x27; machine=&#x27;pc&#x27;&gt;hvm&lt;/type&gt;</span><br><span class="line">    &lt;boot dev=&#x27;cdrom&#x27;/&gt;</span><br><span class="line">    &lt;boot dev=&#x27;hd&#x27;/&gt;</span><br><span class="line">    &lt;bootmenu enable=&#x27;yes&#x27;/&gt;</span><br><span class="line">  &lt;/os&gt;</span><br><span class="line">  &lt;features&gt;</span><br><span class="line">    &lt;acpi/&gt;</span><br><span class="line">    &lt;apic/&gt;</span><br><span class="line">  &lt;/features&gt;</span><br><span class="line">  &lt;clock offset=&#x27;utc&#x27;&gt;</span><br><span class="line">    &lt;timer name=&#x27;rtc&#x27; tickpolicy=&#x27;catchup&#x27;/&gt;</span><br><span class="line">    &lt;timer name=&#x27;pit&#x27; tickpolicy=&#x27;delay&#x27;/&gt;</span><br><span class="line">    &lt;timer name=&#x27;hpet&#x27; present=&#x27;no&#x27;/&gt;</span><br><span class="line">  &lt;/clock&gt;</span><br><span class="line">  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</span><br><span class="line">  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</span><br><span class="line">  &lt;on_crash&gt;restart&lt;/on_crash&gt;</span><br><span class="line">  &lt;pm&gt;</span><br><span class="line">    &lt;suspend-to-mem enabled=&#x27;no&#x27;/&gt;</span><br><span class="line">    &lt;suspend-to-disk enabled=&#x27;no&#x27;/&gt;</span><br><span class="line">  &lt;/pm&gt;</span><br><span class="line">  &lt;devices&gt;</span><br><span class="line">    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;</span><br><span class="line">    &lt;disk type=&#x27;file&#x27; device=&#x27;disk&#x27;&gt;</span><br><span class="line">      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27;/&gt;</span><br><span class="line">      &lt;source file=&#x27;$vmDir/$vmName/$vmNameos&#x27;/&gt;</span><br><span class="line">      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x06&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;disk type=&#x27;file&#x27; device=&#x27;disk&#x27;&gt;</span><br><span class="line">      &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27;/&gt;</span><br><span class="line">      &lt;source file=&#x27;$vmDir/$vmName/$vmNamedata&#x27;/&gt;</span><br><span class="line">      &lt;target dev=&#x27;vdb&#x27; bus=&#x27;virtio&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x16&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;disk type=&#x27;file&#x27; device=&#x27;cdrom&#x27;&gt;</span><br><span class="line">      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27;/&gt;</span><br><span class="line">      &lt;target dev=&#x27;hda&#x27; bus=&#x27;ide&#x27;/&gt;</span><br><span class="line">      &lt;readonly/&gt;</span><br><span class="line">      &lt;address type=&#x27;drive&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; target=&#x27;0&#x27; unit=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-ehci1&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x7&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-uhci1&#x27;&gt;</span><br><span class="line">      &lt;master startport=&#x27;0&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x0&#x27; multifunction=&#x27;on&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-uhci2&#x27;&gt;</span><br><span class="line">      &lt;master startport=&#x27;2&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x1&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-uhci3&#x27;&gt;</span><br><span class="line">      &lt;master startport=&#x27;4&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x2&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;pci&#x27; index=&#x27;0&#x27; model=&#x27;pci-root&#x27;/&gt;</span><br><span class="line">    &lt;controller type=&#x27;ide&#x27; index=&#x27;0&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x01&#x27; function=&#x27;0x1&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;virtio-serial&#x27; index=&#x27;0&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;interface type=&#x27;bridge&#x27;&gt;</span><br><span class="line">      &lt;mac address=&#x27;$vmMac&#x27;/&gt;</span><br><span class="line">      &lt;source bridge=&#x27;br0&#x27;/&gt;</span><br><span class="line">      &lt;model type=&#x27;virtio&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x03&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">    &lt;interface type=&#x27;bridge&#x27;&gt;</span><br><span class="line">      &lt;mac address=&#x27;$vmMac1&#x27;/&gt;</span><br><span class="line">      &lt;source bridge=&#x27;br1&#x27;/&gt;</span><br><span class="line">      &lt;model type=&#x27;virtio&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x13&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">    &lt;serial type=&#x27;pty&#x27;&gt;</span><br><span class="line">      &lt;target port=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;/serial&gt;</span><br><span class="line">    &lt;console type=&#x27;pty&#x27;&gt;</span><br><span class="line">      &lt;target type=&#x27;serial&#x27; port=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;/console&gt;</span><br><span class="line">    &lt;channel type=&#x27;unix&#x27;&gt;</span><br><span class="line">      &lt;target type=&#x27;virtio&#x27; name=&#x27;org.qemu.guest_agent.0&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/channel&gt;</span><br><span class="line">    &lt;input type=&#x27;tablet&#x27; bus=&#x27;usb&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;0&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/input&gt;</span><br><span class="line">    &lt;input type=&#x27;mouse&#x27; bus=&#x27;ps2&#x27;/&gt;</span><br><span class="line">    &lt;input type=&#x27;keyboard&#x27; bus=&#x27;ps2&#x27;/&gt;</span><br><span class="line">    &lt;graphics type=&#x27;vnc&#x27; port=&#x27;-1&#x27; autoport=&#x27;yes&#x27; listen=&#x27;0.0.0.0&#x27; passwd=&#x27;$vncpasswd&#x27;&gt;</span><br><span class="line">      &lt;listen type=&#x27;address&#x27; address=&#x27;0.0.0.0&#x27;/&gt;</span><br><span class="line">    &lt;/graphics&gt;</span><br><span class="line">    &lt;video&gt;</span><br><span class="line">      &lt;model type=&#x27;cirrus&#x27; vram=&#x27;16384&#x27; heads=&#x27;1&#x27; primary=&#x27;yes&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/video&gt;</span><br><span class="line">    &lt;memballoon model=&#x27;virtio&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x07&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/memballoon&gt;</span><br><span class="line">  &lt;/devices&gt;</span><br><span class="line">&lt;/domain&gt;</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">create_mac() &#123;</span><br><span class="line">test -f /tmp/mac.py &amp;&amp; rm -f /tmp/mac.py</span><br><span class="line">cat &gt; /tmp/mac.py &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/python</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">macgen.py script to generate a MAC address <span class="keyword">for</span> Red Hat Virtualization guests</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">import random</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">def randomMAC():</span></span><br><span class="line">        mac = [ 0x54, 0x52, 0x00,</span><br><span class="line">                random.randint(0x00, 0x7f),</span><br><span class="line">                random.randint(0x00, 0xff),</span><br><span class="line">                random.randint(0x00, 0xff) ]</span><br><span class="line">        return &#x27;:&#x27;.join(map(lambda x: &quot;%02x&quot; % x, mac))</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="built_in">print</span> randomMAC()</span></span><br><span class="line">EOF</span><br><span class="line">vmMac=$(python /tmp/mac.py)</span><br><span class="line">vmMac1=$(python /tmp/mac.py)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">create_uuid() &#123;</span><br><span class="line">vmUuid=$(uuidgen)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dots() &#123;</span><br><span class="line">sec=$1</span><br><span class="line">while true</span><br><span class="line">    do</span><br><span class="line">    echo -e &quot;.\c&quot;</span><br><span class="line">    sleep $sec</span><br><span class="line">done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define_kvm() &#123;</span><br><span class="line"></span><br><span class="line">virsh define $vmDir/$vmName/$vmName.xml</span><br><span class="line">if [ $? -ne 0 ]; then</span><br><span class="line">    echo -e &quot;virsh define $vmName.xml error!&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line">virsh start $vmName</span><br><span class="line">if [ $? -ne 0 ]; then</span><br><span class="line">    echo -e &quot;virsh start $vmName error!&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line">virsh list</span><br><span class="line">vncPort=$(virsh vncdisplay $vmName)</span><br><span class="line">vncIp=`ifconfig br0grep -w inetawk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">echo -e &quot;VNC IP and Port is: $vncIp$vncPort&quot;</span><br><span class="line">echo -e &quot;$vmName vnc passwd:$vncpasswd \n&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">modify_disk() &#123;</span><br><span class="line">    #vmHostName=$(echo $vmIp  awk -F &quot;.&quot; &#x27;&#123;print &quot;YN-&quot; $3 &quot;-&quot; $4&#125;&#x27;)</span><br><span class="line">    vmIpPri=172.16.$(echo $vmIp  awk -F &quot;.&quot; &#x27;&#123;print $3 &quot;.&quot; $4&#125;&#x27;)</span><br><span class="line">    #vmGy=$&#123;vmIp%.*&#125;.1</span><br><span class="line">    vmGy=192.168.0.1</span><br><span class="line">    vmNm=255.255.248.0</span><br><span class="line">    vmNm1=255.255.255.0</span><br><span class="line">    mnttemp=/tmp/$vmName</span><br><span class="line">    [ ! -d $mnttemp ] &amp;&amp; mkdir -p $mnttemp</span><br><span class="line">    guestmount -a $vmDir/$vmName/$vmNameos  -m /dev/sda2  --rw $mnttemp</span><br><span class="line">    if [ $? -ne 0 ]; then</span><br><span class="line">        echo -e &quot;mount $vmDir/$vmName/$vmNameos failed! &quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    tmpGy=&quot;$mnttemp/etc/sysconfig/network&quot;</span><br><span class="line">    tmpIp1=&quot;$mnttemp/etc/sysconfig/network-scripts/ifcfg-eth0&quot;</span><br><span class="line">    tmpIp2=&quot;$mnttemp/etc/sysconfig/network-scripts/ifcfg-eth1&quot;</span><br><span class="line">    sed -i &quot;/^127.0/a\127.0.0.1   $vmName&quot;  $mnttemp/etc/hosts</span><br><span class="line">    sed -i &quot;s/GATEWAY=/GATEWAY=$vmGy/g&quot; $tmpGy</span><br><span class="line">    sed -i &quot;s/IPADDR=/IPADDR=$vmIp/g&quot; $tmpIp1</span><br><span class="line">    sed -i &quot;s/NETMASK=/NETMASK=$vmNm/g&quot; $tmpIp1</span><br><span class="line">    sed -i &quot;s/IPADDR=/IPADDR=$vmIpPri/g&quot; $tmpIp2</span><br><span class="line">    sed -i &quot;s/NETMASK=/NETMASK=$vmNm1/g&quot; $tmpIp2</span><br><span class="line">    #read -p &quot;please input root passwd:&quot; newpasswd</span><br><span class="line">    if [ -z $newpasswd ] ;then</span><br><span class="line">        newpasswd=`echo $RANDOMmd5sumcut -c 7-12`</span><br><span class="line">    fi</span><br><span class="line">    sed -i &quot;s/passwdtemp/$newpasswd/g&quot; $mnttemp/root/set.sh</span><br><span class="line">    sed -i &quot;s/vmnametemp/$vmName/g&quot; $mnttemp/root/set.sh</span><br><span class="line">    sed -i &quot;s/tempdisksize/$tempdisksize/g&quot; $mnttemp/root/set.sh</span><br><span class="line">    sed -i &quot;/^touch/a\/root/set.sh&quot;  $mnttemp/etc/rc.d/rc.local</span><br><span class="line">    sleep 1</span><br><span class="line">    umount $mnttemp</span><br><span class="line">    sleep 1</span><br><span class="line">    rm -rf $mnttemp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">    vmNameos=&quot;$vmName&quot;_os.qcow2</span><br><span class="line">    vmNamedata=&quot;$vmName&quot;_data.qcow2</span><br><span class="line">    test -d $vmDir/$vmName  mkdir -p $vmDir/$vmName</span><br><span class="line">    if [ -f &quot;$vmDir/$vmName/$vmName.xml&quot; ]; then</span><br><span class="line">        mv $vmDir/$vmName/$vmName.xml $vmDir/$vmName/$vmName.xml.$dateTime</span><br><span class="line">        echo -e &quot;$vmDir/$vmName/$vmName.xml exist, rename $vmDir/$vmName/$vmName.xml.$dateTime &quot;</span><br><span class="line">    fi</span><br><span class="line">    echo -e &quot;create virtual machine config file:&quot;</span><br><span class="line">    [ -f &quot;/etc/libvirt/qemu/$vmName.xml&quot; ] &amp;&amp; echo -e &quot;$vmName is exist, Please check!&quot; &amp;&amp; exit 1</span><br><span class="line">    create_mac</span><br><span class="line">    create_uuid</span><br><span class="line">    create_config</span><br><span class="line">    echo -e &quot;create config file($vmDir/$vmName/$vmName.xml) success&quot;</span><br><span class="line">    if [ ! -f &quot;$diskFile&quot; ]; then</span><br><span class="line">        echo -e &quot;$diskFile not found, Please try again!&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ ! -f &quot;$diskFile1&quot; ]; then</span><br><span class="line">        echo -e &quot;$diskFile1 not found, Please try again!&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ -f &quot;$vmDir/$vmName/$vmNameos&quot; ]; then</span><br><span class="line">        mv $vmDir/$vmName/$vmNameos $vmDir/$vmName/$vmNameos.$dateTime</span><br><span class="line">        echo -e &quot;$vmDir/$vmName/$vmName exist, rename $vmDir/$vmName/$vmName.$dateTime &quot;</span><br><span class="line">    fi</span><br><span class="line">    echo -e &quot;cow 写时复制新技术生成: $vmDir/$vmName/$vmNameos&quot;</span><br><span class="line">    qemu-img create -f qcow2 -b $diskFile $vmDir/$vmName/$vmNameos</span><br><span class="line">    echo -e &quot;cow 写时复制新技术生成: $vmDir/$vmName/$vmNamedata&quot;</span><br><span class="line">    qemu-img create -f qcow2 -b $diskFile1 $vmDir/$vmName/$vmNamedata</span><br><span class="line">    [ $ostype == &quot;centos7&quot; ] &amp;&amp; tempdisksize=$[datasize -10]</span><br><span class="line">    [ $ostype == &quot;centos6&quot; ] &amp;&amp; tempdisksize=$[datasize -10]</span><br><span class="line">    if [ $tempdisksize -gt 0 ];then</span><br><span class="line">        echo -e &quot;modify data_os size ...&quot;</span><br><span class="line">        qemu-img resize $vmDir/$vmName/$vmNamedata +$&#123;tempdisksize&#125;G</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">startTime=`date +%s`</span><br><span class="line">main</span><br><span class="line">echo</span><br><span class="line">echo -e &quot;modify virtual machine IP and Hostname...&quot;</span><br><span class="line">modify_disk</span><br><span class="line">echo -e &quot;define virtual machine ...&quot;</span><br><span class="line">define_kvm</span><br><span class="line">echo -e &quot;$vmName ip: $vmIp\n&quot;</span><br><span class="line">echo -e &quot;$vmName gy: $vmGy\n&quot;</span><br><span class="line">echo -e &quot;$vmName nip: $vmIpPri\n&quot;</span><br><span class="line">echo -e &quot;$vmName root passwd:$newpasswd \n&quot;</span><br><span class="line">echo -e &quot;create KVM virtual machine:$vmName finish! \n&quot;</span><br><span class="line">endTime=`date +%s`</span><br><span class="line">installTime=$[$endTime-$startTime]</span><br><span class="line">echo &quot;create kvm time: $installTime second&quot;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/04/13/centos7%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%85%A8%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BAkvm%E8%99%9A%E6%8B%9F%E6%9C%BA/" data-id="clc4klg4l0019ojobges91jia" data-title="Centos7环境下全自动创建kvm虚拟机" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/auto/" rel="tag">auto</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91/" rel="tag">云</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="tag">虚拟化</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-centos7环境下制作kvm模板" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/04/13/centos7%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%B6%E4%BD%9Ckvm%E6%A8%A1%E6%9D%BF/" class="article-date">
  <time class="dt-published" datetime="2017-04-13T15:24:59.000Z" itemprop="datePublished">2017-04-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cloud/">cloud</a>►<a class="article-category-link" href="/categories/cloud/Kvm/">Kvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/04/13/centos7%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%B6%E4%BD%9Ckvm%E6%A8%A1%E6%9D%BF/">Centos7环境下制作kvm模板</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="创建一个虚拟机安装模板系统"><a href="#创建一个虚拟机安装模板系统" class="headerlink" title="创建一个虚拟机安装模板系统"></a>创建一个虚拟机安装模板系统</h4><ul>
<li>vnc密码：ropon.top</li>
<li>不要使用lvm方式安装，使用标准分区，然后点击自动创建分区安</li>
</ul>
<hr>
<h4 id="一键创建虚拟机"><a href="#一键创建虚拟机" class="headerlink" title="一键创建虚拟机"></a>一键创建虚拟机</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Author: Ropon</span><br><span class="line"># Blog: https://www.ropon.top</span><br><span class="line"></span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin</span><br><span class="line">declare -A Colors</span><br><span class="line">Colors=([failure]=&quot;31m&quot; [success]=&quot;32m&quot; [warning]=&quot;33m&quot; [msg]=&quot;34m&quot;)</span><br><span class="line">name=CreateKvm</span><br><span class="line">ver=1.0 </span><br><span class="line">LogFile=/tmp/.$(basename $0).log</span><br><span class="line"></span><br><span class="line">#格式输出及写日志</span><br><span class="line">Echo() &#123;</span><br><span class="line">    [ ! $1 ] &amp;&amp; flag=&quot;34m&quot;  flag=$1</span><br><span class="line">    echo -e &quot;\033[1;$&#123;Colors[$&#123;flag&#125;]&#125;$&#123;2&#125;\033[0m&quot;</span><br><span class="line">    echo &quot;$(date &quot;+%Y-%m-%d&quot;) $(date &quot;+%H-%M-%S&quot;):$&#123;name&#125;:[$1] $2&quot; &gt;&gt; $LogFile</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Main() &#123;</span><br><span class="line">    [ ! -d /vmdata ] &amp;&amp; mkdir /vmdata</span><br><span class="line">    [ ! -d /vmdata/iso ] &amp;&amp; mkdir -p /vmdata/iso</span><br><span class="line">    [ ! -d /vmdata/template ] &amp;&amp; mkdir -p /vmdata/template</span><br><span class="line">    [ ! -f /vmdata/iso/centos7.iso ] &amp;&amp; wget -O /vmdata/iso/centos7.iso http://mirrors.163.com/centos/7.7.1908/isos/x86_64/CentOS-7-x86_64-Minimal-1908.iso</span><br><span class="line">    [ ! -f /vmdata/template/centos7_os.qcow2 ] &amp;&amp; qemu-img create -f qcow2 -o preallocation=metadata /vmdata/template/centos7_os.qcow2 10G</span><br><span class="line">    [ ! -f /vmdata/template/centos7_data.qcow2 ] &amp;&amp; qemu-img create -f qcow2 -o preallocation=metadata /vmdata/template/centos7_data.qcow2 10G</span><br><span class="line"></span><br><span class="line">    virt-install --virt-type kvm --name=template --ram=2048 --vcpus=2 --cdrom=/vmdata/iso/centos7.iso \</span><br><span class="line">    --network bridge=br0 --network bridge=br1 --noautoconsole --os-type=linux --os-variant=rhel7 \</span><br><span class="line">    --disk path=/vmdata/template/centos7_os.qcow2,format=qcow2,bus=virtio,cache=writeback --disk path=/vmdata/template/centos7_data.qcow2,format=qcow2,bus=virtio,cache=writeback \</span><br><span class="line">    --graphics vnc,listen=0.0.0.0,password=ropon.top --boot cdrom,hd,menu=on --accelerate</span><br><span class="line">    [ $? -eq 0 ] &amp;&amp; Echo &quot;success&quot; &quot;kvm创建成功,请使用vnc客户端连接制作模板&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Main</span><br></pre></td></tr></table></figure>

<h4 id="模板一键优化脚本"><a href="#模板一键优化脚本" class="headerlink" title="模板一键优化脚本"></a>模板一键优化脚本</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Author: Ropon</span><br><span class="line"># Blog: https://www.ropon.top</span><br><span class="line"></span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line">export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin</span><br><span class="line">declare -A Colors</span><br><span class="line">Colors=([failure]=&quot;31m&quot; [success]=&quot;32m&quot; [warning]=&quot;33m&quot; [msg]=&quot;34m&quot;)</span><br><span class="line">name=CreateKvm</span><br><span class="line">ver=1.0 </span><br><span class="line">LogFile=/tmp/.$(basename $0).log</span><br><span class="line">eth0f=&quot;/etc/sysconfig/network-scripts/ifcfg-eth0&quot;</span><br><span class="line">eth1f=&quot;/etc/sysconfig/network-scripts/ifcfg-eth1&quot;</span><br><span class="line">hostname=template</span><br><span class="line"></span><br><span class="line">#获取系统及版本</span><br><span class="line">CheckOS() &#123;</span><br><span class="line">    if [ -e /etc/redhat-release ]; then</span><br><span class="line">        OS=CentOS</span><br><span class="line">        [ -n &quot;$(grep &#x27; 7\.&#x27; /etc/redhat-release 2&gt; /dev/null)&quot; ] &amp;&amp; CentOSVer=7</span><br><span class="line">        [ -n &quot;$(grep &#x27; 6\.&#x27; /etc/redhat-release 2&gt; /dev/null)&quot; ] &amp;&amp; CentOSVer=6</span><br><span class="line">    elif [ -n &quot;$(grep -i &#x27;Debian&#x27; /etc/issue 2&gt; /dev/null)&quot; ]; then</span><br><span class="line">        OS=Debian</span><br><span class="line">    elif [ -n &quot;$(grep -i &#x27;Ubuntu&#x27; /etc/issue 2&gt; /dev/null)&quot; ]; then</span><br><span class="line">        OS=Ubuntu</span><br><span class="line">    else</span><br><span class="line">        OS=UnknownOS</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#格式输出及写日志</span><br><span class="line">Echo() &#123;</span><br><span class="line">    [ ! $1 ] &amp;&amp; flag=&quot;34m&quot;  flag=$1</span><br><span class="line">    echo -e &quot;\033[1;$&#123;Colors[$&#123;flag&#125;]&#125;$&#123;2&#125;\033[0m&quot;</span><br><span class="line">    echo &quot;$(date &quot;+%Y-%m-%d&quot;) $(date &quot;+%H-%M-%S&quot;):$&#123;name&#125;:[$1] $2&quot; &gt;&gt; $LogFile</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Main() &#123;</span><br><span class="line">    CheckOS</span><br><span class="line">    [ $CentOSVer -ne 7 ] &amp;&amp; Echo &quot;warning&quot; &quot;暂时仅支持Centos7.x&quot; &amp;&amp; exit</span><br><span class="line">    yum install -y wget</span><br><span class="line">    # 调整yum源及epel源</span><br><span class="line">    mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class="line">    wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">    wget -O /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">    yum clean all</span><br><span class="line">    yum makecache</span><br><span class="line">    # 安装常用命令</span><br><span class="line">    yum install -y net-tools vim screen tcpdump ntp sysstat</span><br><span class="line">    # 优化配置及参数</span><br><span class="line">    # - 关闭禁用firewalld、NetworkManager服务、postfix服务</span><br><span class="line">    systemctl disable firewalld</span><br><span class="line">    systemctl stop firewalld</span><br><span class="line">    systemctl disable NetworkManager</span><br><span class="line">    systemctl stop NetworkManager</span><br><span class="line">    systemctl disable postfix</span><br><span class="line">    systemctl stop postfix</span><br><span class="line"></span><br><span class="line">    #优化You have new mail in /var/spool/mail/root 提示</span><br><span class="line">    echo &quot;unset MAILCHECK&quot; &gt;&gt; /etc/profile</span><br><span class="line"></span><br><span class="line">    # - 关闭禁用SELINUX</span><br><span class="line">    sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span><br><span class="line">    grep SELINUX=disabled /etc/selinux/config</span><br><span class="line">    setenforce 0</span><br><span class="line">    # 安装iptables服务</span><br><span class="line">    yum install -y iptables-services</span><br><span class="line">    cat &gt; /etc/sysconfig/iptables &lt;&lt;EOF</span><br><span class="line">*filter</span><br><span class="line"># 配置几个链默认行为 比如INPUT链 默认丢弃 </span><br><span class="line"># [0:0] 第一个值表示丢弃包的个数</span><br><span class="line"># 第二个值表示丢弃包的总字节，其他同理。</span><br><span class="line">:INPUT DROP [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">:syn-flood - [0:0]</span><br><span class="line"># 本地回环</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line"># 放行SSH端口</span><br><span class="line">-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line"># ICMP包控制</span><br><span class="line">-A INPUT -p icmp -m limit --limit 1/sec --limit-burst 10 -j ACCEPT</span><br><span class="line">-A INPUT -f -m limit --limit 100/sec --limit-burst 100 -j ACCEPT</span><br><span class="line"></span><br><span class="line"># UDP控制</span><br><span class="line">-A OUTPUT -d 119.29.29.29/32 -p udp -m udp --dport 53 -j ACCEPT</span><br><span class="line">-A OUTPUT -d 114.114.114.114/32 -p udp -m udp --dport 53 -j ACCEPT</span><br><span class="line">-A OUTPUT -p udp -m udp --dport 123 -j ACCEPT</span><br><span class="line">-A OUTPUT -p udp -j DROP</span><br><span class="line">COMMIT</span><br><span class="line">EOF</span><br><span class="line">    service iptables reload</span><br><span class="line">    # 调整DNS配置</span><br><span class="line">    cat &gt; /etc/resolv.conf &lt;&lt;EOF</span><br><span class="line">nameserver 119.29.29.29</span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    # 调整时区</span><br><span class="line">    rm -rf /etc/localtime</span><br><span class="line">    ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"></span><br><span class="line">    # 同步时间</span><br><span class="line">    sed -i &#x27;/ntpdate/d&#x27; /var/spool/cron/root</span><br><span class="line">    echo &#x27;*/10 * * * * /usr/sbin/ntpdate cn.pool.ntp.org &#x27; &gt;&gt;/var/spool/cron/root</span><br><span class="line">    service crond restart</span><br><span class="line">    ntpdate -u cn.pool.ntp.org</span><br><span class="line"></span><br><span class="line">    # 优化历史命令history</span><br><span class="line">    [ -z &quot;$(grep ^&#x27;export PROMPT_COMMAND=&#x27; /etc/bashrc)&quot; ] &amp;&amp; cat &gt;&gt; /etc/bashrc &lt;&lt; EOF</span><br><span class="line">export PROMPT_COMMAND=&#x27;&#123; msg=\$(history 1  &#123; read x y; echo \$y; &#125;);logger &quot;[euid=\$(whoami)]&quot;:\$(who am i):[\`pwd\`]&quot;\$msg&quot;; &#125;&#x27;</span><br><span class="line">EOF</span><br><span class="line">    # 优化SSH配置</span><br><span class="line">    # - 关闭SSH反向查询，以加快SSH的访问速度</span><br><span class="line">    sed -i &#x27;s@.*UseDNS yes@UseDNS no@&#x27; /etc/ssh/sshd_config</span><br><span class="line">    # - 禁止空密码登录</span><br><span class="line">    sed -i &#x27;s@PermitEmptyPasswords no@PermitEmptyPasswords no@&#x27; /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line">    # 内核参数优化</span><br><span class="line">    # - 表示套接字由本端要求关闭，这个参数决定了它保持在FIN-wAIT-2状态的时间，默认值是60秒，建议调整为2</span><br><span class="line">    echo &#x27;net.ipv4.tcp_fin_timeout = 2&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # -表示开启重用，允许TIME-wAIT sockets重新用于新的TCP链接，默认值为0，表示关闭</span><br><span class="line">    echo &#x27;net.ipv4.tcp_tw_reuse = 1&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 表示开启TCP链接中TIME_WAIT sockets的快速回收 默认为0 表示关闭，不建议开启，因为nat网络问题</span><br><span class="line">    echo &#x27;net.ipv4.tcp_tw_recycle = 0&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">    # - 表示开启SYN Cookies功能，当出现SYN等待队列溢出时，启用Cookies来处理，可防范少量SYN攻击</span><br><span class="line">    echo &#x27;net.ipv4.tcp_syncookies = 1&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 表示当keepalive启用时，TCP发送keepalive消息的频度，默认是2小时，建议更改为10分钟</span><br><span class="line">    echo &#x27;net.ipv4.tcp_keepalive_time =600&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 该选项用来设定允许系统打开的端口范围，即用于向外链接的端口范围</span><br><span class="line">    echo &#x27;net.ipv4.ip_local_port_range = 32768   60999&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 表示SYN队列的长度 默认为1024 建议加大队列的长度，为8182或更多</span><br><span class="line">    #   这样可以容纳更多等待链接的网络连接数，该参数为服务器端用于记录那些尚未收到客户端确认信息的链接请求的最大值</span><br><span class="line">    echo &#x27;net.ipv4.tcp_max_syn_backlog = 8182&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 该选项默认值是128，这个参数用于调节系统同时发起的TCP连接数，在高并发的请求中，默认的值可能会导致链接超时或重传，因此，需要结合并发请求数来调节此值</span><br><span class="line">    echo &#x27;net.core.somaxconn = 1024&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数值，TIME_WAIT套接字将立刻被清除并打印警告信息，默认为5000</span><br><span class="line">    #   对于Aapache，Nginx等服务器来说可以将其调低一点，如改为5000-30000，不用业务的服务器也可以给大一点，比如LVS，Squid</span><br><span class="line">    echo &#x27;net.ipv4.tcp_max_tw_buckets = 5000&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 表示内核放弃建立链接之前发送SYN包的数量 默认是6</span><br><span class="line">    echo &#x27;net.ipv4.tcp_syn_retries = 1&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 参数的值决定了内核放弃链接之前发送SYN+ACK包的数量 默认是2</span><br><span class="line">    echo &#x27;net.ipv4.tcp_synack_retries = 1&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 表示当每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许发送到队列的数据包最大数 默认值为1000</span><br><span class="line">    echo &#x27;net.core.netdev_max_backlog = 1000&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">    # - 用于设定系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上，如果超过这个数值，孤立链接将立即被复位并打印出警号信息</span><br><span class="line">    #   这个限制只是为了防止简单的DoS攻击，不能过分依靠这个限制甚至人为减小这个值，更多的情况是增加这个值，默认是4096，建议该值修改为2000</span><br><span class="line">    echo &#x27;net.ipv4.tcp_max_orphans = 2000&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">    # - 以下参数是对iptables防火墙的优化</span><br><span class="line">    # CentOS7.X系统中的模块名不是ip_conntrack，而是nf_conntrack</span><br><span class="line">    echo</span><br><span class="line">    &#x27;net.ipv4.nf_conntrack_max = 25000000</span><br><span class="line">    net.ipv4.netfilter.nf_conntrack_max = 25000000</span><br><span class="line">    net.ipv4.netfilter.nf_conntrack_tcp_timeout_established = 180</span><br><span class="line">    net.ipv4.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</span><br><span class="line">    net.ipv4.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</span><br><span class="line">    net.ipv4.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">    sysctl –p</span><br><span class="line"></span><br><span class="line">    # - 优化文件描述符</span><br><span class="line">    echo &#x27;  *  -  nofile   100000  &#x27;  &gt;&gt;/etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">    # 更新系统</span><br><span class="line">    yum update -y</span><br><span class="line"></span><br><span class="line">    # 修改主机名</span><br><span class="line">    hostnamectl --static set-hostname $hostname</span><br><span class="line">    NetMod</span><br><span class="line">    echo &quot;#!/bin/bash</span><br><span class="line">umount /home</span><br><span class="line">fdisk -S 56 /dev/vdb &lt;&lt; EOF</span><br><span class="line">d</span><br><span class="line">n</span><br><span class="line">p</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">wq</span><br><span class="line">EOF</span><br><span class="line">resize2fs -f /dev/vdb1</span><br><span class="line">mount -a&quot; &gt;&gt; /root/disk.sh</span><br><span class="line">    cat &gt; /root/set.sh &lt;&lt;EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">(echo &quot;passwdtemp&quot;;sleep 1;echo &quot;passwdtemp&quot;)  passwd &gt; /dev/null</span><br><span class="line">hostnamectl --static set-hostname vmnametemp</span><br><span class="line">sed -i &quot;s/\/root\/set.sh//g&quot; /etc/rc.d/rc.local</span><br><span class="line">tempdata=tempdisksize</span><br><span class="line">if [ \$tempdata -gt 0 ];then</span><br><span class="line">    /root/disk.sh</span><br><span class="line">fi</span><br><span class="line">rm -rf /root/disk.sh</span><br><span class="line">rm /root/set.sh</span><br><span class="line">reboot</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    chmod +x /root/set.sh</span><br><span class="line">    chmod +x /root/disk.sh</span><br><span class="line">    chmod +x /etc/rc.d/rc.local</span><br><span class="line">    ls -la /root/set.sh</span><br><span class="line">    ls -la /etc/rc.d/rc.local</span><br><span class="line"></span><br><span class="line">    fdisk -S 56 /dev/vdb &lt;&lt; EOF</span><br><span class="line">n</span><br><span class="line">p</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">wq</span><br><span class="line">EOF</span><br><span class="line">    mkfs.ext4 /dev/vdb1</span><br><span class="line">    echo &quot;/dev/vdb1            /home       ext4        defaults    0   0&quot; &gt;&gt; /etc/fstab</span><br><span class="line">    mount -a</span><br><span class="line">    df -vh</span><br><span class="line">    cat &gt; /etc/sysconfig/grub &lt;&lt;EOF</span><br><span class="line">GRUB_TIMEOUT=5</span><br><span class="line">GRUB_DEFAULT=saved</span><br><span class="line">GRUB_DISABLE_SUBMENU=true</span><br><span class="line">GRUB_TERMINAL_OUTPUT=&quot;console&quot;</span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;crashkernel=auto rhgb net.ifnames=0 biosdevname=0 quiet&quot;</span><br><span class="line">GRUB_DISABLE_RECOVERY=&quot;true&quot;</span><br><span class="line">EOF</span><br><span class="line">    grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line">    rm -f /etc/udev/rules.d/*persistent-net.rules</span><br><span class="line">    history -c</span><br><span class="line">    [ $? -eq 0 ] &amp;&amp; Echo &quot;success&quot; &quot;KVM模板制作成功&quot;</span><br><span class="line">    shutdown -h 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NetMod() &#123;</span><br><span class="line">    cat &gt; /etc/sysconfig/network &lt;&lt;EOF</span><br><span class="line">GATEWAY=</span><br><span class="line">EOF</span><br><span class="line">    cat &gt; $eth0f &lt;&lt;EOF</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=eth0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=</span><br><span class="line">NETMASK=</span><br><span class="line">EOF</span><br><span class="line">    cat &gt; $eth1f &lt;&lt;EOF</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">NAME=eth1</span><br><span class="line">DEVICE=eth1</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=</span><br><span class="line">NETMASK=</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Main</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2017/04/13/centos7%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%B6%E4%BD%9Ckvm%E6%A8%A1%E6%9D%BF/" data-id="clc4klg4p001fojobd6y4gy5g" data-title="Centos7环境下制作kvm模板" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/21/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="page-number" href="/page/21/">21</a><span class="page-number current">22</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/23/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Django/">Django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flask/">Flask</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue/">Vue</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%89%8D%E7%AB%AF/">Web前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/">cloud</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/Kubernetes/">Kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/Kvm/">Kvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/OpenStack/">OpenStack</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/monitoring-tools/">monitoring-tools</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/monitoring-tools/Prometheus/">Prometheus</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/uncategorized/">uncategorized</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-jiqun/">web-jiqun</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web-jiqun/%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4/">分布式集群</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-jiqun/%E7%BD%91%E7%AB%99%E9%9B%86%E7%BE%A4/">网站集群</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/">yunwei-tools</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/Cmd/">Cmd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/Shell/">Shell</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/">经验分享</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/">集群架构</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/auto/" rel="tag">auto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/" rel="tag">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/" rel="tag">ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wdcp/" rel="tag">wdcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91/" rel="tag">云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="tag">虚拟化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/auto/" style="font-size: 10px;">auto</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/kvm/" style="font-size: 10px;">kvm</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/tags/vue/" style="font-size: 20px;">vue</a> <a href="/tags/wdcp/" style="font-size: 10px;">wdcp</a> <a href="/tags/%E4%BA%91/" style="font-size: 10px;">云</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 10px;">虚拟化</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E5%88%87%E7%89%87/">Go语言中切片</a>
          </li>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%ADmap/">Go语言中map</a>
          </li>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E5%87%BD%E6%95%B0/">Go语言中函数</a>
          </li>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%BB%93%E6%9E%84%E4%BD%93/">Go语言中结构体</a>
          </li>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E5%8C%85/">Go语言中包</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 Ropon<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>