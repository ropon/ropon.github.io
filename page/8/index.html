<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Ropon运维</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Ropon运维,Ropon,Go,DevOps,k8s,CI&#x2F;CD,Prometheus,Shell,Python">
<meta property="og:type" content="website">
<meta property="og:title" content="Ropon运维">
<meta property="og:url" content="https://blog.ropon.top/page/8/index.html">
<meta property="og:site_name" content="Ropon运维">
<meta property="og:description" content="Ropon运维,Ropon,Go,DevOps,k8s,CI&#x2F;CD,Prometheus,Shell,Python">
<meta property="og:locale">
<meta property="article:author" content="Ropon">
<meta property="article:tag" content="Ropon运维,Ropon,Go,DevOps,CI&#x2F;CD,运维平台,k8s,Prometheus,Shell,Python,Kvm,OpenStack">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Ropon运维" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Ropon运维</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.ropon.top"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-k8s使用-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/07/02/k8s%E4%BD%BF%E7%94%A8-1/" class="article-date">
  <time class="dt-published" datetime="2020-07-02T06:46:18.000Z" itemprop="datePublished">2020-07-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/">集群架构</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/07/02/k8s%E4%BD%BF%E7%94%A8-1/">k8s使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li>kubectl创建别名</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias k=kubectl</span><br></pre></td></tr></table></figure>

<ul>
<li>tab补全命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bash-completion</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash  sed s/kubectl/k/g)</span><br></pre></td></tr></table></figure>

<ul>
<li>kubernets运行应用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl run kubia --image=luksa/kubia --port=8080 --generator=run/v1</span><br><span class="line">#--image=luksa/kubia 容器运行时所需镜像</span><br><span class="line">#--port=8080 监听8080端口</span><br></pre></td></tr></table></figure>

<ul>
<li>创建一个服务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#创建一个LoadBalancer服务</span><br><span class="line">kubectl expose pod kubia --type=LoadBalancer --name kubia-http</span><br><span class="line">#查看</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl scale rc nginx-test --replicas=3 </span><br></pre></td></tr></table></figure>

<ul>
<li>公共配置参数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--log-backtrace-at traceLocation 记录日志每到 file:行号时打印一次stack trace 默认值0</span><br><span class="line">--log-dir string 日志文件路径</span><br><span class="line">--log-flush-frequency duration 设置flush日志文件的时间间隔 默认值5s</span><br><span class="line">--logtostderr 设置为true表示将日志输出到stderr 不输出到日志文件</span><br><span class="line">--alsologtostderr 设置为true表示将日志输出到日志文件同时输出到stderr</span><br><span class="line">--stderrthreshold severity 将threshold级别以上的日志输出到stderr 默认值2</span><br><span class="line">--v Level 配置日志级别</span><br><span class="line">--vmodule moduleSpec 详细日志级别</span><br><span class="line">--version version[=true] 输出其版本号</span><br></pre></td></tr></table></figure>

<ul>
<li>kube-apiserver 启动参数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">--admission-control strings 对发送给apiserver的任何请求进行准入控制 配置为一个准入控制器列表</span><br><span class="line">AlwaysAdmit 运行所有请求</span><br><span class="line">AlwaysDeny 禁止所有请求</span><br><span class="line">AlwaysPullImages 启动容器之前总是去下载镜像</span><br><span class="line">DefaultStorageClass 实现共享存储动态供应 为未指定StorageClass或PV的PVC匹配默认StorageClass</span><br><span class="line">DefaultTolerationSeconds 设置默认容忍时间 5min</span><br><span class="line">DenyEscalatingExec 拦截 所有exec和attach到具有特权的Pod上的请求</span><br><span class="line">DenyExecOnPrivileged 拦截所有想在privileged container上执行命令的请求</span><br><span class="line">ImagePolicyWebhook 允许后端webhook程序完成admission controller</span><br><span class="line">LimitRanger 配额管理</span><br><span class="line">NamespaceLifecycle 拒绝在不存在namespace中创建资源对象的请求 删除namespace时删除所有对象</span><br><span class="line">PodPreset pod启动时注入应用所需设置</span><br><span class="line">PodSecurityPolicy 对pod进行安全策略控制</span><br><span class="line">ResourceQuota 配额管理</span><br><span class="line">……</span><br><span class="line">--advertise-address ip 广播给集群所有成员自己的IP地址</span><br><span class="line">--allow-privileged 配置为true 运行pod中运行拥有系统特权的容器应用</span><br><span class="line">--anonymous-auth 配置为true表示apiserver接收匿名请求 默认值true</span><br><span class="line">--apiserver-count 集群中运行apiserver数量 默认值1</span><br><span class="line">--authorization-mode 认证模式列表 多个以逗号分隔</span><br></pre></td></tr></table></figure>

<h4 id="Pod-资源文件详细说明"><a href="#Pod-资源文件详细说明" class="headerlink" title="Pod 资源文件详细说明"></a>Pod 资源文件详细说明</h4><p>属性名称</p>
<p>取值类型</p>
<p>是否必需</p>
<p>取值说明</p>
<p>version</p>
<p>String</p>
<p>yes</p>
<p>v1</p>
<p>kind</p>
<p>String</p>
<p>yes</p>
<p>Pod</p>
<p>metadata</p>
<p>Object</p>
<p>yes</p>
<p>元数据</p>
<p>metadata.name</p>
<p>String</p>
<p>yes</p>
<p>Pod的名称</p>
<p>metadata.namespace</p>
<p>String</p>
<p>yes</p>
<p>Pod所属名称空间</p>
<p>metadata.labels[]</p>
<p>List</p>
<p>自定义标签列表</p>
<p>metadata.annotation[]</p>
<p>List</p>
<p>自定义注解列表</p>
<p>spec</p>
<p>Object</p>
<p>yes</p>
<p>Pod中容器详细定义</p>
<p>spec.containers[]</p>
<p>List</p>
<p>yes</p>
<p>Pod中的容器列表</p>
<p>spec.containers[].name</p>
<p>String</p>
<p>yes</p>
<p>容器的名称</p>
<p>spec.containers[].image</p>
<p>String</p>
<p>yes</p>
<p>容器的镜像名称</p>
<p>spec.containers[].imagePullPolicy</p>
<p>String</p>
<p>获取镜像策略</p>
<p>spec.containers[].command[]</p>
<p>List</p>
<p>容器启动命令列表</p>
<p>spec.containers[].args[]</p>
<p>List</p>
<p>启动命令参数列表</p>
<p>spec.containers[].workingDir</p>
<p>String</p>
<p>容器工作目录</p>
<p>spec.containers[].volumeMounts[]</p>
<p>List</p>
<p>容器存储卷配置</p>
<p>spec.containers[].volumeMounts[].name</p>
<p>String</p>
<p>共享存储卷名称</p>
<p>spec.containers[].volumeMounts[].mountPath</p>
<p>String</p>
<p>存储卷容器内挂载绝对路径</p>
<p>spec.containers[].volumeMounts[].readOnly</p>
<p>Boolean</p>
<p>是否只读模式，默认读写模式</p>
<p>spec.containers[].ports[]</p>
<p>List</p>
<p>容器暴露的端口号列表</p>
<p>spec.containers[].ports[].name</p>
<p>String</p>
<p>端口的名称</p>
<p>spec.containers[].ports[].containerPort</p>
<p>Int</p>
<p>容器需要监听的端口号</p>
<p>spec.containers[].ports[].hostPort</p>
<p>Int</p>
<p>默认与containerPort一致</p>
<p>spec.containers[].ports[].protocol</p>
<p>String</p>
<p>端口协议TCP UDP 默认TCP</p>
<p>spec.containers[].env[]</p>
<p>List</p>
<p>容器需要环境变量列表</p>
<p>spec.containers[].env[].name</p>
<p>String</p>
<p>环境变量的名称</p>
<p>spec.containers[].env[].value</p>
<p>String</p>
<p>环境变量的值</p>
<p>spec.containers[].resources</p>
<p>Object</p>
<p>资源限制和资源请求设置</p>
<p>spec.containers[].resources.limits</p>
<p>Object</p>
<p>资源限制的设置</p>
<p>spec.containers[].resources.limits.cpu</p>
<p>String</p>
<p>CPU限制 单位为core数</p>
<p>spec.containers[].resources.limits.memory</p>
<p>String</p>
<p>内存限制 单位MiB&#x2F;GiB</p>
<p>spec.containers[].resources.requests</p>
<p>Object</p>
<p>请求限制的设置</p>
<p>spec.containers[].resources.requests.cpu</p>
<p>String</p>
<p>CPU请求 单位为core数</p>
<p>spec.containers[].resources.requests.memory</p>
<p>String</p>
<p>内存请求 单位MiB&#x2F;GiB</p>
<p>spec.volumes[]</p>
<p>List</p>
<p>Pod定义共享存储卷列表</p>
<p>spec.volumes[].name</p>
<p>String</p>
<p>共享存储卷的名称</p>
<p>spec.volumes[].emptyDir</p>
<p>Object</p>
<p>与Pod同生命周期的临时目录</p>
<p>spec.volumes[].hostPath</p>
<p>Object</p>
<p>Pod所在宿主机的目录</p>
<p>spec.volumes[].hostPath.path</p>
<p>String</p>
<p>Pod所在在主机的目录</p>
<p>spec.volumes[].secret</p>
<p>Object</p>
<p>挂载预定义secret对象到容器</p>
<p>spec.volumes[].configMap</p>
<p>Object</p>
<p>挂载预定义configMap对象到容器</p>
<p>spec.volumes[].livenessProbe</p>
<p>Object</p>
<p>健康检查配置</p>
<p>spec.volumes[].livenessProbe.exec</p>
<p>Object</p>
<p>使用exec方式</p>
<p>spec.volumes[].livenessProbe.exec.command[]</p>
<p>String</p>
<p>指定命令或脚本</p>
<p>spec.volumes[].livenessProbe.httpGet</p>
<p>Object</p>
<p>使用httpGet方式 path prot</p>
<p>spec.volumes[].livenessProbe.tcpSocket</p>
<p>Object</p>
<p>使用tcpSocket方式</p>
<p>spec.volumes[].livenessProbe.initialDelaySeconds</p>
<p>Number</p>
<p>启动后首次探测时间 单位s</p>
<p>spec.volumes[].livenessProbe.timeoutSeconds</p>
<p>Number</p>
<p>探测超时时间 默认1s</p>
<p>spec.volumes[].livenessProbe.periodSeconds</p>
<p>Number</p>
<p>探测时间间隔 默认10s</p>
<p>spec.restartPolicy</p>
<p>String</p>
<p>重启策略</p>
<p>spec.nodeSelector</p>
<p>Object</p>
<p>Pod调度到包含label的Node key:value格式指定</p>
<p>spec.imagePullSecrets</p>
<p>Object</p>
<p>Pull镜像使用secret</p>
<p>spec.hostNetwork</p>
<p>Boolean</p>
<p>是否使用主机网络模式</p>
<h4 id="Pod-资源文件详细说明-1"><a href="#Pod-资源文件详细说明-1" class="headerlink" title="Pod 资源文件详细说明"></a>Pod 资源文件详细说明</h4><p>属性名称</p>
<p>取值类型</p>
<p>是否必需</p>
<p>取值说明</p>
<p>version</p>
<p>String</p>
<p>yes</p>
<p>v1</p>
<p>kind</p>
<p>String</p>
<p>yes</p>
<p>Pod</p>
<p>metadata</p>
<p>Object</p>
<p>yes</p>
<p>元数据</p>
<p>metadata.name</p>
<p>String</p>
<p>yes</p>
<p>Pod的名称</p>
<p>metadata.namespace</p>
<p>String</p>
<p>yes</p>
<p>Pod所属名称空间</p>
<p>metadata.labels[]</p>
<p>List</p>
<p>自定义标签列表</p>
<p>metadata.annotation[]</p>
<p>List</p>
<p>自定义注解列表</p>
<p>spec</p>
<p>Object</p>
<p>yes</p>
<p>Pod中容器详细定义</p>
<p>spec.selector[]</p>
<p>List</p>
<p>yes</p>
<p>选择指定label标签的Pod</p>
<p>spec.type</p>
<p>String</p>
<p>yes</p>
<p>service的类型默认ClusterIP</p>
<p>spec.clusterIP</p>
<p>String</p>
<p>虚拟服务IP地址</p>
<p>spec.sessionAffinity</p>
<p>String</p>
<p>是否支持session 默认为空 可选ClientIP 同一客户端到同一后端Pod</p>
<p>spec.ports[]</p>
<p>List</p>
<p>service需要暴露端口列表</p>
<p>spec.ports[].name</p>
<p>String</p>
<p>端口名称</p>
<p>spec.ports[].protocol</p>
<p>String</p>
<p>端口协议 TCP UDP 默认TCP</p>
<p>spec.ports[].port</p>
<p>int</p>
<p>服务监听端口号</p>
<p>spec.ports[].targetPort</p>
<p>int</p>
<p>需要转发到后端Pod的端口号</p>
<p>spec.ports[].nodePort</p>
<p>int</p>
<p>当type&#x3D;NodePort时 映射宿主机端口号</p>
<p>status</p>
<p>object</p>
<p>当type&#x3D;LoadBalancer时 设置外部负载均衡器地址</p>
<p>status.loadBalancer</p>
<p>object</p>
<p>外部负载均衡器</p>
<p>status.loadBalancer.ingress</p>
<p>object</p>
<p>外部负载均衡器</p>
<p>status.loadBalancer.ingress.ip</p>
<p>string</p>
<p>外部负载均衡器的IP地址</p>
<p>status.loadBalancer.ingress.hostname</p>
<p>string</p>
<p>外部负载均衡器的主机名</p>
<h4 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it podname -c containername -n namespace -- shell command</span><br></pre></td></tr></table></figure>

<h4 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1  #注意版本号</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dep</span><br><span class="line">spec:</span><br><span class="line">  selector:  #属性，选择器</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 1  #管理的副本个数</span><br><span class="line">  template:  #模板属性</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        volumeMounts:  #定义挂载卷</span><br><span class="line">        - mountPath: &quot;/var/log/nginx&quot;</span><br><span class="line">          name: nginx-vol</span><br><span class="line">      - name: busybox</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;tail -f /logs/access.log&quot;]</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /logs</span><br><span class="line">          name: nginx-vol</span><br><span class="line">      volumes:   #定义共享卷</span><br><span class="line">      - name: nginx-vol</span><br><span class="line">        emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CONFIGMAP"><a href="#CONFIGMAP" class="headerlink" title="CONFIGMAP"></a>CONFIGMAP</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap user-config --from-file=./</span><br><span class="line">kubectl create configmap log-config --from-file=./2.txt</span><br><span class="line">#查看</span><br><span class="line">kubectl get cm/user-config -o yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1  #注意版本号</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: test-configmap</span><br><span class="line">data:</span><br><span class="line">  apploglevel: info</span><br><span class="line">  appdatadir: /var/data</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1  #注意版本号</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dep-configmap</span><br><span class="line">spec:</span><br><span class="line">  selector:  #属性，选择器</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 1  #管理的副本个数</span><br><span class="line">  template:  #模板属性</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: busybox</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;env  grep APP&quot;]</span><br><span class="line">        env:</span><br><span class="line">        - name: APPLOGLEVEL</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">              name: test-configmap</span><br><span class="line">              key: apploglevel</span><br><span class="line">        - name: APPDATADIR</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">              name: test-configmap</span><br><span class="line">              key: appdatadir</span><br><span class="line">      restartPolicy: Never        </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#envFrom</span><br><span class="line">apiVersion: apps/v1  #注意版本号</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dep-configmap</span><br><span class="line">spec:</span><br><span class="line">  selector:  #属性，选择器</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 1  #管理的副本个数</span><br><span class="line">  template:  #模板属性</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: busybox</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;env&quot;]</span><br><span class="line">        envFrom:</span><br><span class="line">        - configMapRef:</span><br><span class="line">            name: test-configmap</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#configmap热更新</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: reload-config</span><br><span class="line">data:</span><br><span class="line">  logLevel: INFO</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">#apiVersion: apps/v1 要加上selector</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ig</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: reload-volume</span><br><span class="line">          mountPath: /etc/config</span><br><span class="line">      volumes:</span><br><span class="line">      - name: reload-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: reload-config</span><br><span class="line"></span><br><span class="line">kubectl exec nginx-ig-b898c76f5-2w8ws -it -- cat /etc/config/logLevel</span><br><span class="line">kubectl edit configmaps reload-config</span><br><span class="line">kubectl exec nginx-ig-b898c76f5-2w8ws -it -- cat /etc/config/logLevel</span><br><span class="line">#注意：使用configmap挂载env不会同步更新，使用configmap挂载volume的中数据需要一段时间（10s）才能同步更新</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#将pod信息注入环境变量</span><br><span class="line">apiVersion: apps/v1  #注意版本号</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dep-configmap</span><br><span class="line">spec:</span><br><span class="line">  selector:  #属性，选择器</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 1  #管理的副本个数</span><br><span class="line">  template:  #模板属性</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: busybox</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;env&quot;]</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: MY_POD_IP</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: status.podIP   </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#将资源限制信息注入环境变量</span><br><span class="line">apiVersion: apps/v1  #注意版本号</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-dep-configmap</span><br><span class="line">spec:</span><br><span class="line">  selector:  #属性，选择器</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 1  #管理的副本个数</span><br><span class="line">  template:  #模板属性</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: busybox</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sh&quot;, &quot;-c&quot;, &quot;env&quot;]</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;32Mi&quot;</span><br><span class="line">            cpu: &quot;125m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;64Mi&quot;</span><br><span class="line">            cpu: &quot;250m&quot;</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_CPU_REQUEST</span><br><span class="line">          valueFrom:</span><br><span class="line">            resourceFieldRef:</span><br><span class="line">              containerName: busybox</span><br><span class="line">              resource: requests.cpu</span><br><span class="line">        - name: MY_MEM_LIMIT</span><br><span class="line">          valueFrom:</span><br><span class="line">            resourceFieldRef:</span><br><span class="line">              containerName: busybox</span><br><span class="line">              resource: limits.memory      </span><br></pre></td></tr></table></figure>

<h4 id="Pod健康检查"><a href="#Pod健康检查" class="headerlink" title="Pod健康检查"></a>Pod健康检查</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#livenessProbe 检查容器是否存活(running)</span><br><span class="line">#1.ExecAction 容器内执行命令，改命令返回码为0表明容器健康</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    test: liveness</span><br><span class="line">  name: liveness-exec</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: busybox</span><br><span class="line">    command: [&quot;sh&quot;, &quot;-c&quot;, &quot;echo ok &gt; /tmp/health&quot;,&quot;sleep 10&quot;,&quot;rm -rf /tmp/health&quot;,&quot;sleep 600&quot;]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      exec:</span><br><span class="line">        command: [&quot;cat&quot;, &quot;/tmp/health&quot;]</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">#2.TCPSocketAction</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-socket</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 81</span><br><span class="line">      #首次探测时间  </span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      #每隔多少s探测一次</span><br><span class="line">      periodSeconds: 2</span><br><span class="line">      #检查失败尝试几次</span><br><span class="line">      failureThreshold: 3</span><br><span class="line">#3.HTTPGetAction</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-http</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx</span><br><span class="line">    image: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: /index1.html</span><br><span class="line">        port: 80</span><br><span class="line">      #首次探测时间  </span><br><span class="line">      initialDelaySeconds: 20</span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">      #检查失败尝试几次</span><br><span class="line">      failureThreshold: 3</span><br><span class="line"></span><br><span class="line">#ReadinessProbe 检查容器是否启动完成(ready)</span><br></pre></td></tr></table></figure>

<h4 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#公平</span><br><span class="line">#资源利用率高</span><br><span class="line">#效率</span><br><span class="line">#灵活</span><br><span class="line"></span><br><span class="line">#自定义调度器</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod               </span><br><span class="line">metadata:                       </span><br><span class="line">  name: busybox</span><br><span class="line">  labels:</span><br><span class="line">    name: bb-test</span><br><span class="line">spec:</span><br><span class="line">  schedulername: my-scheduler</span><br><span class="line">  containers:</span><br><span class="line">  - image: busybox</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    name: busybox   </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#节点亲和性</span><br><span class="line">#requiredDuringSchedulingIgnoredDuringExecution 硬策略</span><br><span class="line">#preferredDuringSchedulingIgnoredDuringExecution 软策略</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: with-node-affinity</span><br><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    nodeAffinity:</span><br><span class="line">      #硬策略</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">        nodeSelectorTerms:</span><br><span class="line">        - matchExpressions:</span><br><span class="line">          - key: kubernetes.io/hostname</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - 192.168.7.152</span><br><span class="line">  containers:</span><br><span class="line">  - name: with-node-affinity</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: with-node-affinity2</span><br><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    nodeAffinity:</span><br><span class="line">      #硬策略</span><br><span class="line">      preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">      - weight: 1</span><br><span class="line">        preference:</span><br><span class="line">          matchExpressions:</span><br><span class="line">          - key: kubernetes.io/hostname</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - 192.168.7.153</span><br><span class="line">  containers:</span><br><span class="line">  - name: with-node-affinity2</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: &quot;IfNotPresent&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#键值运算关系</span><br><span class="line">In label的值在某个列表中</span><br><span class="line">NotIn label的值不在某个列表中</span><br><span class="line">Gt label的值大于某个值</span><br><span class="line">Lt label的值小于某个值</span><br><span class="line">Exists 某个label存在</span><br><span class="line">DoesNotExist 某个label不存在</span><br></pre></td></tr></table></figure>

<h4 id="Pod调度"><a href="#Pod调度" class="headerlink" title="Pod调度"></a>Pod调度</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">#requiredDuringSchedulingIgnoredDuringExecution 硬策略</span><br><span class="line">#preferredDuringSchedulingIgnoredDuringExecution 软策略</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: with-pod-affinity</span><br><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    podAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">      - labelSelector:</span><br><span class="line">          matchExpressions:</span><br><span class="line">          - key: app</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - pod-1</span><br><span class="line">        topologyKey: kubernetes.io/hostname</span><br><span class="line">  containers:</span><br><span class="line">  - name: with-pod-affinity</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: with-pod-affinity2</span><br><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    podAntiAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">      - labelSelector:</span><br><span class="line">          matchExpressions:</span><br><span class="line">          - key: app</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - pod-1</span><br><span class="line">        topologyKey: kubernetes.io/hostname</span><br><span class="line">  containers:</span><br><span class="line">  - name: with-pod-affinity</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line"></span><br><span class="line">#1.Deployment 全自动调度</span><br><span class="line">#2.定向调度 NodeSelector</span><br><span class="line">#给Node打标签</span><br><span class="line">kubectl label nodes node-01 key=val</span><br><span class="line">#查看标签</span><br><span class="line">kubectl get nodes --show-labels</span><br><span class="line">#删除标签</span><br><span class="line">kubectl label nodes node-01 key-</span><br><span class="line">#修改标签</span><br><span class="line">kubectl label nodes node-01 key=val2 --overwirte</span><br><span class="line">#例子</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod               </span><br><span class="line">metadata:                       </span><br><span class="line">  name: busybox</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: busybox</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    name: busybox   </span><br><span class="line">  nodeSelector:</span><br><span class="line">    zone: north</span><br><span class="line"></span><br><span class="line">#NodeAffinity Node亲和性调度  </span><br><span class="line">#PodAffinity</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#亲和性/反亲和性调度策略</span><br><span class="line">调度策略         匹配标签             操作符                是否支持拓扑域  调度目标</span><br><span class="line">nodeAffinity    节点 In,NotIn,Exists,DoesNotExist,Gt,Lt    否          指定主机</span><br><span class="line">podAffinity     Pod    In,NotIn,Exists,DoesNotExist       是     Pod与指定Pod同一拓扑域</span><br><span class="line">podAntiAffinity Pod    In,NotIn,Exists,DoesNotExist       是     Pod与指定Pod同一拓扑域</span><br></pre></td></tr></table></figure>

<h4 id="污点-Taint-容忍-Toleration"><a href="#污点-Taint-容忍-Toleration" class="headerlink" title="污点(Taint) 容忍(Toleration)"></a>污点(Taint) 容忍(Toleration)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#Taint</span><br><span class="line">key=value:effect</span><br><span class="line">每个污点有一个key和value作为污点标签，其中value可以为空，effect描述污点作用</span><br><span class="line">effect支持：</span><br><span class="line">NoSchedule: 不会将pod调度到具有此污点的Node上</span><br><span class="line">PreferNoSchedule: 尽量避免将pod调度到具有此污点的Node上</span><br><span class="line">NoExecute: 不会将pod调度到具有此污点的Node上，同时将Node上已存在Pod驱逐出去</span><br><span class="line"></span><br><span class="line">污点设置</span><br><span class="line">kubectl taint nodes 192.168.7.152 check=ropon:NoExecute</span><br><span class="line">查看</span><br><span class="line">kubectl describe node 192.168.7.152grep Taints</span><br><span class="line">删除</span><br><span class="line">kubectl taint nodes 192.168.7.152 check:NoExecute-</span><br><span class="line"></span><br><span class="line">#Toleration</span><br><span class="line">pod.spec.tolerations</span><br><span class="line"></span><br><span class="line">tolerations:</span><br><span class="line">- key: &quot;check&quot;</span><br><span class="line">  operator: &quot;Exists&quot;</span><br><span class="line">  value: &quot;ropon&quot;</span><br><span class="line">  effect: &quot;NoSchedule&quot;</span><br><span class="line">  #停留在node污点的时间</span><br><span class="line">  tolerationSeconds: 60</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: with-pod-affinity2</span><br><span class="line">spec:</span><br><span class="line">  affinity:</span><br><span class="line">    podAntiAffinity:</span><br><span class="line">      requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">      - labelSelector:</span><br><span class="line">          matchExpressions:</span><br><span class="line">          - key: app</span><br><span class="line">            operator: In</span><br><span class="line">            values:</span><br><span class="line">            - pod-1</span><br><span class="line">        topologyKey: kubernetes.io/hostname</span><br><span class="line">  tolerations:</span><br><span class="line">  - key: &quot;check&quot;</span><br><span class="line">    operator: &quot;Equal&quot;</span><br><span class="line">    value: &quot;ropon&quot;</span><br><span class="line">    effect: &quot;NoExecute&quot;</span><br><span class="line">    tolerationSeconds: 60</span><br><span class="line">  containers:</span><br><span class="line">  - name: with-pod-affinity</span><br><span class="line">    image: nginx</span><br><span class="line">    imagePullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line"></span><br><span class="line">其中key,value,effect与Node上设置taint必须一致</span><br><span class="line">operator的值Exists将会忽略value值</span><br><span class="line">tolerationSeconds 描述当前Pod需要被驱逐时在Node上保留运行时间</span><br><span class="line"></span><br><span class="line">不指定key值时容忍所有污点key</span><br><span class="line">tolerations:</span><br><span class="line">- operator: &quot;Exists&quot;</span><br><span class="line"></span><br><span class="line">不指定effect值时容忍所有污点作用</span><br><span class="line">tolerations:</span><br><span class="line">- key: &quot;key&quot;</span><br><span class="line">  operator: &quot;Exists&quot;</span><br></pre></td></tr></table></figure>

<h4 id="DaemonSet-每个Node上调度一个Pod"><a href="#DaemonSet-每个Node上调度一个Pod" class="headerlink" title="DaemonSet 每个Node上调度一个Pod"></a>DaemonSet 每个Node上调度一个Pod</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#守护进程</span><br><span class="line">#日志采集</span><br><span class="line">#监控程序</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet               </span><br><span class="line">metadata:                       </span><br><span class="line">  name: daemonset-demo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: testbb </span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: testbb</span><br><span class="line">    spec:    </span><br><span class="line">      containers:</span><br><span class="line">      - image: busybox</span><br><span class="line">        command:</span><br><span class="line">        - sleep</span><br><span class="line">        - &quot;3600&quot;</span><br><span class="line">        name: busybox</span><br></pre></td></tr></table></figure>

<h4 id="Job-批处理调度"><a href="#Job-批处理调度" class="headerlink" title="Job 批处理调度"></a>Job 批处理调度</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#spec.template格式同Pod</span><br><span class="line">#RestartPolicy仅支持Never或OnFailure</span><br><span class="line">#单个Pod时，默认Pod成功运行后Job即结束</span><br><span class="line">#spec.completions标志Job结束需要成功运行的Pod个数，默认为1</span><br><span class="line">#spec.parallelism标志并运行Pod个数，默认为1</span><br><span class="line">#spec.activeDeadlineSeconds标志失败Pod最大重试时间</span><br><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job               </span><br><span class="line">metadata:                       </span><br><span class="line">  name: job-demo</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: job-demo</span><br><span class="line">    spec:    </span><br><span class="line">      containers:</span><br><span class="line">      - image: busybox</span><br><span class="line">        command:</span><br><span class="line">        - sleep</span><br><span class="line">        - &quot;40&quot;</span><br><span class="line">        name: busybox</span><br><span class="line">      restartPolicy: Never  </span><br></pre></td></tr></table></figure>

<h4 id="CronJob-基于时间的Job"><a href="#CronJob-基于时间的Job" class="headerlink" title="CronJob 基于时间的Job"></a>CronJob 基于时间的Job</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#spec.schedule 调度必需字段，指定任务运行周期</span><br><span class="line">#spec.jobTemplate Job模板必需字段，指定需要运行的任务</span><br><span class="line">#spec.startingDeadlineSeconds启动Job期限</span><br><span class="line">#spec.concurrencyPolicy并发策略，默认Allow Forbid禁止并发 Replace 取消当前用新替换</span><br><span class="line">apiVersion: batch/v1beta1</span><br><span class="line">kind: CronJob               </span><br><span class="line">metadata:                       </span><br><span class="line">  name: cronjob-demo</span><br><span class="line">spec:</span><br><span class="line">  schedule: &quot;*/1 * * * *&quot;</span><br><span class="line">  jobTemplate:</span><br><span class="line">    spec:</span><br><span class="line">      template:</span><br><span class="line">        spec:    </span><br><span class="line">          containers:</span><br><span class="line">          - image: busybox</span><br><span class="line">            command:</span><br><span class="line">            - sh</span><br><span class="line">            - -c</span><br><span class="line">            - date;echo hello world</span><br><span class="line">            name: busybox</span><br><span class="line">          restartPolicy: OnFailure  </span><br></pre></td></tr></table></figure>

<h4 id="Service-服务"><a href="#Service-服务" class="headerlink" title="Service 服务"></a>Service 服务</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#Cluster默认类型</span><br><span class="line">#NodePort</span><br><span class="line">#LoadBalancer</span><br><span class="line">#ExternalName</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1  #注意版本号</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-dep</span><br><span class="line">spec:</span><br><span class="line">  selector:  #属性，选择器</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp</span><br><span class="line">  replicas: 3  #管理的副本个数</span><br><span class="line">  template:  #模板属性</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myapp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp</span><br><span class="line">        image: nginx</span><br><span class="line">        imagePullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">---     </span><br><span class="line">apiVersion: v1  #注意版本号</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  selector:  #属性，选择器</span><br><span class="line">    app: myapp</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br></pre></td></tr></table></figure>

<h4 id="Headless-Service"><a href="#Headless-Service" class="headerlink" title="Headless Service"></a>Headless Service</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1  #注意版本号</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-headless</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: &quot;None&quot;</span><br><span class="line">  selector:  #属性，选择器</span><br><span class="line">    app: myapp</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line"></span><br><span class="line">#测试</span><br><span class="line">dig @172.20.0.23 myapp-headless.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h4 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1  #注意版本号</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-nodeport</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:  #属性，选择器</span><br><span class="line">    app: myapp</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br></pre></td></tr></table></figure>

<h4 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">实际与NodePort方式一样</span><br></pre></td></tr></table></figure>

<h4 id="ExternalName"><a href="#ExternalName" class="headerlink" title="ExternalName"></a>ExternalName</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1  #注意版本号</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-ex1</span><br><span class="line">spec:</span><br><span class="line">  type: ExternalName</span><br><span class="line">  externalName: test.ropon.top</span><br><span class="line"></span><br><span class="line">#测试</span><br><span class="line">dig @172.20.0.23 myapp-ex1.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h4 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /etc/ansible/manifests/ingress/nginx-ingress/nginx-ingress.yaml</span><br><span class="line">kubectl apply -f /etc/ansible/manifests/ingress/nginx-ingress/nginx-ingress-svc.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#ingress http</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">#apiVersion: apps/v1 要加上selector</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ig</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-svc</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    name: nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-test</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: test1.ropon.top</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx-svc</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#https ingress</span><br><span class="line">kubectl create secret tls ropon-tls --cert ropon.top.crt --key ropon.top.key</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-test-https</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - test2.ropon.top</span><br><span class="line">    secretName: ropon-tls</span><br><span class="line">  rules:</span><br><span class="line">  - host: test2.ropon.top</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx-svc</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#basicauth</span><br><span class="line">htpasswd -c auth ropon</span><br><span class="line">kubectl create secret generic basic-auth --from-file=auth</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-test-auth</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-type: basic</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-secret: basic-auth</span><br><span class="line">    nginx.ingress.kubernetes.io/auth-realm: &#x27;Authentication Required - ropon&#x27;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: test3.ropon.top</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx-svc</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#rewrite</span><br><span class="line">#nginx.ingress.kubernetes.io/rewrite-target 重定向目标URL</span><br><span class="line">#nginx.ingress.kubernetes.io/ssl-redirect</span><br><span class="line">#nginx.ingress.kubernetes.io/force-ssl-redirect 强制重定向https</span><br><span class="line">#nginx.ingress.kubernetes.io/app-root</span><br><span class="line">#nginx.ingress.kubernetes.io/use-regex 使用正则</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-test-rewrite</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: https://test2.ropon.top:23457   </span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: test4.ropon.top</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx-svc</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

<h4 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#Service Accout </span><br><span class="line">#访问kubernets api由kubernets自动创建并且自动挂载Pod的/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">#Opaque base64编码格式的secret 用来存储密码 密钥</span><br><span class="line">#kubernets.io/dockerconfigjson 用来存储私有docker registry</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#Service Accout</span><br><span class="line">kubectl exec nginx-ig-b898c76f5-2w8ws -- ls /run/secrets/kubernetes.io/serviceaccount</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#Opaque</span><br><span class="line">echo &quot;ropon&quot;base64</span><br><span class="line">echo &quot;123456&quot;base64</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata: </span><br><span class="line">  name: mysecret</span><br><span class="line">type: Opaque</span><br><span class="line">data:</span><br><span class="line">  username: cm9wb24K</span><br><span class="line">  password: MTIzNDU2Cg==</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">#apiVersion: apps/v1 要加上selector</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-secret-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: secrets</span><br><span class="line">          mountPath: &quot;/test&quot;</span><br><span class="line">          readOnly: true</span><br><span class="line">      volumes:</span><br><span class="line">      - name: secrets</span><br><span class="line">        secret:</span><br><span class="line">          secretName: mysecret</span><br><span class="line"></span><br><span class="line">#测试</span><br><span class="line">kubectl exec nginx-secret-test-5d9f5c4bc-l6jjk -- cat /test/password</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#secret导入环境变量</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">#apiVersion: apps/v1 要加上selector</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-secret-test1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        env:</span><br><span class="line">        - name: TEST_USER</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: mysecret</span><br><span class="line">              key: username</span><br><span class="line"></span><br><span class="line">#测试</span><br><span class="line">kubectl exec nginx-secret-test1-5d89cd9486-zzjw4 -- env</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#创建docker registry</span><br><span class="line">kubectl create secret docker-registry myregistrykey --docker-server= --docker-username= --docker-password= --docker-email=</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">#apiVersion: apps/v1 要加上selector</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-secret-test2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        imagePullSecrets:</span><br><span class="line">        - name: myregistrykey   </span><br></pre></td></tr></table></figure>

<h4 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#emptyDir</span><br><span class="line">#暂存空间 共享数据</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">#apiVersion: apps/v1 要加上selector</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-vol-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: cache-vol</span><br><span class="line">          mountPath: &quot;/cache&quot;</span><br><span class="line">      - name: busybox</span><br><span class="line">        image: busybox</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - sleep</span><br><span class="line">        - &quot;3600&quot;</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: cache-vol</span><br><span class="line">          mountPath: &quot;/test&quot;</span><br><span class="line">      volumes:</span><br><span class="line">      - name: cache-vol</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line"></span><br><span class="line">#测试</span><br><span class="line">kubectl exec pod nginx-vol-test-5bc5485bdb-tk7wm -c nginx -it -- /bin/sh</span><br><span class="line">kubectl exec pod/nginx-vol-test-5bc5485bdb-tk7wm -c busybox -it -- /bin/sh</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#hostPath</span><br><span class="line">#将节点的文件或目录挂载到集群中</span><br><span class="line">#&quot;&quot; 默认 不做任何检查</span><br><span class="line">#DirectoryOrCreate 指定路径不存在则创建空目录 权限755 与kublete具有相同组和所有权</span><br><span class="line">#Directory 指定路径下必须存在目录</span><br><span class="line">#FileOrCreate 指定文件路径不存在则创建空文件 权限644 与kublete具有相同组和所有权</span><br><span class="line">#File 指定路径下必须存在文件</span><br><span class="line">#Socket 指定路径下必须存在套接字</span><br><span class="line">#CharDevice 指定路径下必须存在字符设备</span><br><span class="line">#BlockDevice 指定路径下必须存在块设备</span><br><span class="line">mkdir /www</span><br><span class="line">echo &quot;hello&quot; &gt; /www/index.html</span><br><span class="line">date &gt;&gt; /www/index.html</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">#apiVersion: apps/v1 要加上selector</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-vol-test1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: nginx-vol</span><br><span class="line">          mountPath: &quot;/usr/share/nginx/html&quot;</span><br><span class="line">      volumes:</span><br><span class="line">      - name: nginx-vol</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /www</span><br><span class="line">          type: Directory</span><br></pre></td></tr></table></figure>

<h4 id="PV-PVC"><a href="#PV-PVC" class="headerlink" title="PV PVC"></a>PV PVC</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PV是集群中的资源 独立于Pod的生命周期</span><br><span class="line">PVC 用户存储请求 与Pod类型，Pod消耗节点资源（CPU和内存）PVC消耗PV资源</span><br><span class="line">PV访问模式</span><br><span class="line">ReadWriteOnce RWO 该卷可被单个节点读写挂载</span><br><span class="line">ReadOnlyMany ROX 该卷可被多个节点读挂载</span><br><span class="line">ReadWriteMany RWX 该卷可被多个节点读写挂载</span><br><span class="line"></span><br><span class="line">回收策略</span><br><span class="line">Retain 保留手动回收</span><br><span class="line">Recycle 回收</span><br><span class="line">Delete 删除</span><br><span class="line"></span><br><span class="line">状态</span><br><span class="line">Available 可用</span><br><span class="line">Bound 已绑定</span><br><span class="line">Released 已释放</span><br><span class="line">Failed 失败</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#部署PV</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata: </span><br><span class="line">  name: nfspv1</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 8Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  storageClassName: nfs</span><br><span class="line">  nfs:</span><br><span class="line">    path: /home/k8sdata</span><br><span class="line">    server: 172.16.7.151</span><br><span class="line">---</span><br><span class="line">#创建服务并使用PVC</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata: </span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    name: web</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">---</span><br><span class="line">#部署statefulset</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  serviceName: &quot;nginx&quot;</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: web</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: www</span><br><span class="line">          mountPath: &quot;/usr/share/nginx/html&quot;</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: www</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [&quot;ReadWriteMany&quot;]</span><br><span class="line">      storageClassName: nfs</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 2Gi</span><br></pre></td></tr></table></figure>

<h4 id="新增Node节点"><a href="#新增Node节点" class="headerlink" title="新增Node节点"></a>新增Node节点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#安装ansible</span><br><span class="line">yum install -y ansible</span><br><span class="line">#安装pip</span><br><span class="line">yum install -y python-pip</span><br><span class="line">#安装netaddr</span><br><span class="line">pip install netaddr -i https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">pip install configparser -i https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">pip install --upgrade pip -i https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">pip install zipp -i https://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></table></figure>

<h4 id="动态PV"><a href="#动态PV" class="headerlink" title="动态PV"></a>动态PV</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#github地址：</span><br><span class="line">https://github.com/kubernetes-incubator/external-storage/tree/master/nfs/deploy/kubernetes</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#创建RBAC授权</span><br><span class="line">cat rbac.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;persistentvolumes&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;persistentvolumeclaims&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]</span><br><span class="line">  - apiGroups: [&quot;storage.k8s.io&quot;]</span><br><span class="line">    resources: [&quot;storageclasses&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;events&quot;]</span><br><span class="line">    verbs: [&quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span><br><span class="line">--- </span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: default</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#创建Storageclass类</span><br><span class="line">cat storageclass-nfs.yaml</span><br><span class="line">apiVersion: storage.k8s.io/v1beta1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#创建nfs的deployment</span><br><span class="line">cat deployment-nfs.yaml</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">        - name: registry-pull-secret</span><br><span class="line">      serviceAccount: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: lizhenliang/nfs-client-provisioner:v2.0.0</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.16.7.151</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /home/k8sdata</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 172.16.7.151</span><br><span class="line">            path: /home/k8sdata</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#使用statefulset创建nginx服务动态供给pv</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata: </span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    name: web</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">---</span><br><span class="line">#部署statefulset</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  serviceName: &quot;nginx&quot;</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: web</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: www</span><br><span class="line">          mountPath: &quot;/usr/share/nginx/html&quot;</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: www</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [&quot;ReadWriteOnce&quot;]</span><br><span class="line">      storageClassName: &quot;nfs-storage&quot;</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 2Gi</span><br></pre></td></tr></table></figure>

<h4 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#Pod名称：$(statefulset名称)-$(序号)</span><br><span class="line">#StatefulSet为每个Pod副本创建一个DNS域名 </span><br><span class="line">#格式：$(podname).$(headlessservername).$(namespace).svc.cluster.local 通过域名通信并非Pod IP</span><br><span class="line">#StatefulSet使用Headless服务控制Pod的域名</span><br><span class="line">#格式：$(servicename).$(namespace).svc.cluster.local</span><br><span class="line">#根据volumeClaimTemplates为每个Pod创建一个pvc</span><br><span class="line">#删除Pod不会删除其pvc，手工删除pvc将自动释放pv</span><br><span class="line"></span><br><span class="line">#StatefulSet启动顺序</span><br><span class="line">#有序部署：部署StatefulSet 多个副本 顺序创建(0~N-1) 下一个Pod运行之前 之前Pod必须是Running或Ready</span><br><span class="line">#有序删除：Pod被删除时 顺序删除(N-1~0)</span><br><span class="line">#有序扩展：Pod扩展 之前Pod必须是Running或Ready</span><br><span class="line"></span><br><span class="line">#使用场景</span><br><span class="line">持久化存储 Pod重新调度后还能访问相同数据 基于PVC实现</span><br><span class="line">稳定网络标识符 Pod重新调度后其PodName和HostName不变</span><br><span class="line">有序部署 有序扩展 基于init containers实现</span><br><span class="line">有序收缩</span><br></pre></td></tr></table></figure>

<h4 id="集群安全"><a href="#集群安全" class="headerlink" title="集群安全"></a>集群安全</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">Authentication</span><br><span class="line">RBAC</span><br><span class="line">Role ClusterRole RoleBinding ClusterRoleBinding</span><br><span class="line">k8s没有提供用户管理</span><br><span class="line">ApiServer会把客户端证书CN字段作为User 把names.O字段作为Group</span><br><span class="line"></span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: default</span><br><span class="line">  name: pod-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;watch&quot;,&quot;list&quot;]</span><br><span class="line"></span><br><span class="line">ClusterRole 具有与Role相同的权限角色控制能力 不同的是ClusterRole是集群级别</span><br><span class="line">集群级别的资源控制</span><br><span class="line">非资源类型endpoints</span><br><span class="line">所有命名空间资源控制</span><br><span class="line"></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: secret-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;secrets&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;watch&quot;,&quot;list&quot;]</span><br><span class="line"></span><br><span class="line">RoleBinding ClusterRoleBinding</span><br><span class="line">RoleBinding可以将角色中定义权限赋予用户或用户组 包含一组权限列表(subjects)</span><br><span class="line">权限列表包含不同形式权限资源类型(user,groups,service accounts)</span><br><span class="line">RoleBinding包含对被Bind的Role引用，RoleBinding适用于某个命名空间内的授权</span><br><span class="line">ClusterRoleBinding适用于集群范围内的授权</span><br><span class="line"></span><br><span class="line">#将default命名空间pod-reader Role授予ropon用户</span><br><span class="line">#此后ropon用户名在default命名空间中将具有pod-reader的权限</span><br><span class="line">kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-reader</span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: ropon</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: pod-reader</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">RoleBinding同样可以引用ClusterRole来对当前namespace内用户、用户组或ServiceAccount进行授权</span><br><span class="line">允许集群管理员在整个集群内定义一些通用的ClusterRole，然后再不同namespace中使用RoleBinding来引用</span><br><span class="line"></span><br><span class="line">#RoleBinding引用一个ClusterRole，这个ClusterRole具有整个集群内对secrets的访问权限</span><br><span class="line">#但其授权用户ropon只能访问development空间中的secrets(因为RoleBinding定义在development命名空间)</span><br><span class="line">kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: read-secrets</span><br><span class="line">  namespace: development</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: ropon</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: read-secrets</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">#使用ClusterRoleBinding可以对整个集群中所有命名空间资源权限进行授权</span><br><span class="line">#ClusterRoleBinding授权manager组所有用户名在全部命名空间对secrets进行访问</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: read-secrets-global</span><br><span class="line">  namespace: development</span><br><span class="line">subjects:</span><br><span class="line">- kind: Group</span><br><span class="line">  name: manager</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: read-secrets</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>

<h4 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Kubernets集群内一些资源一般以其名称字符串来表示，这些字符串一般会在API的URL地址中出现</span><br><span class="line">某些资源还包含子资源，比如logs资源属于pods的子资源</span><br><span class="line">GET /api/v1/namespaces/&#123;namespace&#125;/pods/&#123;name&#125;/log</span><br><span class="line"></span><br><span class="line">#定义pods资源logs访问权限的Role</span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-and-pod-logs-reader</span><br><span class="line">  namespace: default</span><br><span class="line">rules:</span><br><span class="line">- apiGroup: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods/log&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;,&quot;list&quot;]</span><br><span class="line"></span><br><span class="line">RoleBinding和ClusterRoleBinding可以将Role绑定subjects</span><br><span class="line">subjects可以是groups、users或者service accounts</span><br><span class="line">subjects中Users使用字符串表示，恶意普通名字字符串，可以是email地址</span><br><span class="line">还可以字符串形式数组ID，但前缀不能以system开头</span><br><span class="line">同理Groups格式与Users相同，都为一个字符串，前缀不能以system开头</span><br></pre></td></tr></table></figure>

<h4 id="实战-创建一个用户只能管理dev空间"><a href="#实战-创建一个用户只能管理dev空间" class="headerlink" title="实战 创建一个用户只能管理dev空间"></a>实战 创建一个用户只能管理dev空间</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">useradd devuser</span><br><span class="line">passwd devuser</span><br><span class="line">kubectl create namespace dev</span><br><span class="line">cat dev-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;devuser&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;HangZhou&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;XS&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=./ca.pem -ca-key=./ca-key.pem -profile=kubernets ./dev-csr.jsoncfssljson -bare devuser</span><br><span class="line">#设置集群参数</span><br><span class="line">export KUBE_APISERVER=&quot;https://192.168.7.150:6443&quot;</span><br><span class="line">kubectl config set-cluster cluster1 \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=$&#123;KUBE_APISERVER&#125;</span><br><span class="line">  --kubeconfig=devuser.kubeconfig</span><br><span class="line">#设置客户端认证参数</span><br><span class="line">kubectl config set-credentials devuser \</span><br><span class="line">--client-certificate=/etc/kubernetes/ssl/kubelet.pem \</span><br><span class="line">--client-key=/etc/kubernetes/ssl/kubelet-key.pem  \</span><br><span class="line">--embed-certs=true \</span><br><span class="line">--kubeconfig=devuser.kubeconfig</span><br><span class="line">#设置上下文参数</span><br><span class="line">kubectl config set-context cluster1 \</span><br><span class="line">--cluster=cluster1 \</span><br><span class="line">--user=devuser \</span><br><span class="line">--namespace=dev \</span><br><span class="line">--kubeconfig=devuser.kubeconfig</span><br><span class="line">#进行RoleBinding角色绑定</span><br><span class="line">kubectl create rolebinding devuser-admin-binding --clusterrole=admin --user=devuser --namespace=dev</span><br><span class="line">cp devuser.kubeconfig /home/devuser/.kube/config</span><br><span class="line">#切换devuser用户并切换上下文</span><br><span class="line">cd /home/devuser/.kube</span><br><span class="line">kubectl config use-context cluster1 --kubeconfig=config</span><br></pre></td></tr></table></figure>

<h4 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">cat helm-rabc-config.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: tiller</span><br><span class="line">    namespace: kube-system</span><br><span class="line"></span><br><span class="line">kubectl create -f helm-rabc-config.yaml</span><br><span class="line">helm init --service-account tiller --history-max 200 --tiller-image registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.13.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts --upgrade </span><br><span class="line">kubectl get pod -n kube-system -l name=tiller</span><br><span class="line">#替换helm的repo为阿里镜像仓库</span><br><span class="line">helm repo remove stable</span><br><span class="line">helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line">cat Chart.yaml</span><br><span class="line">name: hello-world</span><br><span class="line">version: 1.0.0</span><br><span class="line"></span><br><span class="line">cat templates/deployment.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-world</span><br><span class="line">spec:</span><br><span class="line">  replocas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: hello-world</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: hello-world</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          protocal: TCP</span><br><span class="line"></span><br><span class="line">cat templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-world</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: hello-world</span><br><span class="line"></span><br><span class="line">#安装</span><br><span class="line">helm install .</span><br><span class="line">#列出已经部署的Release</span><br><span class="line">helm ls</span><br><span class="line">#查询具体Release的状态</span><br><span class="line">helm status XXXXX</span><br><span class="line">#删除所有与具体Release相关的kubernets资源</span><br><span class="line">helm delete XXXXX</span><br><span class="line">helm rollback </span><br><span class="line"></span><br><span class="line">#Debug 使用模板动态生成k8s资源清单 能提前预览生成的结果</span><br><span class="line">#--dry-run --debug  选项打印出 生成的清单文件内容 但不执行部署</span><br><span class="line">helm install . --dry-run --debug --set image.tag=latest</span><br></pre></td></tr></table></figure>

<h4 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/07/02/k8s%E4%BD%BF%E7%94%A8-1/" data-id="clc4klg5u0051ojobbbeh583i" data-title="k8s使用" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-kubernets知识点-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/20/kubernets%E7%9F%A5%E8%AF%86%E7%82%B9-1/" class="article-date">
  <time class="dt-published" datetime="2020-06-20T09:35:44.000Z" itemprop="datePublished">2020-06-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/">经验分享</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/20/kubernets%E7%9F%A5%E8%AF%86%E7%82%B9-1/">kubernets知识点</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li>kubectl创建别名</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alias k=kubectl</span><br></pre></td></tr></table></figure>

<ul>
<li>tab补全命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bash-completion</span><br><span class="line">source &lt;(kubectl completion bash  sed s/kubectl/k/g)</span><br></pre></td></tr></table></figure>

<ul>
<li>kubernets运行应用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl run kubia --image=luksa/kubia --port=8080 --generator=run/v1</span><br><span class="line">#--image=luksa/kubia 容器运行时所需镜像</span><br><span class="line">#--port=8080 监听8080端口</span><br></pre></td></tr></table></figure>

<ul>
<li>创建一个服务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#创建一个LoadBalancer服务</span><br><span class="line">kubectl expose pod kubia --type=LoadBalancer --name kubia-http</span><br><span class="line">#查看</span><br><span class="line">kubectl get svc</span><br><span class="line"></span><br><span class="line">kubectl scale rc nginx-test --replicas=3</span><br></pre></td></tr></table></figure>

<ul>
<li>公共配置参数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--log-backtrace-at traceLocation 记录日志每到 file:行号时打印一次stack trace 默认值0</span><br><span class="line">--log-dir string 日志文件路径</span><br><span class="line">--log-flush-frequency duration 设置flush日志文件的时间间隔 默认值5s</span><br><span class="line">--logtostderr 设置为true表示将日志输出到stderr 不输出到日志文件</span><br><span class="line">--alsologtostderr 设置为true表示将日志输出到日志文件同时输出到stderr</span><br><span class="line">--stderrthreshold severity 将threshold级别以上的日志输出到stderr 默认值2</span><br><span class="line">--v Level 配置日志级别</span><br><span class="line">--vmodule moduleSpec 详细日志级别</span><br><span class="line">--version version[=true] 输出其版本号</span><br></pre></td></tr></table></figure>

<ul>
<li>kube-apiserver 启动参数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">--admission-control strings 对发送给apiserver的任何请求进行准入控制 配置为一个准入控制器列表</span><br><span class="line">AlwaysAdmit 运行所有请求</span><br><span class="line">AlwaysDeny 禁止所有请求</span><br><span class="line">AlwaysPullImages 启动容器之前总是去下载镜像</span><br><span class="line">DefaultStorageClass 实现共享存储动态供应 为未指定StorageClass或PV的PVC匹配默认StorageClass</span><br><span class="line">DefaultTolerationSeconds 设置默认容忍时间 5min</span><br><span class="line">DenyEscalatingExec 拦截 所有exec和attach到具有特权的Pod上的请求</span><br><span class="line">DenyExecOnPrivileged 拦截所有想在privileged container上执行命令的请求</span><br><span class="line">ImagePolicyWebhook 允许后端webhook程序完成admission controller</span><br><span class="line">LimitRanger 配额管理</span><br><span class="line">NamespaceLifecycle 拒绝在不存在namespace中创建资源对象的请求 删除namespace时删除所有对象</span><br><span class="line">PodPreset pod启动时注入应用所需设置</span><br><span class="line">PodSecurityPolicy 对pod进行安全策略控制</span><br><span class="line">ResourceQuota 配额管理</span><br><span class="line">……</span><br><span class="line">--advertise-address ip 广播给集群所有成员自己的IP地址</span><br><span class="line">--allow-privileged 配置为true 运行pod中运行拥有系统特权的容器应用</span><br><span class="line">--anonymous-auth 配置为true表示apiserver接收匿名请求 默认值true</span><br><span class="line">--apiserver-count 集群中运行apiserver数量 默认值1</span><br><span class="line">--authorization-mode 认证模式列表 多个以逗号分隔</span><br></pre></td></tr></table></figure>

<h4 id="Pod-资源文件详细说明"><a href="#Pod-资源文件详细说明" class="headerlink" title="Pod 资源文件详细说明"></a>Pod 资源文件详细说明</h4><p>属性名称</p>
<p>取值类型</p>
<p>是否必需</p>
<p>取值说明</p>
<p>version</p>
<p>String</p>
<p>yes</p>
<p>v1</p>
<p>kind</p>
<p>String</p>
<p>yes</p>
<p>Pod</p>
<p>metadata</p>
<p>Object</p>
<p>yes</p>
<p>元数据</p>
<p>metadata.name</p>
<p>String</p>
<p>yes</p>
<p>Pod的名称</p>
<p>metadata.namespace</p>
<p>String</p>
<p>yes</p>
<p>Pod所属名称空间</p>
<p>metadata.labels[]</p>
<p>List</p>
<p>自定义标签列表</p>
<p>metadata.annotation[]</p>
<p>List</p>
<p>自定义注解列表</p>
<p>spec</p>
<p>Object</p>
<p>yes</p>
<p>Pod中容器详细定义</p>
<p>spec.containers[]</p>
<p>List</p>
<p>yes</p>
<p>Pod中的容器列表</p>
<p>spec.containers[].name</p>
<p>String</p>
<p>yes</p>
<p>容器的名称</p>
<p>spec.containers[].image</p>
<p>String</p>
<p>yes</p>
<p>容器的镜像名称</p>
<p>spec.containers[].imagePullPolicy</p>
<p>String</p>
<p>获取镜像策略</p>
<p>spec.containers[].command[]</p>
<p>List</p>
<p>容器启动命令列表</p>
<p>spec.containers[].args[]</p>
<p>List</p>
<p>启动命令参数列表</p>
<p>spec.containers[].workingDir</p>
<p>String</p>
<p>容器工作目录</p>
<p>spec.containers[].volumeMounts[]</p>
<p>List</p>
<p>容器存储卷配置</p>
<p>spec.containers[].volumeMounts[].name</p>
<p>String</p>
<p>共享存储卷名称</p>
<p>spec.containers[].volumeMounts[].mountPath</p>
<p>String</p>
<p>存储卷容器内挂载绝对路径</p>
<p>spec.containers[].volumeMounts[].readOnly</p>
<p>Boolean</p>
<p>是否只读模式，默认读写模式</p>
<p>spec.containers[].ports[]</p>
<p>List</p>
<p>容器暴露的端口号列表</p>
<p>spec.containers[].ports[].name</p>
<p>String</p>
<p>端口的名称</p>
<p>spec.containers[].ports[].containerPort</p>
<p>Int</p>
<p>容器需要监听的端口号</p>
<p>spec.containers[].ports[].hostPort</p>
<p>Int</p>
<p>默认与containerPort一致</p>
<p>spec.containers[].ports[].protocol</p>
<p>String</p>
<p>端口协议TCP UDP 默认TCP</p>
<p>spec.containers[].env[]</p>
<p>List</p>
<p>容器需要环境变量列表</p>
<p>spec.containers[].env[].name</p>
<p>String</p>
<p>环境变量的名称</p>
<p>spec.containers[].env[].value</p>
<p>String</p>
<p>环境变量的值</p>
<p>spec.containers[].resources</p>
<p>Object</p>
<p>资源限制和资源请求设置</p>
<p>spec.containers[].resources.limits</p>
<p>Object</p>
<p>资源限制的设置</p>
<p>spec.containers[].resources.limits.cpu</p>
<p>String</p>
<p>CPU限制 单位为core数</p>
<p>spec.containers[].resources.limits.memory</p>
<p>String</p>
<p>内存限制 单位MiB&#x2F;GiB</p>
<p>spec.containers[].resources.requests</p>
<p>Object</p>
<p>请求限制的设置</p>
<p>spec.containers[].resources.requests.cpu</p>
<p>String</p>
<p>CPU请求 单位为core数</p>
<p>spec.containers[].resources.requests.memory</p>
<p>String</p>
<p>内存请求 单位MiB&#x2F;GiB</p>
<p>spec.volumes[]</p>
<p>List</p>
<p>Pod定义共享存储卷列表</p>
<p>spec.volumes[].name</p>
<p>String</p>
<p>共享存储卷的名称</p>
<p>spec.volumes[].emptyDir</p>
<p>Object</p>
<p>与Pod同生命周期的临时目录</p>
<p>spec.volumes[].hostPath</p>
<p>Object</p>
<p>Pod所在宿主机的目录</p>
<p>spec.volumes[].hostPath.path</p>
<p>String</p>
<p>Pod所在在主机的目录</p>
<p>spec.volumes[].secret</p>
<p>Object</p>
<p>挂载预定义secret对象到容器</p>
<p>spec.volumes[].configMap</p>
<p>Object</p>
<p>挂载预定义configMap对象到容器</p>
<p>spec.volumes[].livenessProbe</p>
<p>Object</p>
<p>健康检查配置</p>
<p>spec.volumes[].livenessProbe.exec</p>
<p>Object</p>
<p>使用exec方式</p>
<p>spec.volumes[].livenessProbe.exec.command[]</p>
<p>String</p>
<p>指定命令或脚本</p>
<p>spec.volumes[].livenessProbe.httpGet</p>
<p>Object</p>
<p>使用httpGet方式 path prot</p>
<p>spec.volumes[].livenessProbe.tcpSocket</p>
<p>Object</p>
<p>使用tcpSocket方式</p>
<p>spec.volumes[].livenessProbe.initalDelaySeconds</p>
<p>Number</p>
<p>启动后首次探测时间 单位s</p>
<p>spec.volumes[].livenessProbe.timeoutSeconds</p>
<p>Number</p>
<p>探测超时时间 默认1s</p>
<p>spec.volumes[].livenessProbe.periodSeconds</p>
<p>Number</p>
<p>探测时间间隔 默认10s</p>
<p>spec.restartPolicy</p>
<p>String</p>
<p>重启策略</p>
<p>spec.nodeSelector</p>
<p>Object</p>
<p>Pod调度到包含label的Node key:value格式指定</p>
<p>spec.imagePullSecrets</p>
<p>Object</p>
<p>Pull镜像使用secret</p>
<p>spec.hostNetwork</p>
<p>Boolean</p>
<p>是否使用主机网络模式</p>
<h4 id="Pod-资源文件详细说明-1"><a href="#Pod-资源文件详细说明-1" class="headerlink" title="Pod 资源文件详细说明"></a>Pod 资源文件详细说明</h4><p>属性名称</p>
<p>取值类型</p>
<p>是否必需</p>
<p>取值说明</p>
<p>version</p>
<p>String</p>
<p>yes</p>
<p>v1</p>
<p>kind</p>
<p>String</p>
<p>yes</p>
<p>Pod</p>
<p>metadata</p>
<p>Object</p>
<p>yes</p>
<p>元数据</p>
<p>metadata.name</p>
<p>String</p>
<p>yes</p>
<p>Pod的名称</p>
<p>metadata.namespace</p>
<p>String</p>
<p>yes</p>
<p>Pod所属名称空间</p>
<p>metadata.labels[]</p>
<p>List</p>
<p>自定义标签列表</p>
<p>metadata.annotation[]</p>
<p>List</p>
<p>自定义注解列表</p>
<p>spec</p>
<p>Object</p>
<p>yes</p>
<p>Pod中容器详细定义</p>
<p>spec.selector[]</p>
<p>List</p>
<p>yes</p>
<p>选择指定label标签的Pod</p>
<p>spec.type</p>
<p>String</p>
<p>yes</p>
<p>service的类型默认ClusterIP</p>
<p>spec.clusterIP</p>
<p>String</p>
<p>虚拟服务IP地址</p>
<p>spec.sessionAffinity</p>
<p>String</p>
<p>是否支持session 默认为空 可选ClientIP 同一客户端到同一后端Pod</p>
<p>spec.ports[]</p>
<p>List</p>
<p>service需要暴露端口列表</p>
<p>spec.ports[].name</p>
<p>String</p>
<p>端口名称</p>
<p>spec.ports[].protocol</p>
<p>String</p>
<p>端口协议 TCP UDP 默认TCP</p>
<p>spec.ports[].port</p>
<p>int</p>
<p>服务监听端口号</p>
<p>spec.ports[].targetPort</p>
<p>int</p>
<p>需要转发到后端Pod的端口号</p>
<p>spec.ports[].nodePort</p>
<p>int</p>
<p>当type&#x3D;NodePort时 映射宿主机端口号</p>
<p>status</p>
<p>object</p>
<p>当type&#x3D;LoadBalancer时 设置外部负载均衡器地址</p>
<p>status.loadBalancer</p>
<p>object</p>
<p>外部负载均衡器</p>
<p>status.loadBalancer.ingress</p>
<p>object</p>
<p>外部负载均衡器</p>
<p>status.loadBalancer.ingress.ip</p>
<p>string</p>
<p>外部负载均衡器的IP地址</p>
<p>status.loadBalancer.ingress.hostname</p>
<p>string</p>
<p>外部负载均衡器的主机名</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/06/20/kubernets%E7%9F%A5%E8%AF%86%E7%82%B9-1/" data-id="clc4klg5y005dojobbdv0h9a9" data-title="kubernets知识点" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-redis相关知识-0" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/20/redis%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86-0/" class="article-date">
  <time class="dt-published" datetime="2020-06-20T00:45:30.000Z" itemprop="datePublished">2020-06-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/">经验分享</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/20/redis%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86-0/">Redis相关知识</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h4><ul>
<li><p>redis中字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#设置值</span><br><span class="line">set key val</span><br><span class="line">#获取值</span><br><span class="line">get key</span><br><span class="line">#删除值</span><br><span class="line">del key</span><br><span class="line">#自增</span><br><span class="line">INCR key-name</span><br><span class="line">#自减</span><br><span class="line">DECR key-name</span><br><span class="line">#将存储值加上整数</span><br><span class="line">INCRBY key-name amount</span><br><span class="line">#将存储值减去整数</span><br><span class="line">DECRBY key-name amount</span><br><span class="line">#将存储值加上浮点数</span><br><span class="line">INCRBYFLOAT key-name amount</span><br><span class="line">#将值value追加到给定键key-name当前存储的值的末尾</span><br><span class="line">APPEND key-name value</span><br><span class="line">#获取从偏移量start至偏移量end范围内的子串</span><br><span class="line">GETRANGE key-name start end</span><br><span class="line">#将start偏移量开始的子串设置为给定值</span><br><span class="line">SETRANGE key-name offset value</span><br><span class="line">#将字节串看作二进制串 并返回字串中offset的二进制位的值</span><br><span class="line">GETBIT key-name offset</span><br><span class="line">#将字节串看作二进制串 并将字串中offset的二进制位的值设置为value</span><br><span class="line">SETBIT key-name offset value</span><br><span class="line">BITCOUNT key-name [start end]</span><br><span class="line">BITTOP operation dest-key key-name</span><br></pre></td></tr></table></figure>
</li>
<li><p>redis中的列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">LPUSH 将元素推入列表左端</span><br><span class="line">lpush lstkey lval1</span><br><span class="line">RPUSH 将元素推入列表右端</span><br><span class="line">rpush lstkey rval1</span><br><span class="line">LPOP 从列表左端弹出元素</span><br><span class="line">lpush lstkey</span><br><span class="line">RPOS 从列表右端弹出元素</span><br><span class="line">rpush lstkey</span><br><span class="line">LINDEX 获取列表在给定位置上的一个元素</span><br><span class="line">lindex lstkey 1</span><br><span class="line">LRANGE 获取列表在给定范围上的所有元素</span><br><span class="line">lrange lstkey 0 2</span><br><span class="line">LTRIM 对列表进行修剪 只保留start偏移量到end偏移量范围内的元素</span><br><span class="line">ltrim lstkey 0 2</span><br><span class="line">BLPOP 从非空列表中弹出位于最左端的元素</span><br><span class="line">BRPOP 从非空列表中弹出位于最右端的元素</span><br><span class="line">RPOPLPUSH </span><br><span class="line">rpoplpush source-key dest-key</span><br><span class="line">BRPOPLPUSH</span><br><span class="line">brpoplpush source-key dest-key</span><br></pre></td></tr></table></figure>
</li>
<li><p>redis的集合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SADD 将元素添加到集合</span><br><span class="line">sadd setkey val22</span><br><span class="line">SREM 从集合移除元素</span><br><span class="line">srem setkey val22</span><br><span class="line">SISMEMBER 检查集合中是否存在此元素</span><br><span class="line">sismember setkey val22</span><br><span class="line">SMEMBERS 获取集合中所有元素</span><br><span class="line">smembers setkey</span><br><span class="line">SCARD 获取集合包含元素的数量</span><br><span class="line">scard setkey</span><br><span class="line">SRANDMEMBER 从集合里面随机返回一个或多个元素</span><br><span class="line">srandmember setkey 2</span><br><span class="line">SPOP 随机从集合中移除一个元素 并返回被移除的元素</span><br><span class="line">spop setkey</span><br><span class="line">SMOVE 如果item存在source-key集合中 移除此元素添加到dest-key集合</span><br><span class="line">smove source-key dest-key item </span><br><span class="line"></span><br><span class="line">#额外还支持</span><br><span class="line">SINTER 交集</span><br><span class="line">SUNION 并集</span><br><span class="line">SDIFF 差集</span><br></pre></td></tr></table></figure>
</li>
<li><p>redis的散列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">HSET 散列中关联给定的键值对</span><br><span class="line">hset hashkey key1 val1</span><br><span class="line">HGET 获取指定散列键的值</span><br><span class="line">hget hashkey key1</span><br><span class="line">HGETALL 获取散列中所有键值对</span><br><span class="line">hgetall hashkey</span><br><span class="line">HDEL 删除散列中指定键值对</span><br><span class="line">hdel hashkey key1</span><br><span class="line">HMSET 为散列里一个或多个键设置值</span><br><span class="line">hmset hashkey key1 val1 key2 val2</span><br><span class="line">HLEN 获取散列包含键值对的数量</span><br><span class="line">hlen hashkey</span><br><span class="line">HEXISTS 检查给定键是否存在于散列中</span><br><span class="line">hexists hashkey key1</span><br><span class="line">HKEYS 获取散列包含的所有键</span><br><span class="line">hkeys hashkey</span><br><span class="line">HVALS hashkey 获取散列包含的所有值</span><br><span class="line">hvals hashkey</span><br><span class="line">HINCRBYFLOAT 将key存储的值加上浮点数</span><br><span class="line">hincrbyfloat hashkey key1 increment</span><br></pre></td></tr></table></figure>
</li>
<li><p>redis的有序集合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ZADD 将一个给定分值的成员添加到有序集合</span><br><span class="line">zadd zsetkey 90 zhansan</span><br><span class="line">ZRANGE 从有序集合李获取多个元素</span><br><span class="line">zrange zsetkey 0 2 withscores</span><br><span class="line">ZRANGEBYSCORE 获取给定分值范围内的所有元素</span><br><span class="line">zrangebyscore zsetkey 82 95 withscores</span><br><span class="line">ZREM 移除成员</span><br><span class="line">zrem zsetkey zhansan</span><br><span class="line">ZCARD 获取有序集合包含成员的数量</span><br><span class="line">zcard zsetkey</span><br><span class="line">ZCOUNT 返回分值介于min和max之间的成员数量</span><br><span class="line">zcount zsetkey 80 90</span><br><span class="line">ZRANK 返回某个成员在集合中的排名</span><br><span class="line">zrank zsetkey zhangsan</span><br><span class="line">ZSCORE 返回某个成员的分值</span><br><span class="line">zscore zsetkey lisi</span><br><span class="line">ZINCRBY 将某个成员的分值加上increment</span><br><span class="line">zincrby zsetkey 2 lisi</span><br></pre></td></tr></table></figure>
</li>
<li><p>案例：投票</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2020/6/5 11:17</span></span><br><span class="line"><span class="comment"># @Author  : Ropon</span></span><br><span class="line"><span class="comment"># @File    : test.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time, redis</span><br><span class="line"></span><br><span class="line">pool = redis.ConnectionPool(host=<span class="string">&quot;172.16.7.127&quot;</span>, port=<span class="number">6379</span>, password=<span class="string">&quot;&quot;</span>, max_connections=<span class="number">1024</span>)</span><br><span class="line">conn = redis.Redis(connection_pool=pool)</span><br><span class="line"></span><br><span class="line">ONE_WEEK_IN_SECONDS = <span class="number">7</span> * <span class="number">86400</span></span><br><span class="line">VOTE_SCORE = <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">article_vote</span>(<span class="params">conn, user, article</span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  投票函数</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="comment"># 计算投票截止时间</span></span><br><span class="line">  cutoff = time.time() - ONE_WEEK_IN_SECONDS</span><br><span class="line">  <span class="keyword">if</span> conn.zscore(<span class="string">&#x27;time:&#x27;</span>, article) &lt; cutoff:</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">  article_id = article.split(<span class="string">&#x27;:&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">if</span> conn.sadd(<span class="string">&#x27;voted:&#x27;</span> + article_id, user):</span><br><span class="line">      <span class="comment"># ZINCRBY 对有序集合成员的分值执行自增</span></span><br><span class="line">      conn.zincrby(<span class="string">&#x27;score:&#x27;</span>, article, VOTE_SCORE)</span><br><span class="line">      <span class="comment"># HINCRBY 对散列存储的值进行自增</span></span><br><span class="line">      conn.hincrby(article, <span class="string">&#x27;vote&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_article</span>(<span class="params">conn, user, title, link</span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  新增文章函数</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="comment"># INCR 计数器自增</span></span><br><span class="line">  article_id = <span class="built_in">str</span>(conn.incr(<span class="string">&#x27;article:&#x27;</span>))</span><br><span class="line">  voted = <span class="string">&#x27;voted:&#x27;</span> + article_id</span><br><span class="line">  conn.sadd(voted, user)</span><br><span class="line">  conn.expire(voted, ONE_WEEK_IN_SECONDS)</span><br><span class="line"></span><br><span class="line">  now = time.time()</span><br><span class="line">  article = <span class="string">&#x27;article:&#x27;</span> + article_id</span><br><span class="line">  conn.hmset(article, &#123;</span><br><span class="line">      <span class="string">&#x27;title&#x27;</span>: title,</span><br><span class="line">      <span class="string">&#x27;link&#x27;</span>: link,</span><br><span class="line">      <span class="string">&#x27;poster&#x27;</span>: user,</span><br><span class="line">      <span class="string">&#x27;time&#x27;</span>: now,</span><br><span class="line">      <span class="string">&#x27;votes&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  conn.zadd(<span class="string">&#x27;score:&#x27;</span>, &#123;article: now + VOTE_SCORE&#125;)</span><br><span class="line">  conn.zadd(<span class="string">&#x27;time:&#x27;</span>, &#123;article: now&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> article_id</span><br><span class="line"></span><br><span class="line">ARTICLES_PER_PAGE = <span class="number">25</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_articles</span>(<span class="params">conn, page, order=<span class="string">&#x27;score:&#x27;</span></span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">获取所有文章</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  start = (page - <span class="number">1</span>) * ARTICLES_PER_PAGE</span><br><span class="line">  end = start + ARTICLES_PER_PAGE - <span class="number">1</span></span><br><span class="line">  ids = conn.zrevrange(order, start, end)</span><br><span class="line">  articles = []</span><br><span class="line">  <span class="keyword">for</span> <span class="built_in">id</span> <span class="keyword">in</span> ids:</span><br><span class="line">      article_data = conn.hgetall(<span class="built_in">id</span>)</span><br><span class="line">      article_data[<span class="string">&#x27;id&#x27;</span>] = <span class="built_in">id</span></span><br><span class="line">      articles.append(article_data)</span><br><span class="line">  <span class="keyword">return</span> articles</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_remove_groups</span>(<span class="params">conn, article_id, to_add=<span class="literal">None</span>, to_remove=<span class="literal">None</span></span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  添加或删除分类</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">if</span> to_remove <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">      to_remove = []</span><br><span class="line">  <span class="keyword">if</span> to_add <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">      to_add = []</span><br><span class="line">  article = <span class="string">&#x27;article:&#x27;</span> + article_id</span><br><span class="line">  <span class="keyword">for</span> group <span class="keyword">in</span> to_add:</span><br><span class="line">      conn.sadd(<span class="string">&#x27;group:&#x27;</span> + group, article)</span><br><span class="line">  <span class="keyword">for</span> group <span class="keyword">in</span> to_remove:</span><br><span class="line">      conn.srem(<span class="string">&#x27;group:&#x27;</span> + group, article)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_group_articles</span>(<span class="params">conn, group, page, order=<span class="string">&#x27;score:&#x27;</span></span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  通过分类获取所有文章</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  key = order + group</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> conn.exists(key):</span><br><span class="line">      conn.zinterstore(key, [<span class="string">&#x27;group:&#x27;</span> + group, order], aggregate=<span class="string">&#x27;max&#x27;</span>)</span><br><span class="line">      conn.expire(key, <span class="number">60</span>)</span><br><span class="line">  <span class="keyword">return</span> get_articles(conn, page, key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># post_article(conn, &quot;Ropon&quot;, &quot;Python从入门到放弃&quot;, &quot;https://www.ropon.top/1.html&quot;)</span></span><br><span class="line">article_vote(conn, <span class="string">&quot;Ropon&quot;</span>, <span class="string">&quot;article:5&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/06/20/redis%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86-0/" data-id="clc4klg6u008eojob6h2338kv" data-title="Redis相关知识" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-docker安装及镜像知识" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/28/docker%E5%AE%89%E8%A3%85%E5%8F%8A%E9%95%9C%E5%83%8F%E7%9F%A5%E8%AF%86/" class="article-date">
  <time class="dt-published" datetime="2020-05-28T09:01:43.000Z" itemprop="datePublished">2020-05-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cloud/">cloud</a>►<a class="article-category-link" href="/categories/cloud/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/28/docker%E5%AE%89%E8%A3%85%E5%8F%8A%E9%95%9C%E5%83%8F%E7%9F%A5%E8%AF%86/">Docker相关知识总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="Centos7安装Docker"><a href="#Centos7安装Docker" class="headerlink" title="Centos7安装Docker"></a>Centos7安装Docker</h4><ul>
<li><p>卸载旧版本</p>
<p><code>sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine</code></p>
</li>
<li><p>安装依赖包 <code>sudo yum install -y yum-utils device-mapper-persistent-data lvm2</code></p>
</li>
<li><p>添加国内yum源 <code>sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></p>
</li>
<li><p>安装Docker CE <code>sudo yum makecache fast</code> <code>sudo yum install docker-ce</code></p>
</li>
<li><p>启动Docker CE <code>sudo systemctl enable docker</code> <code>sudo systemctl start docker</code></p>
</li>
<li><p>镜像加速</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">        &quot;registry-mirrors&quot;: [</span><br><span class="line">                &quot;https://docker.mirrors.ustc.edu.cn&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line">#重启服务</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line">#查看是否配置成功</span><br><span class="line">sudo docker info </span><br></pre></td></tr></table></figure>

<h4 id="Docker镜像"><a href="#Docker镜像" class="headerlink" title="Docker镜像"></a>Docker镜像</h4><ul>
<li><p>获取镜像 <code>docker pull [选项] [Docker Registry 地址[:端口号]/]仓库名[:标签]</code></p>
</li>
<li><p>运行 <code>docker run -it --rm ubuntu:18.04 bash</code></p>
<ul>
<li>-it -i交互式操作 -t 终端</li>
<li>--rm 退出时将其删除</li>
<li>ubuntu:18.04 以ubuntu:18.04作为基础启动容器</li>
<li>bash 启动后执行命令</li>
</ul>
</li>
<li><p>列出镜像 <code>docker image ls</code></p>
</li>
<li><p>镜像体积 <code>docker system df</code></p>
</li>
<li><p>虚悬镜像 <code>docker image prune</code></p>
</li>
<li><p>中间层镜像 <code>docker image ls -a</code></p>
</li>
<li><p>列出部分镜像 <code>docker image ls ubuntu</code></p>
</li>
<li><p>以特定格式显示</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#列出所有镜像ID</span><br><span class="line">docker image ls -q</span><br><span class="line">#利用模板语法</span><br><span class="line">docker image ls --format &quot;&#123;&#123;.ID&#125;&#125;: &#123;&#123;.Repository&#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>删除本地镜像 <code>docker image rm [选项] &lt;镜像1&gt; [&lt;镜像2&gt; ...]</code></li>
<li>构建镜像（commit <strong>慎用</strong>）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#以nginx为基础镜像启动一个名为webserver的容器 映射80端口</span><br><span class="line">docker run --name webserver -d -p 80:80 nginx</span><br><span class="line">#进入容器</span><br><span class="line">docker exec -it webserver bash</span><br><span class="line">echo &#x27;&lt;h1&gt;Hello, Docker!&lt;/h1&gt;&#x27; &gt; /usr/share/nginx/html/index.html</span><br><span class="line">#查看具体改动</span><br><span class="line">docker diff webserver</span><br><span class="line">#构建镜像</span><br><span class="line">docker commit --author &quot;Ropon&quot; --message &quot;修改默认页面&quot; webserver nginx:V2</span><br><span class="line">#查看镜像</span><br><span class="line">docker image ls nginx</span><br><span class="line">#查看镜像内历史记录</span><br><span class="line">docker history nginx</span><br><span class="line">#测试新镜像</span><br><span class="line">docker run --name web2 -d -p 81:80 nginx:V2</span><br></pre></td></tr></table></figure>

<ul>
<li>用Dockerfile 定制镜像 Dockerfile是一个文本文件 包含一条条指令（Instruction）每条指令构建一层</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir mynginx</span><br><span class="line">cd mynginx</span><br><span class="line">cat Dockerfile</span><br><span class="line">FROM nginx</span><br><span class="line">RUN echo &#x27;&lt;h1&gt;Hello, Docker!&lt;/h1&gt;&#x27; &gt; /usr/share/nginx/html/index.html</span><br><span class="line">#FROM 指定基础镜像（一个特殊镜像 scratch 空白镜像 复制可执行二进制文件打包成新镜像）</span><br><span class="line">#RUN 执行命令（和写shell脚本一样 每行将构建一层 臃肿 不推荐 并不是在写shell脚本 而是在定义每一层该如何构建）</span><br><span class="line">#构建镜像</span><br><span class="line">docker build -t nginx:V3 .</span><br><span class="line">#测试新镜像</span><br><span class="line">docker run --name web3 -d -p 82:80 nginx:V3</span><br></pre></td></tr></table></figure>

<ul>
<li>镜像构建上下文（Context）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#构建在服务端由Docker引擎完成 构建时将指定路径下内容打包 上传给Docker引擎 然后展开构建</span><br><span class="line">COPY ./package.json /app/</span><br><span class="line">#比如以上语句 构建时不是复制docker build命令所在目录下package.json 也不是复制Dockerfile所在目录下package.json 而是复制上下文目录下package.json</span><br><span class="line">docker build -t nginx:V3 .</span><br><span class="line">. 当前目录也就是指定上下文目录 docker build 命令会将该目录打包上传Docker引擎 帮助构建镜像</span><br><span class="line">#发送上下文的过程</span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">#基于以上理解 构建时新建一个空目录 同时可通过.dockerignore文件忽略</span><br></pre></td></tr></table></figure>

<ul>
<li>docker build 用法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#Git repo 进行构建</span><br><span class="line">docker build https://github.com/ropon/docker-test.git</span><br><span class="line">#tar压缩包构建</span><br><span class="line">docker build https://server/context.tar.gz</span><br><span class="line">#读取Dockerfile 进行构建</span><br><span class="line">docker build - &lt; Dockerfile</span><br><span class="line">cat Dockerfile  docker build -</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Dockerfile 指令详解</p>
<ul>
<li><p>COPY 复制文件 <code>COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;源路径&gt;... &lt;目标路径&gt;</code> <code>COPY [--chown=&lt;user&gt;:&lt;group&gt;] [&quot;&lt;源路径1&gt;&quot;,... &quot;&lt;目标路径&gt;&quot;]</code></p>
<ul>
<li>例子 <code>COPY package.json /usr/src/app/</code> <code>COPY home.txt /mydir/</code> <code>COPY --chown=555:mygroup files* /mydir/</code></li>
</ul>
</li>
<li><p>ADD 高级复制文件</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#复制压缩包会自动解压</span><br><span class="line">ADD test.tar.gz /</span><br></pre></td></tr></table></figure>

<ul>
<li>CMD 容器启动命令 <code>CMD &lt;命令&gt;</code> <code>CMD [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;...]</code></li>
<li>例子 <code>CMD echo $HOME</code> <code>CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</code></li>
<li>ENTRYPOINT 入口点</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#1、场景一 带参数</span><br><span class="line">cat Dockerfile</span><br><span class="line">FROM ubuntu:18.04</span><br><span class="line">RUN apt-get update \</span><br><span class="line">&amp;&amp; apt-get install -y curl \</span><br><span class="line">&amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="line">ENTRYPOINT [&quot;curl&quot;, &quot;-s&quot;, &quot;https://ip.ropon.top&quot;]</span><br><span class="line">docker build -t myip .</span><br><span class="line">#测试</span><br><span class="line">docker run myip -i</span><br><span class="line">docker run myip</span><br><span class="line">#2、场景2 预处理</span><br><span class="line">FROM alpine:3.4</span><br><span class="line">...</span><br><span class="line">RUN addgroup -S redis &amp;&amp; adduser -S -G redis redis</span><br><span class="line">...</span><br><span class="line">ENTRYPOINT [&quot;docker-entrypoint.sh&quot;]</span><br><span class="line">EXPOSE 6379</span><br><span class="line">CMD [ &quot;redis-server&quot; ]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ENV 设置环境变量 <code>ENV &lt;key&gt; &lt;value&gt;</code> <code>ENV &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt;...</code></p>
</li>
<li><p>例子</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ENV NODE_VERSION 7.2.0</span><br><span class="line">RUN curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/node-v$NOD</span><br><span class="line">E_VERSION-linux-x64.tar.xz&quot; &amp;&amp; curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/SHASUMS25</span><br><span class="line">6.txt.asc&quot; &amp;&amp; gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.tx</span><br><span class="line">t.asc &amp;&amp; grep &quot; node-v$NODE_VERSION-linux-x64.tar.xz\$&quot; SHASUMS256.t</span><br><span class="line">xt  sha256sum -c - &amp;&amp; tar -xJf &quot;node-v$NODE_VERSION-linux-x64.tar.xz&quot; -C /usr/loc</span><br><span class="line">al --strip-components=1 &amp;&amp; rm &quot;node-v$NODE_VERSION-linux-x64.tar.xz&quot; SHASUMS256.txt.asc SHASUMS256.txt &amp;&amp; ln -s /usr/local/bin/node/usr/local/bin/nodejs</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ARG 构建参数 <code>ARG &lt;参数名&gt;[=&lt;默认值&gt;]</code></p>
</li>
<li><p>VOLUME 定义匿名卷 <code>VOLUME [&quot;&lt;路径1&gt;&quot;, &quot;&lt;路径2&gt;&quot;...]</code> <code>VOLUME &lt;路径&gt;</code></p>
<ul>
<li>例子 <code>#向/data 写入信息不会记录容器存储层 VOLUME /data</code></li>
</ul>
</li>
<li><p>EXPOSE 声明端口 <code>EXPOSE &lt;端口1&gt; [&lt;端口2&gt;...]</code></p>
</li>
<li><p>WORKDIR 指定工作目录 <code>WORKDIR &lt;工作目录路径&gt;</code></p>
</li>
<li><p>USER 指定当前用户 <code>USER &lt;用户名&gt;[:&lt;用户组&gt;]</code></p>
</li>
<li><p>例子</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RUN groupadd -r redis &amp;&amp; useradd -r -g redis redis</span><br><span class="line">USER redis</span><br><span class="line">RUN [ &quot;redis-server&quot; ]</span><br></pre></td></tr></table></figure>

<ul>
<li>HEALTHCHECK 健康检查 <code>HEALTHCHECK [选项] CMD &lt;命令&gt;</code></li>
<li>例子</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:18.04</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y nginx curl &amp;&amp; rm -rf /var/lib/apt/lists/*</span><br><span class="line">HEALTHCHECK --interval=5s --timeout=3s CMD curl -fs http://localhost/  exit 1</span><br><span class="line">CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</span><br><span class="line">#启动容器测试</span><br><span class="line">docker run -d --name web -p 80:80 nginx:V4</span><br><span class="line">#查看健康状态</span><br><span class="line">docker inspect --format &#x27;&#123;&#123;json .State.Health&#125;&#125;&#x27; web  python -m json.tool</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ONBUILD 为了定制当前镜像而准备 <code>ONBUILD &lt;其它指令&gt;</code></p>
</li>
<li><p>例子</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM node:slim</span><br><span class="line">RUN mkdir /app</span><br><span class="line">WORKDIR /app</span><br><span class="line">ONBUILD COPY ./package.json /app</span><br><span class="line">ONBUILD RUN [ &quot;npm&quot;, &quot;install&quot; ]</span><br><span class="line">ONBUILD COPY . /app/</span><br><span class="line">CMD [ &quot;npm&quot;, &quot;start&quot; ]</span><br></pre></td></tr></table></figure>
</li>
<li><p>多阶段构建镜像</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY testgo .</span><br><span class="line">ENTRYPOINT [&quot;/app/testgo&quot;]</span><br></pre></td></tr></table></figure>

<h4 id="Docker容器"><a href="#Docker容器" class="headerlink" title="Docker容器"></a>Docker容器</h4><ul>
<li><p>启动容器 <code>docker run</code></p>
<ul>
<li>新建并启动</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#新建一个容器</span><br><span class="line">docker run ubuntu:18.04 /bin/echo &quot;hello world&quot;</span><br><span class="line">#新建一个容器启动一个终端 用于交互</span><br><span class="line">docker run -t -i ubuntu:18.04 /bin/bash</span><br></pre></td></tr></table></figure>

<ul>
<li>启动已终止容器 <code>docker container start</code></li>
<li>后台运行 <code>docker run -d</code></li>
</ul>
</li>
<li><p>终止容器 <code>docker container stop</code></p>
</li>
<li><p>进入容器 <code>使用-d 参数时 容器启动后回进入后台 可使用docker attach 或 docker exec(exit退出时容器不会因此停止)</code></p>
</li>
<li><p>导出和导入容器</p>
<ul>
<li>导出容器 <code>docker export 7691a814370e &gt; ubuntu.tar</code></li>
<li>导入容器 <code>cat ubuntu.tar docker import - test/ubuntu:v1.0</code></li>
</ul>
</li>
<li><p>删除容器 <code>docker container rm 或docker rm 强制删除-f</code> <code>docker container prune 清理所有终止容器</code></p>
</li>
<li><p>拉取镜像</p>
<p><code>docker search centos 搜索镜像</code></p>
<p><code>docker pull ansible/centos7-ansible 拉取镜像</code></p>
</li>
<li><p>私有仓库</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#安装运行docker-registry</span><br><span class="line">docker run -d -p 5000:5000 --restart=always --name registry registry</span><br><span class="line">#-v 指定镜像存放路径</span><br></pre></td></tr></table></figure>

<ul>
<li>私有仓库上传、搜索、下载镜像</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#标记镜像</span><br><span class="line">docker tag helloworld:V1 127.0.0.1:5000/helloworld:V1</span><br><span class="line">#上传标记镜像</span><br><span class="line">docker push 127.0.0.1:5000/helloworld:V1</span><br><span class="line">#查看镜像信息</span><br><span class="line">curl 127.0.0.1:5000/v2/_catalog</span><br></pre></td></tr></table></figure>

<h4 id="Docker数据管理"><a href="#Docker数据管理" class="headerlink" title="Docker数据管理"></a>Docker数据管理</h4><ul>
<li>数据卷 <code>docker volume create my-vol 创建一个数据卷</code> <code>docker run -P -it --name web --mount source=my-vol,target=/webapp ubuntu:18.04 /bin/bash 启动一个挂载数据卷的容器</code> <code>docker inspect web 查看数据卷的具体信息</code> <code>docker volume rm my-vol 删除数据卷</code> <code>docker volume prune 去拿过来无主的数据卷</code></li>
<li>挂载主机目录 <code>docker run -it --name web --mount type=bind,source=/home/docker,target=/webapp ubuntu:18.04 /bin/bash</code> <code>默认读写 可--mount type=bind,source=/home/docker,target=/webapp,readonly 配置只读</code></li>
<li>应用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#记录容器内的操作日志</span><br><span class="line">docker run --rm -it --mount type=bind,source=$HOME/.bash_history,target=/root/.bash_history ubuntu:18.04 bash</span><br></pre></td></tr></table></figure>

<h4 id="Docker-网络"><a href="#Docker-网络" class="headerlink" title="Docker 网络"></a>Docker 网络</h4><ul>
<li><p>外部访问容器 <code>-p 指定端口映射 -p 8080:80 -P会随机映射一个49000~49900</code></p>
</li>
<li><p>映射所有接口地址 <code>-p 5000:5000</code></p>
</li>
<li><p>映射到指定地址的指定端口 <code>-p 127.0.0.1:5000:5000</code></p>
</li>
<li><p>映射指定地址的任意端口 <code>-p 127.0.0.1::5000</code> <code>-p 127.0.0.1:5000:5000/udp 标记指定udp端口</code></p>
</li>
<li><p>查看映射端口配置 <code>docker port nostalgic_morse 5000</code></p>
</li>
<li><p>容器互联</p>
<ul>
<li><p>新建网络 <code>docker network create -d bridge my-net</code></p>
</li>
<li><p>连接容器</p>
</li>
</ul>
<p><code>docker run -it --rm --name test01 --network my-net centos:7 /bin/bash</code> <code>docker run -it --rm --name test02 --network my-net centos:7 /bin/bash</code></p>
<ul>
<li>配置 DNS</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/docker/daemon.json</span><br><span class="line">&quot;dns&quot;: [</span><br><span class="line">                &quot;119.29.29.29&quot;.</span><br><span class="line">                &quot;114.114.114.114&quot;</span><br><span class="line">]</span><br><span class="line">#设置主机名</span><br><span class="line">-h name</span><br><span class="line">docker run -h testname</span><br><span class="line">#设置dns</span><br><span class="line">--dns=119.29.29.29</span><br><span class="line">docker run --dns=119.29.29.29</span><br><span class="line">#配置dns搜索域</span><br><span class="line">--dns-search=west.cn</span><br><span class="line">docker run --dns-search=west.cn</span><br></pre></td></tr></table></figure>

<ul>
<li><p>高级网络配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker启动时 --&gt; 会在主机自动创建一个docker0虚拟网桥(bridge 软件交换机)</span><br><span class="line">一端eth0 另外一端是vethXXXX</span><br></pre></td></tr></table></figure>
</li>
<li><p>快速配置指南</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-b 指定容器挂载的网桥</span><br><span class="line">--bip=CIDR 定制docker0的掩码</span><br><span class="line">-H SOCKET docker服务端接收命令的通道</span><br><span class="line">--icc=truefalse 是否支持容器间通信</span><br><span class="line">--ip-forward=truefalse</span><br><span class="line">--iptables=truefalse 是否运行docker添加iptables规则</span><br><span class="line">--mtu=BYTES 容器网络中MTU</span><br><span class="line">--dns=223.5.5.5</span><br><span class="line">--dns-search=west.cn</span><br><span class="line">-h hostname</span><br><span class="line">--link=CONTAINER_NAME:ALIAS 添加到另外一个容器的连接</span><br><span class="line">--net=bridgenonecontainer:NAME_OR_IDhost 配置容器桥接模式</span><br><span class="line">-p SEPC 映射容器端口到宿主主机</span><br><span class="line">-P 映射容器所有端口到宿主主机</span><br></pre></td></tr></table></figure>
</li>
<li><p>容器访问控制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#容器访问外部网络</span><br><span class="line">#打开系统转发</span><br><span class="line">cat /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">#容器之间访问</span><br><span class="line">#所有容器都会被连接到docker0网桥上</span><br><span class="line">#本地系统防火墙是否运行通过</span><br><span class="line">#访问所有端口</span><br><span class="line">默认情况下，不同容器之间是允许网络互通</span><br><span class="line">为了安全，可在/etc/docker/daemon.json配置&quot;icc&quot;: false</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问指定端口</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-icc=false 关闭网络访问后 还可通过 --link=CONTAINER_NAME:ALIAS 访问容器开放端口</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置docker0网桥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker服务默认会创建一个docker0网桥 还给docker0网桥设置IP地址和子网掩码</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义网桥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#删除旧网桥</span><br><span class="line">yum install -y bridge-utils</span><br><span class="line">systemctl stop docker</span><br><span class="line">ip link set dev docker0 down</span><br><span class="line">brctl delbr docker0</span><br><span class="line">#创建一个网桥</span><br><span class="line">brctl addbr bridge0</span><br><span class="line">ip addr add 192.168.5.1/24 dev bridge0</span><br><span class="line">ip link set dev bridge0 up</span><br><span class="line">#在/etc/docker/daemon.json配置</span><br><span class="line">&quot;bridge&quot;: &quot;bridge0&quot;</span><br></pre></td></tr></table></figure>

<h4 id="Compose"><a href="#Compose" class="headerlink" title="Compose"></a>Compose</h4></li>
<li><p>安装 <code>yum install -y docker-compose</code></p>
</li>
<li><p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/mypython</span><br><span class="line">cd /root/mypython</span><br><span class="line">cat app.py</span><br><span class="line">from flask import Flask</span><br><span class="line">from redis import Redis</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=&#x27;redis&#x27;, port=6379)</span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def hello():</span><br><span class="line">      count = redis.incr(&#x27;hits&#x27;)</span><br><span class="line">      return &#x27;Hello World! 该页面已被访问 &#123;&#125; 次。\n&#x27;.format(count)</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">      app.run(host=&quot;0.0.0.0&quot;, debug=True)</span><br><span class="line">cat Dockerfile</span><br><span class="line">FROM python:3.6-alpine</span><br><span class="line">ADD . /code</span><br><span class="line">WORKDIR /code</span><br><span class="line">RUN pip install redis flask</span><br><span class="line">CMD [&quot;python&quot;, &quot;app.py&quot;]</span><br><span class="line"></span><br><span class="line">cat docker-compose.yml</span><br><span class="line">version: &#x27;3&#x27;</span><br><span class="line">services:</span><br><span class="line">web:</span><br><span class="line">  build: .</span><br><span class="line">  ports:</span><br><span class="line">    - &quot;5000:5000&quot;</span><br><span class="line">redis:</span><br><span class="line">  image: &quot;redis:alpine&quot;</span><br><span class="line"></span><br><span class="line">#运行compose项目</span><br><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>
</li>
<li><p>命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#命令选项</span><br><span class="line">-f 指定使用的compose模板文件 默认docker-compose.yml</span><br><span class="line">-p 指定项目名称 默认使用目录名作为项目名称</span><br><span class="line">--x-networking 使用docker的可插拔网络后端特性</span><br><span class="line">--x-networking-driver DRIVER 指定网络后端的驱动 默认bridge</span><br><span class="line">--verbose 输出更多调试信息</span><br><span class="line">-v 打印版本并退出</span><br><span class="line"></span><br><span class="line">#命令使用</span><br><span class="line">build 构建项目中服务容器</span><br><span class="line">--force-rm 删除构建过程中的临时容器</span><br><span class="line">--no-cache 构建过程中不使用cache</span><br><span class="line">--pull 始终尝试通过pull获取新版本的镜像</span><br><span class="line"></span><br><span class="line">config 检查compose文件格式是否正确</span><br><span class="line">down 停止up命令所启动的容器并移除网络</span><br><span class="line">exec 进入指定的容器</span><br><span class="line">images 列出compose文件中包含的镜像</span><br><span class="line">kill -s参数指定发送的信号 docker-compose kill -s SIGINT 强制停止所有容器</span><br><span class="line">logs 查看服务容器的输出</span><br><span class="line">pause 暂停一个服务容器</span><br><span class="line">port 输出某个容器端口锁映射的公共端口</span><br><span class="line">ps 列出项目中目前所有容器 -q参数 只打印容器ID信息</span><br><span class="line">pull 拉取服务依赖的镜像 --ignore-pull-failures 忽略拉取过程中的错误</span><br><span class="line">push 推送服务依赖的镜像到docker镜像仓库</span><br><span class="line">restart 重启项目中的服务</span><br><span class="line">rm 删除所有服务容器</span><br><span class="line">run 在指定服务商执行命令</span><br><span class="line">scale 设置指定服务运行的容器个数 docker-compose scale web=3 db=2</span><br><span class="line">start 启动已经存在的服务容器</span><br><span class="line">stop 停止已经处于运行状态的容器</span><br><span class="line">top 查看各个服务容器内的运行的进程</span><br><span class="line">unpause 恢复暂停中的服务</span><br><span class="line">up 自动完成包括构建镜像 创建服务 启动服务</span><br></pre></td></tr></table></figure>
</li>
<li><p>compose模板文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">build Dockerfile所在文件夹的路径</span><br><span class="line">cap_add cap_drop 指定容器内核能力分配</span><br><span class="line">#拥有所有能力</span><br><span class="line">cap_add:</span><br><span class="line">- ALL</span><br><span class="line">#去掉NET_ADMIN能力</span><br><span class="line">cap_drop：</span><br><span class="line">- NET_ADMIN</span><br><span class="line">command 覆盖容器启动后默认执行命令</span><br><span class="line">command: echo &quot;hello world&quot;</span><br><span class="line">configs 仅用于swarm mode</span><br><span class="line">cgroup_parent 指定父cgroup 继承改组的资源限制</span><br><span class="line">container_name 指定容器名称</span><br><span class="line">deploy 仅用于swarm node</span><br><span class="line">devices 指定设备映射关系</span><br><span class="line">depends_on 解决容器依赖 启动先后</span><br><span class="line">services:</span><br><span class="line">web:</span><br><span class="line">  build: .</span><br><span class="line">  depends_on:</span><br><span class="line">    - db</span><br><span class="line">    - redis</span><br><span class="line">dns 自定义dns</span><br><span class="line">dns: 114.114.114.114</span><br><span class="line">dns:</span><br><span class="line">- 8.8.8.8</span><br><span class="line">- 114.114.114.114</span><br><span class="line">dns_search 配置dns搜索域</span><br><span class="line">tmpfs 挂载一个tmpfs文件系统到容器</span><br><span class="line">env_file 从文件中获取环境变量</span><br><span class="line">environment 设置环境变量</span><br><span class="line">expose 暴露端口 但不映射到宿主机</span><br><span class="line">external_links</span><br><span class="line">extra_hosts 指定额外的host名称映射信息</span><br><span class="line">healthcheck 通过命令检查容器是否正常运行</span><br><span class="line">image 指定镜像名称或镜像ID</span><br><span class="line">labels 为容器添加元信息</span><br><span class="line">logging 配置日志选项</span><br><span class="line">network_mode 设置网络模式</span><br><span class="line">networks 配置容器连接的网络</span><br><span class="line">pid</span><br><span class="line">ports 暴露端口信息</span><br><span class="line">secrets 储存敏感数据</span><br><span class="line">security_opt 配置标签的用户名和角色名</span><br><span class="line">stop_signal 设置另外一个信号来停止容器</span><br><span class="line">sysctls 配置容器内核参数</span><br><span class="line">ulimits 指定容器的限制值</span><br><span class="line">volumes 配置挂载数据卷 HOST:CONTAINER:ro</span><br><span class="line">volumes:</span><br><span class="line">- /var/lib/mysql/:ro</span><br></pre></td></tr></table></figure>
</li>
<li><p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/mydjango</span><br><span class="line">cd /root/mydjango</span><br><span class="line">cat Dockerfile</span><br><span class="line">FROM python:3.6-alpine</span><br><span class="line">ENV PYTHONUNBUFFERED 1</span><br><span class="line">WORKDIR /code</span><br><span class="line">ADD . /code/</span><br><span class="line">RUN pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line"></span><br><span class="line">cat docker-compose.yml</span><br><span class="line">version: &#x27;3&#x27;</span><br><span class="line">services:</span><br><span class="line">web:</span><br><span class="line">  build: .</span><br><span class="line">  command: python3 manage.py runserver 0.0.0.0:8080</span><br><span class="line">  volumes:</span><br><span class="line">    - .:/code</span><br><span class="line">  ports:</span><br><span class="line">    - &quot;8080:8080&quot;</span><br></pre></td></tr></table></figure>

<h4 id="Docker-Machine"><a href="#Docker-Machine" class="headerlink" title="Docker Machine"></a>Docker Machine</h4></li>
<li><p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/docker/machine/releases/download/v0.16.2/docker-machine-uname -s-uname -m &gt;/tmp/docker-machine &amp;&amp;</span><br><span class="line">  chmod +x /tmp/docker-machine &amp;&amp;</span><br><span class="line">  sudo cp /tmp/docker-machine /usr/local/bin/docker-machine</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">active 查看活跃的docker主机</span><br><span class="line">config 输出连接的配置信息</span><br><span class="line">create 创建一个docker主机</span><br><span class="line">env 显示连接某主机需要的环境变量</span><br><span class="line">inspect 获取主机更多信息</span><br><span class="line">ip 获取主机地址</span><br><span class="line">kill 停止某主机</span><br><span class="line">ls 列出所有管理的主机</span><br><span class="line">provision 重新设置一个已存在的主机</span><br><span class="line">regenerate-certs 为某个主机重新生成TLS认证信息</span><br><span class="line">restart 重启主机</span><br><span class="line">rm 删除某台主机</span><br><span class="line">ssh SSH到主机上执行命令</span><br><span class="line">scp 在主机之间复制文件</span><br><span class="line">mount 挂载主机目录到本地</span><br><span class="line">start 启动主机</span><br><span class="line">status 查看主机状态</span><br><span class="line">stop 停止主机</span><br><span class="line">upgrade 更新主机docker版本为最新</span><br><span class="line">url 获取主机URL</span><br><span class="line">version 输出docker-machine版本信息</span><br><span class="line">help 输出帮助信息</span><br></pre></td></tr></table></figure>

<h4 id="Docker-Swarm"><a href="#Docker-Swarm" class="headerlink" title="Docker Swarm"></a>Docker Swarm</h4></li>
<li><p>Swarm 集群管理编排工具 <code>docker swarm</code></p>
</li>
<li><p>初始化集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#初始化</span><br><span class="line">docker swarm init --advertise-addr 172.16.7.127</span><br><span class="line">#增加工作节点</span><br><span class="line">docker swarm join --token xxxxxx 172.16.7.127:2377</span><br><span class="line">#查看集群</span><br><span class="line">docker node ls</span><br></pre></td></tr></table></figure>
</li>
<li><p>部署服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#新建服务</span><br><span class="line">docker service create --replicas 3 -p 80:80 --name nginx nginx:V3</span><br><span class="line">#查看服务</span><br><span class="line">docker service ls</span><br><span class="line">#查看某个服务的日志</span><br><span class="line">docker service logs nginx</span><br><span class="line">#服务伸缩</span><br><span class="line">#增加</span><br><span class="line">docker service scale nginx=8</span><br><span class="line">#减少</span><br><span class="line">docker service scale nginx=2</span><br><span class="line">#删除服务</span><br><span class="line">docker service rm nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>Swarm集群使用compose文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3&#x27;</span><br><span class="line">services:</span><br><span class="line">wordpress:</span><br><span class="line">  image: wordpress</span><br><span class="line">  ports:</span><br><span class="line">    - 80:80</span><br><span class="line">  networks:</span><br><span class="line">    - overlay</span><br><span class="line">  environment:</span><br><span class="line">    WORDPRESS_DB_HOST: db:3306</span><br><span class="line">    WORDPRESS_DB_USER: wordpress</span><br><span class="line">    WORDPRESS_DB_PASSWORD: wordpress</span><br><span class="line">  deploy:</span><br><span class="line">    mode: replicated</span><br><span class="line">    replicas: 3</span><br><span class="line"></span><br><span class="line">db:</span><br><span class="line">  image: mysql</span><br><span class="line">  networks:</span><br><span class="line">    - overlay</span><br><span class="line">  volumes:</span><br><span class="line">    - db-data:/var/lib/mysql</span><br><span class="line">  environment:</span><br><span class="line">    MYSQL_ROOT_PASSWORD: somewordpress</span><br><span class="line">    MYSQL_DATABASE: wordpress</span><br><span class="line">    MYSQL_USER: wordpress</span><br><span class="line">    MYSQL_PASSWORD: wordpress</span><br><span class="line">  deploy:</span><br><span class="line">    placement:</span><br><span class="line">      constraints: [node.role == manager]</span><br><span class="line"></span><br><span class="line">visualizer:</span><br><span class="line">  image: dockersamples/visualizer:stable</span><br><span class="line">  ports:</span><br><span class="line">    - 8080:8080</span><br><span class="line">  stop_grace_period: 1m30s</span><br><span class="line">  volumes:</span><br><span class="line">    - &quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span><br><span class="line">  deploy:</span><br><span class="line">    placement:</span><br><span class="line">      constraints: [node.role == manager]</span><br><span class="line">volumes:</span><br><span class="line">db-data:</span><br><span class="line">networks:</span><br><span class="line">overlay:</span><br><span class="line"></span><br><span class="line">#部署服务</span><br><span class="line">docker stack deploy -c docker-compose.yml wordpress</span><br><span class="line">#查看服务</span><br><span class="line">docker stack ls</span><br><span class="line">#移除服务</span><br><span class="line">docker stack down 服务名  </span><br></pre></td></tr></table></figure>
</li>
<li><p>Swarm集群管理敏感数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#创建secret</span><br><span class="line">openssl rand -base64 20  docker secret create mysql_password -</span><br><span class="line">#查看secret</span><br><span class="line">docker secret ls</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建MySQL服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d overlay mysql_private</span><br><span class="line"></span><br><span class="line">docker service create \</span><br><span class="line">--name mysql \</span><br><span class="line">--replicas 1 \</span><br><span class="line">--network mysql_private \</span><br><span class="line">--mount type=volume,source=mydata,destination=/var/lib/mysql \</span><br><span class="line">--secret source=mysql_root_password,target=mysql_root_password \</span><br><span class="line">--secret source=mysql_password,target=mysql_password \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD_FILE=&quot;/run/secrets/mysql_root_password&quot; \</span><br><span class="line">-e MYSQL_PASSWORD_FILE=&quot;/run/secrets/mysql_password&quot; \</span><br><span class="line">-e MYSQL_USER=&quot;wordpress&quot; \</span><br><span class="line">-e MYSQL_DATABASE=&quot;wordpress&quot; \</span><br><span class="line">mysql:latest</span><br><span class="line"></span><br><span class="line">docker service create \</span><br><span class="line">--name wordpress \</span><br><span class="line">--replicas 1 \</span><br><span class="line">--network mysql_private \</span><br><span class="line">-p 3000:80 \</span><br><span class="line">--mount type=volume,source=wpdata,destination=/var/www/html \</span><br><span class="line">--secret source=mysql_password,target=wp_db_password,mode=0400 \</span><br><span class="line">-e WORDPRESS_DB_USER=&quot;wordpress&quot; \</span><br><span class="line">-e WORDPRESS_DB_PASSWORD_FILE=&quot;/run/secrets/wp_db_password&quot;\</span><br><span class="line">-e WORDPRESS_DB_HOST=&quot;mysql:3306&quot; \</span><br><span class="line">-e WORDPRESS_DB_NAME=&quot;wordpress&quot; \</span><br><span class="line">wordpress:latest</span><br></pre></td></tr></table></figure>
</li>
<li><p>Swarm集群中管理配置数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#新建redis.conf文件</span><br><span class="line">cat redis.conf</span><br><span class="line">port 6380</span><br><span class="line">#创建config</span><br><span class="line">docker config create redis.conf redis.conf</span><br><span class="line">#查看config</span><br><span class="line">docker config ls</span><br><span class="line">#创建redis服务</span><br><span class="line">docker service create \</span><br><span class="line">--name redis \</span><br><span class="line">--config redis.conf \</span><br><span class="line">-p 6379:6380 \</span><br><span class="line">redis:latest \</span><br><span class="line">redis-server /redis.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>Swarm mode与滚动升级</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#之前已通过命令创建nginx服务</span><br><span class="line">docker service create --name nginx --replicas 2 -p 80:80 nginx:1.13.7-alpine</span><br><span class="line">#升级</span><br><span class="line">docker service update \</span><br><span class="line">--image nginx:1.13.12-alpine \</span><br><span class="line">nginx</span><br><span class="line"></span><br><span class="line">#回滚</span><br><span class="line">docker service rollback nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>etcd集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3&#x27;</span><br><span class="line">networks:</span><br><span class="line">byfn:</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">etcd1:</span><br><span class="line">  image: quay.io/coreos/etcd</span><br><span class="line">  container_name: etcd1</span><br><span class="line">  command: etcd -name etcd1 -advertise-client-urls http://0.0.0.0:2379 -listen-client-urls http://0.0.0.0:2379 -listen-peer-urls http://0.0.0.0:2380 -initial-cluster-token etcd-cluster -initial-cluster &quot;etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380&quot; -initial-cluster-state new</span><br><span class="line">  ports:</span><br><span class="line">    - 2379</span><br><span class="line">    - 2380</span><br><span class="line">  networks:</span><br><span class="line">    - byfn</span><br><span class="line"></span><br><span class="line">etcd2:</span><br><span class="line">  image: quay.io/coreos/etcd</span><br><span class="line">  container_name: etcd2</span><br><span class="line">  command: etcd -name etcd2 -advertise-client-urls http://0.0.0.0:2379 -listen-client-urls http://0.0.0.0:2379 -listen-peer-urls http://0.0.0.0:2380 -initial-cluster-token etcd-cluster -initial-cluster &quot;etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380&quot; -initial-cluster-state new</span><br><span class="line">  ports:</span><br><span class="line">    - 2379</span><br><span class="line">    - 2380</span><br><span class="line">  networks:</span><br><span class="line">    - byfn</span><br><span class="line"></span><br><span class="line">etcd3:</span><br><span class="line">  image: quay.io/coreos/etcd</span><br><span class="line">  container_name: etcd3</span><br><span class="line">  command: etcd -name etcd3 -advertise-client-urls http://0.0.0.0:2379 -listen-client-urls http://0.0.0.0:2379 -listen-peer-urls http://0.0.0.0:2380 -initial-cluster-token etcd-cluster -initial-cluster &quot;etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380&quot; -initial-cluster-state new</span><br><span class="line">  ports:</span><br><span class="line">    - 2379</span><br><span class="line">    - 2380</span><br><span class="line">  networks:</span><br><span class="line">    - byfn</span><br><span class="line"></span><br><span class="line">#查看集群状态</span><br><span class="line">docker exec -t etcd1 etcdctl member list</span><br><span class="line"></span><br><span class="line">#etcd操作</span><br><span class="line">#set 设置值 </span><br><span class="line">etcdctl put /testdir/testkey &quot;Hello world&quot;</span><br><span class="line">#put 更新值</span><br><span class="line">etcdctl update /testdir/testkey &quot;Hello world 666&quot;</span><br><span class="line">#get 获取值</span><br><span class="line">etcdctl get /testdir/testkey</span><br><span class="line">#更多命令可查--help</span><br><span class="line">etcdctl --help</span><br></pre></td></tr></table></figure>
</li>
<li><p>k8s</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#快速上手</span><br><span class="line">#启动etcd服务</span><br><span class="line">docker run --net=host -d gcr.io/google_containers/etcd:2.0.9 /usr/local/bin/etcd --addr=127.0.0.1:4001 --bind-addr=0.0.0.0:4001 --data-dir=/var/etcd/data</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/05/28/docker%E5%AE%89%E8%A3%85%E5%8F%8A%E9%95%9C%E5%83%8F%E7%9F%A5%E8%AF%86/" data-id="clc4klg4z002iojobb3ju37ba" data-title="Docker相关知识总结" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-网络知识总结-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/27/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93-1/" class="article-date">
  <time class="dt-published" datetime="2020-05-27T05:55:17.000Z" itemprop="datePublished">2020-05-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/">经验分享</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/27/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93-1/">网络知识总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="OSI七层模型"><a href="#OSI七层模型" class="headerlink" title="OSI七层模型"></a>OSI七层模型</h3><hr>
<ul>
<li>应用层 （具体应用 http ftp等协议）</li>
<li>表示层 （相互转换编码 高级语言&lt;&#x3D;&gt;机器码）</li>
<li>会话层 （分流 是否通过网络转发出去）</li>
<li>传输层 （端口PORT(0-65535 16位2进制 0-1023 系统占用) 协议TCP(慢可靠性高) UDP(简单快可靠性差)）</li>
<li>网络层 （网络地址 IP IP数据包 最大65535字节）</li>
<li>数据链路层 （mac地址 48位二进制 12位16进制 解读电信号0 1 同一局域网 广播方式 发送）</li>
<li>物理层 （传送0和1的电信号）</li>
</ul>
<h3 id="TCP建立链接"><a href="#TCP建立链接" class="headerlink" title="TCP建立链接"></a>TCP建立链接</h3><hr>
<ul>
<li>A向B发送SYN(i)同步包</li>
<li>B向A回复ACK(i+1)确认包并发送SYN(k)同步包</li>
<li>A向B回复ACK(k+1)确认包 链接建立成功 <strong>三次握手</strong></li>
</ul>
<h3 id="TCP断开链接"><a href="#TCP断开链接" class="headerlink" title="TCP断开链接"></a>TCP断开链接</h3><hr>
<ul>
<li>A向B发送FIN(i)释放包</li>
<li>B向A回复ACK(i+1)确认包 A不再向B发送数据 若B也不再向A发送数据</li>
<li>B向A发送FIN(k)释放包</li>
<li>A向B回复ACK(k+1)确认包 链接断开成功 <strong>四次挥手</strong></li>
</ul>
<h3 id="TCP三次握手为啥需要四次挥手呢"><a href="#TCP三次握手为啥需要四次挥手呢" class="headerlink" title="TCP三次握手为啥需要四次挥手呢"></a>TCP三次握手为啥需要四次挥手呢</h3><hr>
<p>tcp是全双工，需要确认双方都不传输数据才断开</p>
<h3 id="TCP-11种状态"><a href="#TCP-11种状态" class="headerlink" title="TCP 11种状态"></a>TCP 11种状态</h3><hr>
<ul>
<li>CLOSED 初始状态 表示tcp连接关注着或未打开</li>
<li>LISTEN 服务端启动socket处于监听状态 等待客户端连接</li>
<li>SYN_RCVD 服务器接收客户端请求发来SYN报文</li>
<li>SYN-SENT 客户端已发送SYN报文</li>
<li>ESTABLISHED TCP连接已成功建立</li>
<li>FIN_WAIT_1 等待对方发来FIN报文</li>
<li>FIN_WAIT_2 等待对方发来FIN报文</li>
<li>TIME_WAIT 收到了对方的FIN报文并发送ACK报文</li>
<li>CLOSING 一方发送FIN报文后，并没有收到对方的ACK报文，反而却也收到了对方的FIN报文</li>
<li>CLOSE_WAIT 发送FIN报文给自己 应该回应一个ACK报文给对方</li>
<li>LAST_ACK 当被动关闭的一方在发送FIN报文后，等待对方的ACK报文的时候 <img src="https://www.ropon.top/wp-content/uploads/2020/07/20150428144449522-262x300.png" alt="image"></li>
</ul>
<h3 id="SSL-x2F-TLS握手流程"><a href="#SSL-x2F-TLS握手流程" class="headerlink" title="SSL&#x2F;TLS握手流程"></a>SSL&#x2F;TLS握手流程</h3><hr>
<ul>
<li>client向server发送client hello(生成随机数(client random)告诉server支持加密算法)</li>
<li>server向client发送server hello(生成随机数(server random)并选择一个client支持加密算法并下发证书(公钥))</li>
<li>client校验证书是否合法,合法再生成一个随机数(premaster secret)并用公钥加密发送给server</li>
<li>server使用私钥获取client发来的随机数</li>
<li>client和server根据之前约定的加密算法(对称加密)，使用前面的三个随机数，生成”对话密钥”（session key），用来加密接下来的整个对话过程</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/05/27/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93-1/" data-id="clc4klg8000biojobaocs6olh" data-title="网络知识总结" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-了解iptables-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/27/%E4%BA%86%E8%A7%A3iptables-1/" class="article-date">
  <time class="dt-published" datetime="2020-05-27T01:42:08.000Z" itemprop="datePublished">2020-05-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/">经验分享</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/27/%E4%BA%86%E8%A7%A3iptables-1/">了解iptables</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><h4 id="运行内核上，不需要启动进程"><a href="#运行内核上，不需要启动进程" class="headerlink" title="运行内核上，不需要启动进程"></a>运行内核上，不需要启动进程</h4><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ul>
<li>filter 过滤</li>
<li>nat 地址转换</li>
<li>mangle 拆解报文 修改 再封装</li>
<li>raw 关闭nat表连接追踪功能</li>
</ul>
<h3 id="链"><a href="#链" class="headerlink" title="链"></a>链</h3><ul>
<li>prerouting 路由前</li>
<li>input 到达本机内部的报文必经之路</li>
<li>forward 由本机转发的报文必经之路</li>
<li>output 由本机发出的报文必经之路</li>
<li>postrouting 路由后</li>
</ul>
<h3 id="数据报文流程"><a href="#数据报文流程" class="headerlink" title="数据报文流程"></a>数据报文流程</h3><ul>
<li>流入 prerouting -&gt; input</li>
<li>流出 output -&gt; postrouting</li>
<li>转发 prerouting -&gt; forward -&gt; postrouting</li>
</ul>
<h3 id="总结-四表五链"><a href="#总结-四表五链" class="headerlink" title="总结 四表五链"></a>总结 四表五链</h3><ul>
<li>四表 filter nat mangle raw</li>
<li>五链 prerouting input forward output postrouting</li>
</ul>
<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><ul>
<li>prerouting raw –&gt; mangle –&gt; nat</li>
<li>raw –&gt; mangle –&gt; nat –&gt; filter (任意链执行优先级)</li>
</ul>
<h3 id="数据经过防火墙流程"><a href="#数据经过防火墙流程" class="headerlink" title="数据经过防火墙流程"></a>数据经过防火墙流程</h3><p>​</p>
<p>​ input ouput</p>
<p>​ (mangle –&gt; [nat] –&gt; filter) (raw –&gt; mangle –&gt; nat –&gt; filter)</p>
<p>​</p>
<p>入–&gt; prerouting –&gt; 路由判断 –&gt; forward –&gt; postrouting –&gt;出</p>
<p>​</p>
<p>(raw –&gt; mangle –&gt; nat) (mangle –&gt; nat) (mangle –&gt; nat)</p>
<h3 id="表和链的关系"><a href="#表和链的关系" class="headerlink" title="表和链的关系"></a>表和链的关系</h3><ul>
<li>filter input forward <strong><em>output</em></strong></li>
<li>nat prerouting(snat) <strong>output</strong> postrouting(dnat) (centos7 还有input centos6没有)</li>
<li>mangle prerouting input forward <strong>output</strong> postrouting</li>
<li>raw prerouting output</li>
</ul>
<h3 id="匹配条件"><a href="#匹配条件" class="headerlink" title="匹配条件"></a>匹配条件</h3><ul>
<li><p>基本匹配条件 source IP destination IP</p>
</li>
<li><p>扩展匹配条件 源端口 目标端口</p>
</li>
</ul>
<h3 id="处理动作"><a href="#处理动作" class="headerlink" title="处理动作"></a>处理动作</h3><ul>
<li>ACCETP 允许数据包通过</li>
<li>DROP 丢弃数据包</li>
<li>REJECT 拒绝数据包</li>
<li>SNAT 源地址转换</li>
<li>MASQUERADE</li>
<li>DNAT 目标地址转换</li>
<li>REDIRECT 端口映射</li>
<li>LOG &#x2F;var&#x2F;log&#x2F;message 记录日志</li>
</ul>
<h3 id="命令详解"><a href="#命令详解" class="headerlink" title="命令详解"></a>命令详解</h3><p>iptables -nvL</p>
<p>pkts 对应规则匹配到的报文数</p>
<p>bytes 对应规则匹配到的报文的大小总和</p>
<p>target 规则的动作</p>
<p>prot 协议</p>
<p>opt 规则对应选项</p>
<p>in 数据包由那个网卡流入</p>
<p>out 数据包由那个网卡流出</p>
<p>source 对应源地址 一个IP或IP段</p>
<p>destination 对应目标地址 一个IP或IP段</p>
<p>policy 表示某链默认策略</p>
<p>packets 默认策略匹配到包数量</p>
<p>bytes 默认策略匹配到包大小总和</p>
<h4 id="查"><a href="#查" class="headerlink" title="查"></a>查</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#-t默认参数filter -L 列出规则</span><br><span class="line">iptables -t 表名(filter nat mangle raw) -L</span><br><span class="line">#查看具体链的规则</span><br><span class="line">iptables -t 表名 -L 链名</span><br><span class="line">#查看详情更多信息 -v</span><br><span class="line">iptables -vL</span><br><span class="line">#对规则中IP或端口反解 -n</span><br><span class="line">iptables -nvL</span><br><span class="line">#显示序号 可以简写 --line</span><br><span class="line">iptables -nvL --line-number</span><br><span class="line">#显示精确计数值 -x</span><br><span class="line">iptables -nxvL INPUT</span><br><span class="line">#例子</span><br><span class="line">iptables --line -t filter -nvxL</span><br><span class="line">iptables --line -t filter -nvxL INPUT</span><br></pre></td></tr></table></figure>

<h4 id="增"><a href="#增" class="headerlink" title="增"></a>增</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#增加 I行首插入 -s 源地址</span><br><span class="line">iptables -t filter -I INPUT -s 1.1.1.1 -j DROP</span><br><span class="line">#指定行号插入</span><br><span class="line">iptables -t filter -I INPUT 2 -s 1.1.1.1 -j DROP</span><br><span class="line">#A 追加 末尾添加</span><br><span class="line">iptables -t filter -A INPUT -s 1.1.1.1 -j DROP</span><br></pre></td></tr></table></figure>

<h4 id="删"><a href="#删" class="headerlink" title="删"></a>删</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#指定行号删除</span><br><span class="line">iptables -t filter -D INPUT 1</span><br><span class="line">#指定匹配条件删除</span><br><span class="line">iptables -D INPUT -s 1.1.1.1 -j ACCEPT</span><br><span class="line">#删除指定链所有规则</span><br><span class="line">iptables -F INPUT</span><br></pre></td></tr></table></figure>

<h4 id="改"><a href="#改" class="headerlink" title="改"></a>改</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#指定匹配条件要完整</span><br><span class="line">iptables -R INPUT 1 -s 1.1.1.1 -j ACCEPT</span><br><span class="line">#修改链默认策略</span><br><span class="line">iptables -P FORWARD DROP</span><br></pre></td></tr></table></figure>

<h4 id="保存"><a href="#保存" class="headerlink" title="保存"></a>保存</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br><span class="line">iptables-save &gt; /etc/sysconfig/iptables</span><br><span class="line">#从指定文件重新载入规则</span><br><span class="line">iptables-save &lt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure>

<h4 id="匹配条件-1"><a href="#匹配条件-1" class="headerlink" title="匹配条件"></a>匹配条件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#一次指定多个用逗号隔开 -s匹配源地址 -d匹配目标地址</span><br><span class="line">iptables -I INPUT -s 1.1.1.1,2.2.2.2 -j DROP</span><br><span class="line">#指定IP段</span><br><span class="line">iptables -I INPUT -s 192.168.8.1/25 -j DROP</span><br><span class="line">#取反!</span><br><span class="line">iptables -I INPUT -s ! 1.1.1.1 -j DROP</span><br><span class="line">#-d匹配目标地址 阻止1.1.1.1向2.2.2.2发送报文</span><br><span class="line">iptables -I INPUT -s 1.1.1.1 -d 2.2.2.2 -j DROP</span><br><span class="line">#协议类型 -p(tcp udp icmp icmp6)</span><br><span class="line">iptables -I INPUT -s 1.1.1.1 -d 2.2.2.2 -p tcp -j DROP</span><br><span class="line">#-i 指定流入网卡接口 (prerouting input forward)</span><br><span class="line">iptables -I INPUT -p icmp -i eth0 -j REJECT</span><br><span class="line">#-o 指定流出网卡接口 (forward output postrouting)</span><br><span class="line">iptables -I OUTPUT -p tcp -o eth1 -j REJECT</span><br></pre></td></tr></table></figure>

<h4 id="扩展匹配条件"><a href="#扩展匹配条件" class="headerlink" title="扩展匹配条件"></a>扩展匹配条件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#tcp --dport目标端口使用前需要先指定协议 如-p tcp -m tcp 指定对应扩展模块 </span><br><span class="line">#-m可省略默认会找-p相同模块 !取反 --tcp-flags --syn 新建链接请求报文</span><br><span class="line">iptables -I INPUT -s 1.1.1.1 -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -I INPUT -p tcp -m tcp --dport 888 --syn -j REJECT</span><br><span class="line">#--sport 源端口 支持端口范围300:500 :300 500: !取反</span><br><span class="line">iptables -I INPUT -s 1.1.1.1 -p tcp --sport 22 -j ACCEPT</span><br><span class="line">#--sport --dport不能加离散多个端口 可以借助multiport模块 !取反</span><br><span class="line">iptables -I INPUT -s 1.1.1.1 -p tcp -m multiport --sport 33,21,25 -j ACCEPT</span><br><span class="line">#iprange --src-range 源IP段 --dst-range 目标IP段 !取反</span><br><span class="line">iptables -I INPUT -m iprange --src-range 192.168.3.20-192.168.3.60 -j DROP</span><br><span class="line">#string --algo 指定算法可选bm kmp --string 指定匹配字符串</span><br><span class="line">iptables -I INPUT -m string --algo bm --string &quot;ropon&quot; -j REJECT</span><br><span class="line">#time --timestart起始时间 --timestop结束时间 --weekdays指定星期几 --monthdays指定每个月那一天</span><br><span class="line">#--datestart --datestop 指定具体日期范围 --monthdays --weekdays 可以!取反</span><br><span class="line">iptables -I OUTPUT -p tcp --dport 80 -m time --timestart 08:54:00 --timestop 08:56:00 -j REJECT</span><br><span class="line">iptables -I OUTPUT -p tcp --dport 443 -m time --timestart 08:54:00 --timestop 08:56:00 -j REJECT</span><br><span class="line">iptables -I OUTPUT -p tcp --dport 80 -m time --weekdays 6,7 -j REJECT</span><br><span class="line">iptables -I OUTPUT -p tcp --dport 443 -m time --datestart 2020-07-27 --datestop 2020-07-29 -j REJECT</span><br><span class="line">#connlimit --connlimit-above 每个IP链接数量上限 --connlimit-upto含义等于! --connlimit-above</span><br><span class="line">#--connlimit-mask指定某类网段</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT</span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 10 --connlimit-mask 27 -j REJECT</span><br><span class="line">#limit --limit 10/minute 每分钟最多放行10个包 6s放1个 --limit-burst空闲时可放行包的数量默认5</span><br><span class="line">#令牌桶原理 /second /minute /hour/day</span><br><span class="line">iptables -I INPUT -p icmp -j REJECT</span><br><span class="line">iptables -I INPUT -p icmp -m limit --limit 10/minute -j ACCEPT</span><br><span class="line">#udp --dport --sport 离散端口可以借助multiport</span><br><span class="line">iptables -I OUTPUT -d 119.29.29.29 -p udp --dport 53 -j ACCEPT</span><br><span class="line">iptables -I OUTPUT -d 119.29.29.29 -p udp -m multiport --dport 53,54 -j ACCEPT</span><br><span class="line">#icmp 发出ping请求属于类型8的icmp报文 对方ping回应报文属于类型0的icmp报文</span><br><span class="line">iptables -I INPUT -p icmp -j REJECT</span><br><span class="line">#服务器内可以ping其他服务器但禁ping</span><br><span class="line">iptables -I INPUT -p icmp --icmp-type 8 -j REJECT</span><br><span class="line">#同上</span><br><span class="line">iptables -I INPUT -p icmp --icmp-type &quot;echo-request&quot; -j REJECT</span><br><span class="line">#state NEW建立链接第一个包 ESTABLISHED链接已建立 RELATED关系(FTP)</span><br><span class="line">#INVALID包未被识别 UNTRACKED包未被追踪</span><br><span class="line">iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -I INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT</span><br><span class="line">#默认策略P</span><br><span class="line">iptables -P INPUT DROP</span><br></pre></td></tr></table></figure>

<h4 id="自定义链"><a href="#自定义链" class="headerlink" title="自定义链"></a>自定义链</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#-N 新建一个链</span><br><span class="line">iptables -N IN_WEB</span><br><span class="line">iptables -I INPUT -p tcp --dport 888 -j IN_WEB</span><br><span class="line">iptables -I IN_WEB -s 1.2.3.4 -j REJECT</span><br><span class="line">#-E 修改自定义链</span><br><span class="line">iptables -E IN_WEB WEB</span><br><span class="line">#-X 删除自定义链 自定义链没有被引用 自定义链为空(没有任何规则)</span><br><span class="line">iptables -X WEB</span><br></pre></td></tr></table></figure>

<h4 id="动作-扩展动作"><a href="#动作-扩展动作" class="headerlink" title="动作 扩展动作"></a>动作 扩展动作</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#基本动作</span><br><span class="line">ACCEPT DROP</span><br><span class="line">#扩展动作</span><br><span class="line">REJECT 选项--reject-with 提示信息</span><br><span class="line">icmp-net-unreachable</span><br><span class="line">icmp-host-unreachable</span><br><span class="line">icmp-port-unreachable #默认</span><br><span class="line">icmp-proto-unreachable</span><br><span class="line">icmp-net-prohibted</span><br><span class="line">icmp-host-prohibted</span><br><span class="line">icmp-admin-prohibted</span><br><span class="line">iptables -I INPUT -p icmp -j REJECT --reject-with icmp-host-unreachable</span><br><span class="line">#LOG 将相关信息记录日志中(/var/log/message)</span><br><span class="line">iptables -I INPUT -p icmp -j LOG</span><br><span class="line">#SNAT --to-source匹配报文源IP修改为192.168.8.8</span><br><span class="line">iptables -t nat -A POSTROUTING -s 1.1.1.0/16 -j SNAT --to-source 192.168.8.8</span><br><span class="line">#DNAT --to-destination匹配报文目标地址修改为1.1.0.1:22</span><br><span class="line">iptables -t nat -A PREROUTING -d 192.168.8.8 -p tcp --dport 22 -j DNAT --to-destination 1.1.0.1:22</span><br><span class="line">#MASQUERADE 动态获取IP</span><br><span class="line">iptables -t nat -A POSTROUTING -s 1.1.1.0/16 -o eth1 -j MASQUERADE</span><br><span class="line">#REDIRECT 将本机80端口映射到本机888端口</span><br><span class="line">iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 888</span><br></pre></td></tr></table></figure>

<h3 id="具体命令"><a href="#具体命令" class="headerlink" title="具体命令"></a>具体命令</h3><ul>
<li><p>查（–line-numbers 显示行号） <code>iptables -t 表(默认filter) -nvL --line-numbers</code></p>
</li>
<li><p>增 <code>iptables -I[A](insert append 插入 追加)</code> 示例： input链最后追加 （放行80端口） <code>iptables -A INPUT -p tcp --dport 80 -j ACCEPT</code> input链第2行插入 <code>iptables -I INPUT 2 -p tcp --dport 80 -j ACCEPT</code></p>
</li>
<li><p>改 <code>iptables -R INPUT 26 -p tcp --dport -j DROP</code></p>
</li>
<li><p>删 -D 链名 行号</p>
<p>-D INPUT -s 118.126.103.41 -j ACCEPT</p>
</li>
<li><p><code>iptables -D INPUT 1</code></p>
</li>
</ul>
<h3 id="详细命令"><a href="#详细命令" class="headerlink" title="详细命令"></a>详细命令</h3><ul>
<li><code>-P 设置默认策略 iptables -P INPUT (DROPACCEPT)</code></li>
<li><code>-F 清空规则链</code></li>
<li><code>-L 查看规则链</code></li>
<li><code>-A(append) 在规则链末尾追加规则</code></li>
<li><code>-I(insert) num 在规则链第几行插入规则</code></li>
<li><code>-D(delete) num 删除某一行的规则</code></li>
<li><code>-s 匹配来源IP/MASK 可以通过!取反</code></li>
<li><code>-d 匹配目标地址 与-s用法相同</code></li>
<li><code>-i 网卡名称(eth0) 匹配指定网卡流入的数据</code></li>
<li><code>-o 网卡名称(eth0) 匹配指定网卡流出的数据</code></li>
<li><code>-p 匹配协议(tcpudpicmp)</code></li>
<li><code>--dport num 匹配目标端口号</code></li>
<li><code>--sport num 匹配来源端口号</code></li>
<li><code>-j 动作(ACCEPTDROPREJECT)</code></li>
<li><code>-m 扩展参数(state --state ESTABLISHED,RELATED)</code></li>
</ul>
<h3 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h3><ul>
<li>注意放行本地回环网卡 否则本地调用127.0.0.1有异常 <code>iptables -A INPUT -i lo -j ACCEPT</code></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/05/27/%E4%BA%86%E8%A7%A3iptables-1/" data-id="clc4klg7m00a5ojob430d31dk" data-title="了解iptables" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-一键搭建mysql主从-0" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/17/%E4%B8%80%E9%94%AE%E6%90%AD%E5%BB%BAmysql%E4%B8%BB%E4%BB%8E-0/" class="article-date">
  <time class="dt-published" datetime="2020-05-17T07:57:07.000Z" itemprop="datePublished">2020-05-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/">集群架构</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/17/%E4%B8%80%E9%94%AE%E6%90%AD%E5%BB%BAmysql%E4%B8%BB%E4%BB%8E-0/">一键搭建MySql主从</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="已完成"><a href="#已完成" class="headerlink" title="已完成"></a>已完成</h4><hr>
<ul>
<li>一键安装mysql</li>
<li>一键安装ansible</li>
<li>一键配置主从</li>
<li>支持一主一从</li>
<li>支持一主多从</li>
</ul>
<h4 id="未完成"><a href="#未完成" class="headerlink" title="未完成"></a>未完成</h4><hr>
<p>集成控制系统</p>
<ul>
<li>显示主从状态</li>
<li>显示当前服务器负载情况</li>
<li>管理mysql数据库（赠删改查</li>
<li>在线编辑mysql配置文件</li>
</ul>
<h4 id="详细代码"><a href="#详细代码" class="headerlink" title="详细代码"></a>详细代码</h4><hr>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Author: Ropon</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Blog: https://www.ropon.top</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">借助ansible、expect</span></span><br><span class="line">downurl=&quot;http://panel.ropon.top/panel/lnmp/&quot;</span><br><span class="line">mysqlname=&quot;mysql-5.6.43-1.el7.x86_64.rpm&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">mysqlname=<span class="string">&quot;mysql-5.7.25-1.el7.x86_64.rpm&quot;</span></span></span><br><span class="line">ip=&quot;172.16.7.124&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">多个从服务器</span></span><br><span class="line">declare -A CserverLst</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">CserverLst=([s1]=<span class="string">&quot;172.16.7.125&quot;</span>)</span></span><br><span class="line">CserverLst=([s1]=&quot;172.16.7.125&quot; [s2]=&quot;172.16.7.126&quot;)</span><br><span class="line">cport=&quot;22&quot;</span><br><span class="line">cpasswd=&quot;ropon.top&quot;</span><br><span class="line">ansible_host=&quot;/etc/ansible/hosts&quot;</span><br><span class="line">mysqlpasswd=&quot;West.cn2020&quot;</span><br><span class="line">user=&quot;westdemo&quot;</span><br><span class="line">passwd=&quot;west.cn&quot;</span><br><span class="line">host=&quot;172.16.7.%&quot;</span><br><span class="line">tmpsshfile=&quot;/tmp/ssh.exp&quot;</span><br><span class="line">mysqlmasterfile=&quot;/tmp/master.info&quot;</span><br><span class="line">cmysqllibfile=&quot;/tmp/cmysqllib.sh&quot;</span><br><span class="line">cmysqlslavefile=&quot;/tmp/slave.sh&quot;</span><br><span class="line"></span><br><span class="line">MySql() &#123;</span><br><span class="line">    yum install -y ncurses ncurses-devel libaio numactl numactl-libs perl-Module-Install</span><br><span class="line">    if [ $? -eq 0 ]; then </span><br><span class="line">        wget $&#123;downurl&#125;$&#123;mysqlname&#125;</span><br><span class="line">        rpm -ivh $mysqlname</span><br><span class="line">        sleep 1</span><br><span class="line">        . /etc/profile</span><br><span class="line">        mysql -uroot -p$mysqlpasswd -e &quot;grant replication slave on *.* to &#x27;$&#123;user&#125;&#x27;@&#x27;$&#123;host&#125;&#x27; identified by &#x27;$&#123;passwd&#125;&#x27;;&quot;</span><br><span class="line">        mysql -uroot -p$mysqlpasswd -e &quot;flush privileges;&quot;</span><br><span class="line">        mysql -uroot -p$mysqlpasswd -e &quot;show master status;&quot; &gt; $mysqlmasterfile</span><br><span class="line">        CFirwall</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Ansible() &#123;</span><br><span class="line">    if [[ -f /etc/yum.repos.d/epel*.repo ]]; then</span><br><span class="line">        mv /etc/yum.repos.d/epel*.repo&#123;,_bak&#125;</span><br><span class="line">    fi</span><br><span class="line">    wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">    yum install -y ansible</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Ssh() &#123;</span><br><span class="line">    yum install -y expect</span><br><span class="line">    echo &#x27;#!/usr/bin/expect</span><br><span class="line">spawn ssh-keygen</span><br><span class="line">expect &#123;</span><br><span class="line">    &quot;*.ssh/id_rsa*&quot; &#123;exp_send &quot;\r&quot;;exp_continue&#125;</span><br><span class="line">    &quot;*passphrase*&quot;  &#123;exp_send &quot;\r&quot;;exp_continue&#125;</span><br><span class="line">    &quot;*again*&quot;       &#123;exp_send &quot;\r&quot;&#125;</span><br><span class="line">&#125;&#x27; &gt; $tmpsshfile</span><br><span class="line">    expect $tmpsshfile</span><br><span class="line">    sleep 1</span><br><span class="line">    echo &quot;[db]&quot; &gt;&gt; $ansible_host</span><br><span class="line"></span><br><span class="line">    for key in $&#123;!CserverLst[*]&#125;; do</span><br><span class="line">        cat &gt; $tmpsshfile &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/expect</span></span><br><span class="line">spawn ssh-copy-id $&#123;CserverLst[$key]&#125; -p $&#123;cport&#125;</span><br><span class="line">expect &#123;</span><br><span class="line">    &quot;*yes/no*&quot;   &#123;exp_send &quot;yes\r&quot;;exp_continue&#125;</span><br><span class="line">    &quot;*password*&quot; &#123;exp_send &quot;$&#123;cpasswd&#125;\r&quot;;exp_continue&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">        expect $tmpsshfile</span><br><span class="line">        echo &quot;$&#123;CserverLst[$key]&#125; ansible_ssh_port=$&#123;cport&#125;&quot; &gt;&gt; $ansible_host</span><br><span class="line">    done</span><br><span class="line">    ansible db -m ping</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CMySql() &#123;</span><br><span class="line">    cat &gt; $cmysqllibfile &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">yum install -y ncurses ncurses-devel libaio numactl numactl-libs perl-Module-Install</span><br><span class="line">if [ $? -eq 0 ]; then </span><br><span class="line">        wget $downurl$&#123;mysqlname&#125;</span><br><span class="line">        rpm -ivh $mysqlname</span><br><span class="line">        sleep 1</span><br><span class="line">        sed -i &quot;s@server-id.*@server-id = 2@g&quot; /etc/my.cnf</span><br><span class="line">        sed -i &quot;s@log_bin.*@#log_bin = mysql-bin@g&quot; /etc/my.cnf</span><br><span class="line">        service mysqld restart</span><br><span class="line">    fi</span><br><span class="line">EOF</span><br><span class="line">    ansible db -m script -a &quot;$&#123;cmysqllibfile&#125;&quot;</span><br><span class="line">    sleep 1</span><br><span class="line">    mysql_bin_name=$(cat $mysqlmasterfile awk  &#x27;&#123;if (NR&gt;1)&#123;print $1&#125;&#125;&#x27;)</span><br><span class="line">    mysql_bin_offset=$(cat $mysqlmasterfile awk  &#x27;&#123;if (NR&gt;1)&#123;print $2&#125;&#125;&#x27;)</span><br><span class="line">    cat &gt; $cmysqlslavefile &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">/usr/local/mysql/bin/mysql -uroot -p$&#123;mysqlpasswd&#125; -e &quot;change master to master_host=&#x27;$&#123;ip&#125;&#x27;,master_user=&#x27;$&#123;user&#125;&#x27;,master_port=3306,master_password=&#x27;$&#123;passwd&#125;&#x27;,master_log_file=&#x27;$&#123;mysql_bin_name&#125;&#x27;,master_log_pos=$&#123;mysql_bin_offset&#125;;&quot;</span><br><span class="line">/usr/local/mysql/bin/mysql -uroot -p$&#123;mysqlpasswd&#125; -e &quot;start slave;&quot;</span><br><span class="line">/usr/local/mysql/bin/mysql -uroot -p$&#123;mysqlpasswd&#125; -e &quot;show slave status\G;&quot;</span><br><span class="line">service mysqld restart</span><br><span class="line">EOF</span><br><span class="line">    ansible db -m script -a &quot;$&#123;cmysqlslavefile&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CFirwall() &#123;</span><br><span class="line">    iptables -L -n grep -w dpt:$cport &gt;/dev/null</span><br><span class="line">    if  [ $? -eq 0 ] ;then</span><br><span class="line">        iptables -L -n grep -w dpt:3306 &gt;/dev/null</span><br><span class="line">        if  [ $? -ne 0 ] ;then</span><br><span class="line">            sed -i &quot;/dport $&#123;cport&#125; -j ACCEPT/a\-A INPUT -p tcp -m tcp --dport 3306 -j ACCEPT&quot; /etc/sysconfig/iptables</span><br><span class="line">            service iptables restart</span><br><span class="line"></span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Clean() &#123;</span><br><span class="line">    rm -rf $tmpsshfile</span><br><span class="line">    rm -rf $mysqlmasterfile</span><br><span class="line">    rm -rf $cmysqllibfile</span><br><span class="line">    rm -rf $cmysqlslavefile</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Main() &#123;</span><br><span class="line">    MySql</span><br><span class="line">    Ansible</span><br><span class="line">    Ssh</span><br><span class="line">    CMySql</span><br><span class="line">    Clean</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Main</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/05/17/%E4%B8%80%E9%94%AE%E6%90%AD%E5%BB%BAmysql%E4%B8%BB%E4%BB%8E-0/" data-id="clc4klg7k00a1ojob225u4v1b" data-title="一键搭建MySql主从" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-markdown基本使用-0" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/05/markdown%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-0/" class="article-date">
  <time class="dt-published" datetime="2020-04-05T06:31:33.000Z" itemprop="datePublished">2020-04-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/">经验分享</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/05/markdown%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-0/">MarkDown基本使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一级标题"><a href="#一级标题" class="headerlink" title="一级标题"></a>一级标题</h1><h2 id="二级标题"><a href="#二级标题" class="headerlink" title="二级标题"></a>二级标题</h2><h3 id="三级标题"><a href="#三级标题" class="headerlink" title="三级标题"></a>三级标题</h3><h4 id="四级标题"><a href="#四级标题" class="headerlink" title="四级标题"></a>四级标题</h4><h5 id="五级标题"><a href="#五级标题" class="headerlink" title="五级标题"></a>五级标题</h5><h6 id="六级标题"><a href="#六级标题" class="headerlink" title="六级标题"></a>六级标题</h6><p><em>斜体</em> <strong>加粗</strong> <strong><em>加粗斜体</em></strong> 删除线</p>
<ul>
<li>一二三四五</li>
<li><ul>
<li>上单打老虎</li>
</ul>
</li>
<li><ul>
<li>老虎没打到</li>
</ul>
</li>
<li><ul>
<li>打到小松鼠</li>
</ul>
</li>
</ul>
<p>1.一二三四五 2.上单打老虎 3.老虎没打到</p>
<p>列1</p>
<p>列2</p>
<p>列3</p>
<p>行1</p>
<p>行2</p>
<p>行3</p>
<blockquote>
<p>一二三四五</p>
<blockquote>
<p>七八九十</p>
</blockquote>
</blockquote>
<h2 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &quot;test&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>复选1</li>
<li>复选1</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/04/05/markdown%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-0/" data-id="clc4klg61005qojobbjka9vbr" data-title="MarkDown基本使用" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-flex布局-0" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/03/02/flex%E5%B8%83%E5%B1%80-0/" class="article-date">
  <time class="dt-published" datetime="2020-03-02T07:47:52.000Z" itemprop="datePublished">2020-03-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web%E5%89%8D%E7%AB%AF/">Web前端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/03/02/flex%E5%B8%83%E5%B1%80-0/">Flex布局</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">.box1 &#123;</span><br><span class="line">display: flex;</span><br><span class="line">/* </span><br><span class="line">开启flex布局 flex-container</span><br><span class="line">主轴 main axis</span><br><span class="line">交叉轴 cross axis</span><br><span class="line">*/</span><br><span class="line">/* flex-direction: column-reverse; */</span><br><span class="line">/* </span><br><span class="line">flex-direction 决定主轴的方向 默认值row 从左到右</span><br><span class="line">row-reverse 从右到左</span><br><span class="line">column 列 从上往下</span><br><span class="line">column-reverse 列 从下往上</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/* justify-content:space-around; */</span><br><span class="line">/*</span><br><span class="line">justify-content 决定flex items 在主轴对齐方式</span><br><span class="line">默认对齐方式 flex-start 与main start 对齐</span><br><span class="line">flex-end 与main end 对齐</span><br><span class="line">center 居中对齐</span><br><span class="line">space-between flex items 之间等距离 与main start main end 两端对齐</span><br><span class="line">space-evenly flex items 之间等距离 flex items main start main end 等距离</span><br><span class="line">space-around flex items 之间等距离 flex items main start main end 距离是flex items 之间距离一半</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/* align-items: baseline; */</span><br><span class="line">/*</span><br><span class="line">justify-content 决定flex items 在交叉轴对齐方式</span><br><span class="line">默认值 normal 弹性布局与stretch 一样</span><br><span class="line">stretch flex items 在cross axis 方向的 size 为auto时 自动拉伸填充flex container</span><br><span class="line">flex-start 与cross start 对齐</span><br><span class="line">flex-end 与cross end 对齐</span><br><span class="line">center 居中对齐</span><br><span class="line">baseline 基线对齐</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/* flex-wrap: wrap-reverse; */</span><br><span class="line">/*</span><br><span class="line">默认所有flex items 都会在一行显示</span><br><span class="line">flex-wrap 决定flex container 是单行还是多行</span><br><span class="line">默认值nowrap 单行</span><br><span class="line">wrap 多行</span><br><span class="line">wrap-reverse 多行 对比wrap cross sart与cross end 相反</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/* flex-flow: row wrap; */</span><br><span class="line">/*</span><br><span class="line">flex-flow 缩写属性 -&gt; flex-direction flex-wrap</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/* align-content: space-evenly; */</span><br><span class="line">/*</span><br><span class="line">align-content 决定多行 flex items 在交叉轴 对齐方式</span><br><span class="line">默认值 stretch 拉伸</span><br><span class="line">flex-start</span><br><span class="line">flex-end</span><br><span class="line">center 居中对齐</span><br><span class="line">space-between flex items 之间等距离 cross start cross end 两端对齐</span><br><span class="line">space-evenly flex items 之间等距离 flex items cross start cross end 等距离</span><br><span class="line">space-around flex items 之间等距离 flex items cross start cross end 距离是flex items 之间距离一半</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">总结：</span><br><span class="line">flex-container</span><br><span class="line">display flex/inline-flex 开启flex布局</span><br><span class="line">flex-driection 决定主轴的方向</span><br><span class="line">justify-content 决定主轴上flex-items对齐方式</span><br><span class="line">align-items 决定在交叉轴flex-items对齐方式</span><br><span class="line">flex-wrap 是否换行显示</span><br><span class="line">flex-flow flex-driection flex-wrap 缩写</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">flex-items</span><br><span class="line">order 决定flex items 排布顺序 越小排在前面</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">width: 500px;</span><br><span class="line">height: 400px;</span><br><span class="line">margin: 0 auto;</span><br><span class="line">background-color: #ff00ff;</span><br><span class="line">&#125;</span><br><span class="line">.item &#123;</span><br><span class="line">width: 100px;</span><br><span class="line">height: 100px;</span><br><span class="line">color:#fff;</span><br><span class="line">text-align: center;</span><br><span class="line">line-height: 100px;</span><br><span class="line">&#125;</span><br><span class="line">.item1 &#123;</span><br><span class="line">background-color:red;</span><br><span class="line">/* height: 60px; */</span><br><span class="line">&#125;</span><br><span class="line">.item2 &#123;</span><br><span class="line">background-color:green;</span><br><span class="line">/* height: 120px; */</span><br><span class="line">&#125;</span><br><span class="line">.item3 &#123;</span><br><span class="line">background-color:blue;</span><br><span class="line">/* height: 150px; */</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;title&gt;Flex布局&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div class=&quot;box1&quot;&gt;</span><br><span class="line">&lt;div class=&quot;item item1&quot;&gt;item1&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;item item2&quot;&gt;item2&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;item item3&quot;&gt;item3&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;strong&gt;测试元素&lt;/strong&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/03/02/flex%E5%B8%83%E5%B1%80-0/" data-id="clc4klg570034ojob4ojwe0p8" data-title="Flex布局" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-shell-条件测试-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/20/shell-%E6%9D%A1%E4%BB%B6%E6%B5%8B%E8%AF%95-1/" class="article-date">
  <time class="dt-published" datetime="2020-01-20T09:38:17.000Z" itemprop="datePublished">2020-01-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/yunwei-tools/">yunwei-tools</a>►<a class="article-category-link" href="/categories/yunwei-tools/Shell/">Shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/20/shell-%E6%9D%A1%E4%BB%B6%E6%B5%8B%E8%AF%95-1/">shell 条件测试</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># 条件测试</span><br><span class="line"># test &lt;测试表达式&gt;</span><br><span class="line"># [ &lt;测试表达式&gt; ] 一般使用 -a 且 -o 或 -gt 大于 -lt 小于 整数</span><br><span class="line"># [[ &lt;测试表达式&gt; ]] 可以使用通配符进行模式匹配 &amp;&amp;  &gt; &lt; </span><br><span class="line"># (( &lt;测试表达式&gt; )) 可以使用通配符进行模式匹配</span><br><span class="line"></span><br><span class="line"># test语法</span><br><span class="line">test -f /root/666.sh &amp;&amp; echo true  echo false # 存在/root/666.sh文件返回true 反之false</span><br><span class="line">test -f /root/222.sh  touch 222.sh # 文件不存在就创建</span><br><span class="line">test -z &quot;teststring&quot; &amp;&amp; echo true  echo false #如果s字符串长度为0 成立返回true 反之false</span><br><span class="line"></span><br><span class="line"># [ x ]语法</span><br><span class="line">[ -f /root/666.sh ] &amp;&amp; echo true  echo false # 存在/root/666.sh文件且是普通文件返回true 反之false</span><br><span class="line"></span><br><span class="line"># 常用文件测试操作符</span><br><span class="line"># -d directory 存在且是目录返回true 反之false</span><br><span class="line"># -f file 存在且是普通文件返回true 反之false</span><br><span class="line"># -e exist 存在返回true 反之false</span><br><span class="line"># -s size 存在且文件大小不为0返回true 反之false</span><br><span class="line"># -r read 存在且可读返回true 反之false</span><br><span class="line"># -w write 存在且可写返回true 反之false</span><br><span class="line"># -x executable 存在且可执行返回true 反之false</span><br><span class="line"># -L link 存在且链接文件返回true 反之false</span><br><span class="line"># f1 -nt f2 newer than 文件f1比文件f2新返回true 反之false</span><br><span class="line"># f1 -ot f2 older than 文件f1比文件f2旧返回true 反之false</span><br><span class="line"></span><br><span class="line"># 字符串测试操作符</span><br><span class="line"># -n no zero &quot;字符串&quot; 字符串长度不为0返回true 反之false</span><br><span class="line"># -z zero &quot;字符串&quot; 字符串长度为0返回true 反之false</span><br><span class="line"># &quot;字符串1&quot; == &quot;字符串2&quot; 相等返回true 反之false</span><br><span class="line"># &quot;字符串1&quot; != &quot;字符串2&quot; 不相等返回true 反之false</span><br><span class="line"></span><br><span class="line"># 整数比较操作符</span><br><span class="line"># [] test           (()) [[]]   </span><br><span class="line"># -eq               ==或=        相等 equal</span><br><span class="line"># -ne               !=          不相等 not equal       </span><br><span class="line"># -gt               &gt;            大于 greater than     </span><br><span class="line"># -ge               &gt;=           大于等于 greater equal      </span><br><span class="line"># -lt               &lt;            小于 less than        </span><br><span class="line"># -le               &lt;=           小于等于 less equal     </span><br><span class="line"></span><br><span class="line"># 逻辑操作符</span><br><span class="line"># [] test           (()) [[]]   </span><br><span class="line"># -a                &amp;&amp;          与且 and</span><br><span class="line"># -o                          或 or</span><br><span class="line"># !                 !           非 not</span><br><span class="line"></span><br><span class="line">echo 1.apache</span><br><span class="line">echo 2.nginx</span><br><span class="line">echo 3.tomcat</span><br><span class="line">read -p &quot;please select op: &quot; op</span><br><span class="line">[ &quot;$op&quot; == &quot;1&quot; ] &amp;&amp; &#123;</span><br><span class="line">    echo &quot;select apache&quot;</span><br><span class="line">    exit 0</span><br><span class="line">&#125;</span><br><span class="line">[ &quot;$op&quot; == &quot;2&quot; ] &amp;&amp; &#123;</span><br><span class="line">    echo &quot;select nginx&quot;</span><br><span class="line">    exit 0</span><br><span class="line">&#125;</span><br><span class="line">[ &quot;$op&quot; == &quot;3&quot; ] &amp;&amp; &#123;</span><br><span class="line">    echo &quot;select tomcat&quot;</span><br><span class="line">    exit 0</span><br><span class="line">&#125;</span><br><span class="line">[[ ! &quot;$op&quot; =~ [1-3] ]] &amp;&amp;&#123;</span><br><span class="line">    echo &quot;select error only input 123&quot;</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 总结</span><br><span class="line">#               []                  test                [[]]                (())</span><br><span class="line"># 加空格        y                   y                   y                   n</span><br><span class="line"># 操作符        -a -o !             同[]                 &amp;&amp;  !             同[[]]</span><br><span class="line"># 整数比较符  -gt -lt -ge -le -eq 同[]                 -gt -lt -ge -le -eq</span><br><span class="line">                                                    #   &gt; &lt; &gt;= &lt;= =         同[[]]</span><br><span class="line"># 字符串比较符     = == !=             同[]                  同[]                 同[]</span><br><span class="line"># 是否支持统配符  n                     同[]                   y                  同[]</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.ropon.top/2020/01/20/shell-%E6%9D%A1%E4%BB%B6%E6%B5%8B%E8%AF%95-1/" data-id="clc4klg6y008mojob42ntdm6t" data-title="shell 条件测试" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/7/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/9/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Django/">Django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flask/">Flask</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue/">Vue</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%89%8D%E7%AB%AF/">Web前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/">cloud</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/Kubernetes/">Kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/Kvm/">Kvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cloud/OpenStack/">OpenStack</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/monitoring-tools/">monitoring-tools</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/monitoring-tools/Prometheus/">Prometheus</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/uncategorized/">uncategorized</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-jiqun/">web-jiqun</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web-jiqun/%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4/">分布式集群</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-jiqun/%E7%BD%91%E7%AB%99%E9%9B%86%E7%BE%A4/">网站集群</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/">yunwei-tools</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/Cmd/">Cmd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/yunwei-tools/Shell/">Shell</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/">经验分享</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/">集群架构</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/auto/" rel="tag">auto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/" rel="tag">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/" rel="tag">ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wdcp/" rel="tag">wdcp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91/" rel="tag">云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="tag">虚拟化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/auto/" style="font-size: 10px;">auto</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/kvm/" style="font-size: 10px;">kvm</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/tags/vue/" style="font-size: 20px;">vue</a> <a href="/tags/wdcp/" style="font-size: 10px;">wdcp</a> <a href="/tags/%E4%BA%91/" style="font-size: 10px;">云</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 10px;">虚拟化</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E5%88%87%E7%89%87/">Go语言中切片</a>
          </li>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%ADmap/">Go语言中map</a>
          </li>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E5%87%BD%E6%95%B0/">Go语言中函数</a>
          </li>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%BB%93%E6%9E%84%E4%BD%93/">Go语言中结构体</a>
          </li>
        
          <li>
            <a href="/2022/12/26/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E5%8C%85/">Go语言中包</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 Ropon<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>